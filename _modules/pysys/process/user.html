

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysys.process.user &mdash; PySys v2.0  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> PySys v2.0
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/BaseTest.html">The BaseTest Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/UserGuide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/ProjectConfiguration.html">Project Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/TestDescriptors.html">Test Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodocgen/pysys.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ChangeLog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySys v2.0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../process.html">pysys.process</a> &raquo;</li>
        
      <li>pysys.process.user</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysys.process.user</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># PySys System Test Framework, Copyright (C) 2006-2021 M.B. Grieve</span>

<span class="c1"># This library is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU Lesser General Public</span>
<span class="c1"># License as published by the Free Software Foundation; either</span>
<span class="c1"># version 2.1 of the License, or (at your option) any later version.</span>

<span class="c1"># This library is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1"># Lesser General Public License for more details.</span>

<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with this library; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains `pysys.process.user.ProcessUser` which supports using processes from PySys, and provides the </span>
<span class="sd">shared functionality of subclasses `pysys.basetest.BaseTest` and `pysys.baserunner.BaseRunner`. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">collections</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">locale</span><span class="o">,</span> <span class="nn">fnmatch</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="kn">from</span> <span class="nn">pysys</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">process_lock</span>
<span class="kn">from</span> <span class="nn">pysys.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.utils.filegrep</span> <span class="kn">import</span> <span class="n">getmatches</span>
<span class="kn">from</span> <span class="nn">pysys.utils.logutils</span> <span class="kn">import</span> <span class="n">BaseLogFormatter</span><span class="p">,</span> <span class="n">stripANSIEscapeCodes</span>
<span class="kn">from</span> <span class="nn">pysys.config.project</span> <span class="kn">import</span> <span class="n">Project</span>
<span class="kn">from</span> <span class="nn">pysys.process.helper</span> <span class="kn">import</span> <span class="n">ProcessImpl</span>
<span class="kn">from</span> <span class="nn">pysys.utils.allocport</span> <span class="kn">import</span> <span class="n">TCPPortOwner</span>
<span class="kn">from</span> <span class="nn">pysys.utils.fileutils</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">deletedir</span><span class="p">,</span> <span class="n">deletefile</span><span class="p">,</span> <span class="n">pathexists</span><span class="p">,</span> <span class="n">toLongPathSafe</span><span class="p">,</span> <span class="n">fromLongPathSafe</span>
<span class="kn">from</span> <span class="nn">pysys.utils.pycompat</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pysys.utils.safeeval</span>
<span class="kn">from</span> <span class="nn">pysys.mappers</span> <span class="kn">import</span> <span class="n">applyMappers</span>

<span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">win32api</span><span class="o">,</span> <span class="nn">win32con</span>
<span class="k">else</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">fcntl</span>

<div class="viewcode-block" id="STDOUTERR_TUPLE"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.STDOUTERR_TUPLE">[docs]</a><span class="k">class</span> <span class="nc">STDOUTERR_TUPLE</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;stdouterr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">])):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Returned by `ProcessUser.allocateUniqueStdOutErr` to hold a pair of ``(stdout,stderr)`` names.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span> <span class="c1"># to save memory as per the python docs</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the key (the prefix without the ``.out`` or ``.err``), to which you can append your </span>
<span class="sd">		own extension. For example to create a log file with the same base name as the stdout/err files::</span>
<span class="sd">		</span>
<span class="sd">			self.startProcess(..., arguments=[&#39;--logfile&#39;, stdouterr.key+&#39;.log&#39;], ...)</span>
<span class="sd">		</span>
<span class="sd">		.. versionadded: 1.6.1</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.out&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span></div>


<div class="viewcode-block" id="ProcessUser"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser">[docs]</a><span class="k">class</span> <span class="nc">ProcessUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	ProcessUser provides support for safely using processes in PySys, including starting processes (with an </span>
<span class="sd">	appropriate output directory), waiting for them to do what they&#39;re supposed to do, and finally ensuring all </span>
<span class="sd">	processes and ports are cleaned up when each test (or the overall runner) terminates. </span>
<span class="sd">	</span>
<span class="sd">	As the common base class of both `pysys.basetest.BaseTest` and `pysys.baserunner.BaseRunner`, ProcessUser also </span>
<span class="sd">	holds shared functionality such as dynamic port allocation, copying files, creating directories etc, and </span>
<span class="sd">	keeps track of the &quot;outcome&quot; generated by some methods (although the outcome value is only used when </span>
<span class="sd">	it is subclassed by BaseTest). </span>

<span class="sd">	Each ProcessUser instance is responsible for managing the lifetime of the processes started using its </span>
<span class="sd">	`startProcess` method, and ensuring they are all terminated when the `cleanup` method is invoked. Additional </span>
<span class="sd">	functions to be executed during cleanup can be registered using `addCleanupFunction`, for example to delete large </span>
<span class="sd">	output directories, or terminate non-process resources such as docker containers or remote servers.</span>
<span class="sd">	</span>
<span class="sd">	Apart from the `addOutcome` method this class is not thread-safe, so if </span>
<span class="sd">	you need to access it from multiple threads be sure to add your own locking </span>
<span class="sd">	around use of its fields and methods, including any cleanup functions. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.input: Full path to the directory containing input files (e.g. ``testdir/Input``)</span>
<span class="sd">	:ivar str ~.output: Full path to the directory that output files should be written to (e.g. ``testdir/Output/&lt;platformname&gt;``)</span>
<span class="sd">	:ivar logging.Logger ~.log: The Python ``Logger`` instance that should be used to record progress and status information. </span>
<span class="sd">	:ivar pysys.config.project.Project ~.project: A reference to the singleton project instance containing the </span>
<span class="sd">		configuration of this PySys test project as defined by ``pysysproject.xml``. </span>
<span class="sd">		The project can be used to access information such as the project properties which are shared across all tests </span>
<span class="sd">		(e.g. for hosts and credentials). </span>
<span class="sd">	:ivar bool ~.disableCoverage: Set to True to disable all code coverage collection for processes </span>
<span class="sd">		started from this instance. This is automatically set for any tests marked with the &quot;disableCoverage&quot; group </span>
<span class="sd">		in their ``pysystest.*`` file. </span>
<span class="sd">			</span>
<span class="sd">		The built-in Python code coverage functionality in L{startPython} checks this </span>
<span class="sd">		flag. It is recommended that any other languages supporting code coverage </span>
<span class="sd">		also check the self.disableCoverage flag. </span>
<span class="sd">	</span>
<span class="sd">	Additional variables that affect only the behaviour of a single method are documented in the associated method. </span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
		<span class="sd">&quot;&quot;&quot;The logger instance that should be used to log from this class. &quot;&quot;&quot;</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span>
		<span class="sd">&quot;&quot;&quot;The L{pysys.config.project.Project} instance containing settings for this PySys project.&quot;&quot;&quot;</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">assert</span> <span class="s1">&#39;doctest&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Project was not loaded yet&#39;</span> <span class="c1"># allow it only during doctest-ing</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;defaultAbortOnError&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">defaultIgnoreExitStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;defaultIgnoreExitStatus&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">testRootDir</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># must be set by subclass</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">processList</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">processCount</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__cleanupFunctions</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (fn, ignoreErrors)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">outcome</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># internal, do NOT use directly</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeLocation</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

		
		<span class="bp">self</span><span class="o">.</span><span class="n">__uniqueProcessKeys</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__pythonCoverageFile</span> <span class="o">=</span> <span class="mi">0</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">disableCoverage</span> <span class="o">=</span> <span class="kc">False</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A recursive lock that can be used for protecting the fields of this instance </span>
<span class="sd">		from access by background threads, as needed. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		
		<span class="c1"># variables affecting a specific method (documented there rather than above)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logFileContentsDefaultExcludes</span> <span class="o">=</span> <span class="p">[]</span>
		
<div class="viewcode-block" id="ProcessUser.allocateUniqueStdOutErr"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.allocateUniqueStdOutErr">[docs]</a>	<span class="k">def</span> <span class="nf">allocateUniqueStdOutErr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processKey</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Allocate unique filenames of the form ``processKey[.n].out/.err`` </span>
<span class="sd">		which can be used for the `startProcess` ``stdouterr`` parameter. </span>
<span class="sd">		</span>
<span class="sd">		The first time this is called it will return names like </span>
<span class="sd">		``(&#39;myprocess.out&#39;, &#39;myprocess.err&#39;)``, the second time it will return </span>
<span class="sd">		``(&#39;myprocess.1.out&#39;, &#39;myprocess.1.err&#39;)``, then </span>
<span class="sd">		``(&#39;myprocess.2.out&#39;, &#39;myprocess.2.err&#39;)`` etc. </span>
<span class="sd">		</span>
<span class="sd">		:param str processKey: A user-defined identifier that will form the prefix onto which ``[.n].out`` is appended</span>
<span class="sd">		:return: A STDOUTERR_TUPLE named tuple of (stdout, stderr)</span>
<span class="sd">		:rtype: STDOUTERR_TUPLE</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">newval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uniqueProcessKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">processKey</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__uniqueProcessKeys</span><span class="p">[</span><span class="n">processKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
		
		<span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">newval</span><span class="p">)</span> <span class="k">if</span> <span class="n">newval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
		
		<span class="k">return</span> <span class="n">STDOUTERR_TUPLE</span><span class="p">(</span>
			<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">processKey</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span><span class="p">),</span> 
			<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">processKey</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;.err&#39;</span><span class="p">),</span> 
			<span class="p">)</span>	</div>

<div class="viewcode-block" id="ProcessUser.getInstanceCount"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getInstanceCount">[docs]</a>	<span class="k">def</span> <span class="nf">getInstanceCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;(Deprecated) Return the number of processes started within the testcase matching the supplied displayName.</span>

<span class="sd">		:deprecated: The recommended way to allocate unique names is now L{allocateUniqueStdOutErr}</span>

<span class="sd">		The ProcessUser class maintains a reference count of processes started within the class instance </span>
<span class="sd">		via the L{startProcess()} method. The reference count is maintained against a logical name for </span>
<span class="sd">		the process, which is the C{displayName} used in the method call to L{startProcess()}, or the </span>
<span class="sd">		basename of the command if no displayName was supplied. The method returns the number of </span>
<span class="sd">		processes started with the supplied logical name, or 0 if no processes have been started. </span>

<span class="sd">		:param displayName: The process display name</span>
<span class="sd">		:return: The number of processes started matching the command basename</span>
<span class="sd">		:rtype:  int</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">displayName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">[</span><span class="n">displayName</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="mi">0</span></div>
		
	<span class="k">def</span> <span class="nf">setKeywordArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Set the xargs as data attributes of the class. For internal use by BaseTest/BaseRunner only. </span>
<span class="sd">	</span>
<span class="sd">		:meta private:</span>
<span class="sd">				</span>
<span class="sd">		Values in the xargs dictionary are set as data attributes using the builtin C{setattr} method. </span>
<span class="sd">		Thus an xargs dictionary of the form C{{&#39;foo&#39;: &#39;bar&#39;}} will result in a data attribute of the </span>
<span class="sd">		form C{self.foo} with C{value bar}. This is used so that subclasses can define default values of </span>
<span class="sd">		data attributes, which can be overriden on instantiation e.g. using the -X options to the </span>
<span class="sd">		runTest.py launch executable.</span>
<span class="sd">		</span>
<span class="sd">		If an existing attribute is present on this test class (typically a </span>
<span class="sd">		static class variable) and it has a type of bool, int or float, then </span>
<span class="sd">		any -X options will be automatically converted from string to that type. </span>
<span class="sd">		This facilitates providing default values for parameters such as </span>
<span class="sd">		iteration count or timeouts as static class variables with the </span>
<span class="sd">		possibility of overriding on the command line, for example `-Xiterations=123`. </span>
<span class="sd">		</span>
<span class="sd">		:param xargs: A dictionary of the user defined extra arguments</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xargs</span><span class="p">)</span>
	
<div class="viewcode-block" id="ProcessUser.getBoolProperty"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getBoolProperty">[docs]</a>	<span class="k">def</span> <span class="nf">getBoolProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a True/False indicating whether the specified attribute is set </span>
<span class="sd">		on this object (typically as a result of specifying -X on the command </span>
<span class="sd">		line), or else from the project configuration. </span>
<span class="sd">		</span>
<span class="sd">		See also `pysys.baserunner.getXArg()` and `pysys.config.project.Project.getProperty()`. </span>
<span class="sd">		</span>
<span class="sd">		:param propertyName: The name of a property set on the command line </span>
<span class="sd">			or project configuration.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">default</span>
		<span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">val</span>
		<span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span></div>

<div class="viewcode-block" id="ProcessUser.startPython"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.startPython">[docs]</a>	<span class="k">def</span> <span class="nf">startPython</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">disableCoverage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Start a Python process with the specified arguments. </span>
<span class="sd">		</span>
<span class="sd">		Uses the same Python process the tests are running under. </span>
<span class="sd">		</span>
<span class="sd">		If PySys was run with the argument ``-XcodeCoverage`` or ``-XpythonCoverage`` then </span>
<span class="sd">		`startPython` will add the necessary arguments to enable generation of </span>
<span class="sd">		code coverage. Note that this requried the coverage.py library to be </span>
<span class="sd">		installed. If a project property called `pythonCoverageArgs` exists </span>
<span class="sd">		then its value will be added as (space-delimited) arguments to the </span>
<span class="sd">		coverage tool. </span>
<span class="sd">		</span>
<span class="sd">		:param arguments: The arguments to pass to the Python executable. </span>
<span class="sd">			Typically the first one be either the name of a Python script </span>
<span class="sd">			to execute, or ``-m`` followed by a module name. </span>
<span class="sd">		:param kwargs: See L{startProcess} for detail on available arguments.</span>
<span class="sd">		:param disableCoverage: Disables code coverage for this specific </span>
<span class="sd">			process. Coverage can also be disabled by setting </span>
<span class="sd">			``self.disableCoverage==True`` on this test instance. </span>
<span class="sd">		:return: The process handle of the process.</span>
<span class="sd">		:rtype: pysys.process.Process</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">args</span> <span class="o">=</span> <span class="n">arguments</span>
		<span class="k">if</span> <span class="s1">&#39;environs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
			<span class="n">environs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environs&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">environs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;environs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultEnvirons</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">))</span>
			
		<span class="n">coverageWriter</span> <span class="o">=</span> <span class="p">[</span><span class="n">writer</span> <span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;runner&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">writers</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">PythonCoverageWriter</span><span class="p">)]</span>
		<span class="k">if</span> <span class="n">coverageWriter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">disableCoverage</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disableCoverage</span><span class="p">:</span>
			<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">coverageWriter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getCoverageArgsList</span><span class="p">()</span><span class="o">+</span><span class="n">args</span>
			<span class="k">if</span> <span class="s1">&#39;COVERAGE_FILE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environs</span><span class="p">:</span>
				<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">environs</span><span class="p">)</span>
				<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">__pythonCoverageFile</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environs&#39;</span><span class="p">][</span><span class="s1">&#39;COVERAGE_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">+</span><span class="s1">&#39;/.coverage.python.</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pythonCoverageFile</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">startProcess</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.startProcess"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.startProcess">[docs]</a>	<span class="k">def</span> <span class="nf">startProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">environs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workingDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForProcess&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">displayName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expectedExitStatus</span><span class="o">=</span><span class="s1">&#39;==0&#39;</span><span class="p">,</span> <span class="n">ignoreExitStatus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">onError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stdouterr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="p">{},</span> <span class="n">processFactory</span><span class="o">=</span><span class="n">pysys</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">ProcessImpl</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Start a process running in the foreground or background, and return </span>
<span class="sd">		the `pysys.process.Process` object.</span>
<span class="sd">		</span>
<span class="sd">		Typical use is::</span>
<span class="sd">		</span>
<span class="sd">			myexecutable = self.startProcess(&#39;path_to_my_executable&#39;, </span>
<span class="sd">				arguments=[&#39;myoperation&#39;, &#39;arg1&#39;,&#39;arg2&#39;],</span>
<span class="sd">				environs=self.createEnvirons(addToLibPath=[&#39;my_ld_lib_path&#39;]), # if a customized environment is needed</span>
<span class="sd">				stdouterr=self.allocateUniqueStdOutErr(&#39;myoperation&#39;), # for stdout/err files, pick a suitable logical name for what it&#39;s doing</span>
<span class="sd">				background=True # or remove for default behaviour of executing in foreground</span>
<span class="sd">				)</span>

<span class="sd">		The method allows spawning of new processes in a platform independent way. The command, arguments,</span>
<span class="sd">		environment and working directory to run the process in can all be specified in the arguments to the</span>
<span class="sd">		method, along with the filenames used for capturing the stdout and stderr of the process. Processes may</span>
<span class="sd">		be started in the foreground, in which case the method does not return until the process has completed</span>
<span class="sd">		or a time out occurs, or in the background in which case the method returns immediately to the caller</span>
<span class="sd">		returning a handle to the process to allow manipulation at a later stage, typically with L{waitProcess}. </span>
<span class="sd">		</span>
<span class="sd">		All processes started in the background are automatically killed on completion of the test via the L{cleanup()} </span>
<span class="sd">		destructor. To wait for background processes to complete during `execute` and/or before `verify` commences, </span>
<span class="sd">		call `waitForBackgroundProcesses()`. This is especially useful when you have a test that needs to execute </span>
<span class="sd">		lots of processes asynchronously, since having them all execute concurrently in the background and then calling </span>
<span class="sd">		`waitForBackgroundProcesses()` will be a lot quicker than executing them serially in the foreground. </span>

<span class="sd">		When starting a process that will listen on a server socket, use `getNextAvailableTCPPort` </span>
<span class="sd">		to allocate a free port before calling this method. </span>

<span class="sd">		.. versionchanged:: 1.6.0</span>
<span class="sd">			Added onError parameter and default behaviour of logging stderr/out when there&#39;s a failure.</span>
<span class="sd">			Added info parameter. </span>
<span class="sd">		.. versionchanged:: 2.0</span>
<span class="sd">			Added processFactory parameter.</span>

<span class="sd">		:param str command: The path to the executable to be launched (should include the full path)</span>
<span class="sd">		:param list[str] arguments: A list of arguments to pass to the command. Any non-string values in the list are </span>
<span class="sd">			converted to strings automatically. </span>
<span class="sd">		</span>
<span class="sd">		:param dict(str,str) environs: A dictionary specifying the environment to run the process in. </span>
<span class="sd">			If a None or empty dictionary is passed, L{getDefaultEnvirons} will be invoked to </span>
<span class="sd">			produce a suitable clean default environment for this `command`, containing a minimal set of variables. </span>
<span class="sd">			If you wish to specify a customized environment, L{createEnvirons()} is a great way to create it.</span>
<span class="sd">		</span>
<span class="sd">		:param str workingDir: The working directory for the process to run in (defaults to the testcase output subdirectory)</span>
<span class="sd">		</span>
<span class="sd">		:param bool background: Set to True to start the process in the background. By default processes are started </span>
<span class="sd">			in the foreground, meaning execution of the test will continue only once the process has terminated. </span>
<span class="sd">		:param state: Alternative way to set ``background=True``. </span>
<span class="sd">			Run the process either in the C{FOREGROUND} or C{BACKGROUND} (defaults to C{FOREGROUND}). Setting </span>
<span class="sd">			state=BACKGROUND is equivalent to setting background=True; in new tests using background=True is the </span>
<span class="sd">			preferred way to do this. </span>
<span class="sd">		</span>
<span class="sd">		:param int timeout: The number of seconds after which to terminate processes running in the foreground. For processes </span>
<span class="sd">			that complete in a few seconds or less, it is best to avoid overriding this and stick with the default. </span>
<span class="sd">			However for long-running foreground processes it will be necessary to set a larger number, for example </span>
<span class="sd">			if running a soak test where the process needs to run for up to 2 hours you could set ``timeout=2*60*60``. </span>
<span class="sd">		</span>
<span class="sd">		:param str stdouterr: The filename prefix to use for the stdout and stderr of the process </span>
<span class="sd">			(`.out`/`.err` will be appended), or a tuple of (stdout,stderr) as returned from </span>
<span class="sd">			L{allocateUniqueStdOutErr}. </span>
<span class="sd">			The stdouterr prefix is also used to form a default display name for the process if none is explicitly provided. </span>
<span class="sd">			The files are created relative to the test output directory. </span>
<span class="sd">			The filenames can be accessed from the returned process object using ``.stdout/err`` from </span>
<span class="sd">			`pysys.process.Process`.</span>
<span class="sd">		</span>
<span class="sd">		:param str stdout: The filename used to capture the stdout of the process. It is usually simpler to use `stdouterr` instead of this. </span>
<span class="sd">		:param str stderr: The filename used to capture the stderr of the process. It is usually simpler to use `stdouterr` instead of this. </span>
<span class="sd">		</span>
<span class="sd">		:param str displayName: Logical name of the process used for display in log messages, and the str(...) </span>
<span class="sd">			representation of the returned process object </span>
<span class="sd">			(defaults to a string generated from the stdouterr and/or the command).</span>
<span class="sd">		</span>
<span class="sd">		:param bool abortOnError: If true abort the test on any error outcome (defaults to the defaultAbortOnError</span>
<span class="sd">			project setting)</span>

<span class="sd">		:param str expectedExitStatus: The condition string used to determine whether the exit status/code </span>
<span class="sd">			returned by the process is correct. The default is &#39;==0&#39;, as an exit code of zero usually indicates success, but if you </span>
<span class="sd">			are expecting a non-zero exit status (for example because you are testing correct handling of </span>
<span class="sd">			a failure condition) this could be set to &#39;!=0&#39; or a specific value such as &#39;==5&#39;. </span>
<span class="sd">	</span>
<span class="sd">		:param bool ignoreExitStatus: If False, a BLOCKED outcome is added if the process terminates with an </span>
<span class="sd">			exit code that doesn&#39;t match expectedExitStatus (or if the command cannot be run at all). </span>
<span class="sd">			This can be set to True in cases where you do not care whether the command succeeds or fails, or wish to handle the </span>
<span class="sd">			exit status separately with more complicated logic. </span>
<span class="sd">			</span>
<span class="sd">			The default value of ignoreExitStatus=None means the value will </span>
<span class="sd">			be taken from the project property defaultIgnoreExitStatus, which can be configured in the project XML </span>
<span class="sd">			(the recommended default property value is defaultIgnoreExitStatus=False), or is set to True for </span>
<span class="sd">			compatibility with older PySys releases if no project property is set. </span>
<span class="sd">		</span>
<span class="sd">		:param Callable[pysys.process.Process]-&gt;str onError: A function that will be called </span>
<span class="sd">			if the process times out or returns an unexpected exit status (unless ignoreExitStatus=True), before </span>
<span class="sd">			any abort exception is raised. This provides a convenient place to add logging of </span>
<span class="sd">			diagnostic information (perhaps using the stdout/err of the process) and/or extracting and returning an </span>
<span class="sd">			error message from the output, for example: ``onError=lambda process: self.logFileContents(process.stderr, tail=True) or self.logFileContents(process.stdout, tail=True)``.</span>

<span class="sd">			If a string value is returned from it will be added to the failure reason, e.g. ``onError=lambda process: self.logFileContents(process.stderr, tail=True) and self.grepOrNone(process.stderr, &#39;Error: (.*)&#39;)``.</span>
<span class="sd">			</span>
<span class="sd">			If no onError function is specified, the default is to log the last few lines of stderr (or if empty, stdout) </span>
<span class="sd">			when a process fails and abortOnError=True. </span>
<span class="sd">			</span>
<span class="sd">			The ``self.logFileContentsDefaultExcludes`` variable can be used to add regular expressions to exclude </span>
<span class="sd">			unimportant lines of output such as standard startup lines (see `logFileContents`). </span>
<span class="sd">		</span>
<span class="sd">		:param bool quiet: If True, this method will not do any INFO or WARN level logging </span>
<span class="sd">			(only DEBUG level), unless a failure outcome is appended. This parameter can be </span>
<span class="sd">			useful to avoid filling up the log where it is necessary to repeatedly execute a </span>
<span class="sd">			command check for completion of some operation until it succeeds; in such cases </span>
<span class="sd">			you should usually set ignoreExitStatus=True as well since both success and </span>
<span class="sd">			failure exit statuses are valid. </span>
<span class="sd">		</span>
<span class="sd">		:param dict[str,obj] info: A dictionary of user-defined information about this process that will be set as </span>
<span class="sd">			a field on the returned Process instance. This is useful for keeping track of things like server port </span>
<span class="sd">			numbers and log file paths. </span>

<span class="sd">		:param callable[kwargs] processFactory: A callable (such as a class constructor) that returns an instance or </span>
<span class="sd">			subclass of `pysys.process.helper.ProcessImpl`. This can be used either to provide a custom process subclass </span>
<span class="sd">			with extra features, or to make modifications to the arguments or environment that were specified by the code </span>
<span class="sd">			that invoked ``startProcess()``. </span>
<span class="sd">			</span>
<span class="sd">			The signature must consist of a ``**kwargs`` parameter, the members of which will be populated by </span>
<span class="sd">			the parameters listed in the constructor of `pysys.process.Process`, and can be modified by the factory. For </span>
<span class="sd">			example::</span>
<span class="sd">			</span>
<span class="sd">				def myProcessFactory(**kwargs):</span>
<span class="sd">					kwargs[&#39;arguments&#39;] = kwargs[&#39;arguments&#39;][0]+[&#39;my_extra_arg&#39;]+kwargs[&#39;arguments&#39;][1:]</span>
<span class="sd">					return pysys.process.helper.ProcessImpl(**kwargs)</span>

<span class="sd">		:return: The process object.</span>
<span class="sd">		:rtype: pysys.process.Process</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">state</span> <span class="o">=</span> <span class="n">FOREGROUND</span>
		<span class="k">if</span> <span class="n">background</span><span class="p">:</span> <span class="n">state</span> <span class="o">=</span> <span class="n">BACKGROUND</span>
		
		<span class="k">if</span> <span class="n">ignoreExitStatus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ignoreExitStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultIgnoreExitStatus</span>
		<span class="n">workingDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">workingDir</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		
		<span class="k">if</span> <span class="n">stdouterr</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">stdout</span> <span class="ow">or</span> <span class="n">stderr</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot specify both stdouterr and stdout/stderr&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">isstring</span><span class="p">(</span><span class="n">stdouterr</span><span class="p">):</span>
				<span class="n">stdout</span> <span class="o">=</span> <span class="n">stdouterr</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
				<span class="n">stderr</span> <span class="o">=</span> <span class="n">stdouterr</span><span class="o">+</span><span class="s1">&#39;.err&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">stdouterr</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">displayName</span><span class="p">:</span>
				<span class="c1"># Heuristically the name selected by the user for stdout/err usually represents the </span>
				<span class="c1"># logical purpose of the process so makes a great display name. </span>
				<span class="c1"># Also add the command (unless they&#39;re the same).</span>
				<span class="c1"># NB: We do not do this if stdout/stderr are used since that could break </span>
				<span class="c1"># behaviour for old tests using getInstanceCount.  </span>
				<span class="n">displayName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.out&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">displayName</span> <span class="ow">and</span> <span class="n">displayName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
					<span class="n">displayName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">displayName</span><span class="p">)</span>
		
		<span class="c1"># in case stdout/err were given as non-absolute paths, make sure they go to the output dir not the cwd</span>
		<span class="k">if</span> <span class="n">stdout</span><span class="p">:</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">stderr</span><span class="p">:</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">displayName</span><span class="p">:</span> <span class="n">displayName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="n">environs</span><span class="p">:</span> <span class="c1"># a truly empty env isn&#39;t really usable, so populate it with a minimal default environment instead</span>
			<span class="n">environs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultEnvirons</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>
		
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		
		<span class="c1"># pass everything as a named parameter, which makes life easier for custom factory methods</span>
		<span class="n">process</span> <span class="o">=</span> <span class="n">processFactory</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span> <span class="n">environs</span><span class="o">=</span><span class="n">environs</span><span class="p">,</span> <span class="n">workingDir</span><span class="o">=</span><span class="n">workingDir</span><span class="p">,</span> 
			<span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> 
			<span class="n">displayName</span><span class="o">=</span><span class="n">displayName</span><span class="p">,</span> <span class="n">expectedExitStatus</span><span class="o">=</span><span class="n">expectedExitStatus</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
		
		<span class="k">def</span> <span class="nf">handleErrorAndGetOutcomeSuffix</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">onError</span><span class="p">:</span> 
				<span class="k">try</span><span class="p">:</span>
					<span class="n">suffix</span> <span class="o">=</span> <span class="n">onError</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring exception from onError handler: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">suffix</span> <span class="ow">and</span> <span class="n">isstring</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
			<span class="k">elif</span> <span class="n">abortOnError</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">return</span> <span class="s1">&#39;&#39;</span>
			
		<span class="k">try</span><span class="p">:</span>
			<span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">FOREGROUND</span><span class="p">:</span>
				<span class="n">correctExitStatus</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">expectedExitStatus</span><span class="p">),</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">})</span>
				
				<span class="n">logmethod</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">correctExitStatus</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">warning</span>
				<span class="k">if</span> <span class="n">quiet</span><span class="p">:</span> <span class="n">logmethod</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span>
				<span class="n">logmethod</span><span class="p">(</span><span class="s2">&quot;Executed </span><span class="si">%s</span><span class="s2">, exit status </span><span class="si">%d%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span>
					<span class="s2">&quot;, duration </span><span class="si">%d</span><span class="s2"> secs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreExitStatus</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">correctExitStatus</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">stderr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Process </span><span class="si">%s</span><span class="s1"> has no stdouterr= specified; providing this parameter will allow PySys to capture the process output that shows why it failed&#39;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> 
						<span class="p">(</span>
							<span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> returned non-zero exit code </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">))</span>
							<span class="k">if</span> <span class="n">expectedExitStatus</span><span class="o">==</span><span class="s1">&#39;==0&#39;</span> <span class="k">else</span>
							<span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> returned exit code </span><span class="si">%d</span><span class="s1"> (expected </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">expectedExitStatus</span><span class="p">))</span>
						<span class="p">)</span><span class="o">+</span><span class="n">handleErrorAndGetOutcomeSuffix</span><span class="p">(</span><span class="n">process</span><span class="p">),</span> 
						<span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">BACKGROUND</span><span class="p">:</span>
				<span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">)(</span><span class="s2">&quot;Started </span><span class="si">%s</span><span class="s2"> with process id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
				<span class="n">hasFailed</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreExitStatus</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Could not start </span><span class="si">%s</span><span class="s1"> process: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">displayName</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># this wouldn&#39;t happen during a polling-until-success use case so is always worth logging even in quiet mode</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">ProcessTimeout</span><span class="p">:</span>
			<span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">)(</span><span class="s2">&quot;Process </span><span class="si">%r</span><span class="s2"> timed out after </span><span class="si">%d</span><span class="s2"> seconds, stopping process&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TIMEOUTS</span><span class="p">))</span>
			<span class="n">process</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> timed out after </span><span class="si">%d</span><span class="s1"> seconds</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">handleErrorAndGetOutcomeSuffix</span><span class="p">(</span><span class="n">process</span><span class="p">)),</span> <span class="n">printReason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">processList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">displayName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">[</span><span class="n">displayName</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">[</span><span class="n">displayName</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">processCount</span><span class="p">[</span><span class="n">displayName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

		<span class="k">return</span> <span class="n">process</span>	</div>

<div class="viewcode-block" id="ProcessUser.getDefaultEnvirons"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getDefaultEnvirons">[docs]</a>	<span class="k">def</span> <span class="nf">getDefaultEnvirons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create a new dictionary of environment variables, suitable for passing to </span>
<span class="sd">		L{startProcess()}, with a minimal clean set of environment variables </span>
<span class="sd">		for this platform, unaffected (as much as possible) by the </span>
<span class="sd">		environment that the tests are being run under. </span>
<span class="sd">		</span>
<span class="sd">		This environment contains a minimal PATH/LD_LIBRARY_PATH but does not </span>
<span class="sd">		attempt to replicate the full set of default environment variables </span>
<span class="sd">		on each OS, and in particular it does not include any that identify </span>
<span class="sd">		the current username or home area. Additional environment </span>
<span class="sd">		variables can be added as needed with L{createEnvirons} overrides. If </span>
<span class="sd">		you don&#39;t care about minimizing the risk of your local environment </span>
<span class="sd">		affecting the test processes you start, just use C{environs=os.environ} </span>
<span class="sd">		to allow child processes to inherit the entire parent environment. </span>
<span class="sd">		</span>
<span class="sd">		The L{createEnvirons()} and L{startProcess()} methods use this as the </span>
<span class="sd">		basis for creating a new set of default environment variables. </span>

<span class="sd">		If needed this method can be overridden in subclasses to add common </span>
<span class="sd">		environment variables for every process invoked by startProcess, for </span>
<span class="sd">		example to enable options such as code coverage for Java/Python/etc. </span>
<span class="sd">		This is also a good place to customize behaviour for different </span>
<span class="sd">		operating systems. </span>

<span class="sd">		Some features of this method can be configured by setting project </span>
<span class="sd">		properties:</span>
<span class="sd">		</span>
<span class="sd">		  - ``defaultEnvirons.ENV_KEY``: if any properties with this prefix are </span>
<span class="sd">		    defined, an environment variable with the ENV_KEY is set by this method </span>
<span class="sd">		    (unless the property value is empty). For example, to set a default </span>
<span class="sd">		    JVM heap size for all processes with the ``JAVA_TOOL_OPTIONS`` environment </span>
<span class="sd">		    variable you could set ``defaultEnvirons.JAVA_TOOL_OPTIONS = -Xmx512M``. </span>
<span class="sd">		</span>
<span class="sd">		  - ``defaultEnvironsDefaultLang``: if set to a value such as ``en_US.UTF-8`` </span>
<span class="sd">		    the specified value is set for the LANG= variable on Unix; otherwise, </span>
<span class="sd">		    the LANG variable is not set (which might result in use of the </span>
<span class="sd">		    legacy POSIX/C encoding).</span>
<span class="sd">		  </span>
<span class="sd">		  - ``defaultEnvironsTempDir``: if set the expression will be passed to </span>
<span class="sd">		    Python ``eval()`` and used to set the OS-specific temp directory </span>
<span class="sd">		    environment variables. A typical value is `self.output`.</span>
<span class="sd">		</span>
<span class="sd">		  - ``defaultEnvironsLegacyMode``: set to true to enable compatibility </span>
<span class="sd">		    mode which keeps the behaviour the same as PySys v1.1, 1.2 and 1.3, </span>
<span class="sd">		    namely using a completely empty default environment on Unix, and </span>
<span class="sd">		    a copy of the entire parent environment on Windows. This is not </span>
<span class="sd">		    recommended unless you have a lot of legacy tests that cannot </span>
<span class="sd">		    easily be changed to only set minimal required environment </span>
<span class="sd">		    variables using `createEnvirons()`. </span>

<span class="sd">		:param command: If known, the full path of the executable for which </span>
<span class="sd">			a default environment is being created (when called from `startProcess` </span>
<span class="sd">			this is always set). This allows default environment variables to be </span>
<span class="sd">			customized for different process types e.g. Java, Python, etc. </span>
<span class="sd">			</span>
<span class="sd">			When using ``command=sys.executable`` to launch another copy of the </span>
<span class="sd">			current Python executable, extra items from this process&#39;s path </span>
<span class="sd">			environment variables are added to the returned dictionary so that it </span>
<span class="sd">			can start correctly. On Unix-based systems this includes copying all of </span>
<span class="sd">			the load library path environment variable from the parent process. </span>
<span class="sd">		</span>
<span class="sd">		:param kwargs: Overrides of this method should pass any additional </span>
<span class="sd">			kwargs down to the super implementation, to allow for future extensions. </span>
<span class="sd">		</span>
<span class="sd">		:return: A new dictionary containing the environment variables. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;Unknown keyword arguments: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

		<span class="c1"># this feature is a workaround to maintain compatibility for a bug in PySys v1.1-1.3</span>
		<span class="c1"># (see https://github.com/pysys-test/pysys-test/issues/9 for details)</span>
		<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="s1">&#39;defaultEnvironsLegacyMode&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span> 
				<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="p">{}</span>

		<span class="n">e</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;defaultEnvirons.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
				<span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">v</span>

		<span class="c1"># allows setting TEMP to output dir to avoid contamination/filling up of system location; set to blank to do nothing</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;defaultEnvironsTempDir&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
			<span class="n">tempDir</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">defaultEnvironsTempDir</span><span class="p">,</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">})</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tempDir</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
				<span class="n">e</span><span class="p">[</span><span class="s1">&#39;TEMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;TMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">tempDir</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">e</span><span class="p">[</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">tempDir</span><span class="p">)</span>
	
		<span class="n">inherited</span> <span class="o">=</span> <span class="p">[]</span> 
		<span class="c1"># env vars where it is safe and useful to inherit parent values</span>
		<span class="c1"># avoid anything user-specific or that might cause tests to store data </span>
		<span class="c1"># outside the test outpuot directory</span>
		
		<span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span> 
			<span class="c1"># for windows there are lots; as a matter of policy we set this to a small </span>
			<span class="c1"># minimal set used by a lot of programs. Keeping up with every single env </span>
			<span class="c1"># var Microsoft sets in every Windows OS release would be too painful, </span>
			<span class="c1"># and better to make users explicitly opt-in to the env vars they want</span>
			<span class="n">inherited</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;ComSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;OS&#39;</span><span class="p">,</span> <span class="s1">&#39;PATHEXT&#39;</span><span class="p">,</span> <span class="s1">&#39;SystemRoot&#39;</span><span class="p">,</span> <span class="s1">&#39;SystemDrive&#39;</span><span class="p">,</span> <span class="s1">&#39;windir&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;NUMBER_OF_PROCESSORS&#39;</span><span class="p">,</span> <span class="s1">&#39;PROCESSOR_ARCHITECTURE&#39;</span><span class="p">,</span>
				<span class="s1">&#39;COMMONPROGRAMFILES&#39;</span><span class="p">,</span> <span class="s1">&#39;COMMONPROGRAMFILES(X86)&#39;</span><span class="p">,</span> <span class="s1">&#39;PROGRAMFILES&#39;</span><span class="p">,</span> <span class="s1">&#39;PROGRAMFILES(X86)&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;SYSTEM&#39;</span><span class="p">,</span> <span class="s1">&#39;SYSTEM32&#39;</span><span class="p">])</span>
		
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherited</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		
		<span class="c1"># always set PATH/LD_LIB_PATH to clean values from constants.py</span>
		<span class="c1"># note that if someone is using an OS with different defaults they won&#39;t </span>
		<span class="c1"># be able to edit constants.py but will be able to provide a custom </span>
		<span class="c1"># implementation of this method</span>
		<span class="n">e</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PATH</span>
		<span class="k">if</span> <span class="n">LD_LIBRARY_PATH</span><span class="p">:</span>
			<span class="n">e</span><span class="p">[</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LD_LIBRARY_PATH</span>
		<span class="k">if</span> <span class="n">DYLD_LIBRARY_PATH</span><span class="p">:</span>
			<span class="n">e</span><span class="p">[</span><span class="s1">&#39;DYLD_FALLBACK_LIBRARY_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DYLD_LIBRARY_PATH</span>
				
		<span class="k">if</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="s1">&#39;defaultEnvironsDefaultLang&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
				<span class="n">e</span><span class="p">[</span><span class="s1">&#39;LANG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">defaultEnvironsDefaultLang</span>
		
		<span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">:</span>
			<span class="c1"># Ensure it&#39;s possible to run another instance of this Python, by adding it to the start of the path env vars</span>
			<span class="c1"># (but only if full path to the Python executable exactly matches).</span>
			<span class="c1"># Keep it as clean as possible by not passing sys.path/PYTHONPATH</span>
			<span class="c1"># - but it seems we do need to copy the LD_LIBRARY_PATH from the parent process to ensure the required libraries are present.</span>
			<span class="c1"># Do not set PYTHONHOME here, as doesn&#39;t work well in virtualenv, and messes up grandchildren </span>
			<span class="c1"># processes that need a different Python version</span>
			<span class="n">e</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">+</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
			
			<span class="k">if</span> <span class="n">LIBRARY_PATH_ENV_VAR</span> <span class="o">!=</span> <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="c1"># if it&#39;s an os with something like LD_LIBRARY_PATH</span>
				<span class="c1"># It&#39;s a shame it&#39;s necessary to copy parent environment, but there&#39;s no sane way to unpick which libraries are </span>
				<span class="c1"># actually required on Unix. Make sure we don&#39;t set this env var to an empty string just in case that </span>
				<span class="c1"># doesn&#39;t anything weird. </span>
				<span class="n">newlibpath</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">newlibpath</span><span class="p">:</span>
					<span class="n">e</span><span class="p">[</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlibpath</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;getDefaultEnvirons was called with a command matching this Python executable; adding required path environment variables from parent environment, including </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>  
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;getDefaultEnvirons was called with a command matching this Python executable; adding required path environment variables from parent environment&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="ProcessUser.createEnvirons"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.createEnvirons">[docs]</a>	<span class="k">def</span> <span class="nf">createEnvirons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addToLibPath</span><span class="o">=</span><span class="p">[],</span> <span class="n">addToExePath</span><span class="o">=</span><span class="p">[],</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create a new customized dictionary of environment variables suitable </span>
<span class="sd">		for passing to L{startProcess()}&#39;s ``environs=`` argument. </span>
<span class="sd">		</span>
<span class="sd">		As a starting point, this method uses the value returned by </span>
<span class="sd">		L{getDefaultEnvirons()} for this `command`. See the documentation on </span>
<span class="sd">		that method for more details. If you don&#39;t care about minimizing the </span>
<span class="sd">		risk of your local environment affecting the test processes you start, </span>
<span class="sd">		just use C{environs=os.environ} to allow child processes to inherit the </span>
<span class="sd">		entire parent environment instead of using this method. </span>
<span class="sd">		</span>
<span class="sd">		:param overrides: A dictionary of environment variables whose </span>
<span class="sd">			values will be used instead of any existing values. </span>
<span class="sd">			You can use `os.getenv(&#39;VARNAME&#39;,&#39;&#39;)` if you need to pass selected </span>
<span class="sd">			variables from the current process as part of the overrides list. </span>
<span class="sd">			If the value is set to None then any variable of this name will be </span>
<span class="sd">			deleted. Use unicode strings if possible (byte strings will be </span>
<span class="sd">			converted depending on the platform). </span>
<span class="sd">			A list of dictionaries can be specified, in which case the latest </span>
<span class="sd">			will override the earlier if there are any conflicts.</span>
<span class="sd">		</span>
<span class="sd">		:param addToLibPath: A path or list of paths to be prepended to the </span>
<span class="sd">			default value for the environment variable used to load libraries </span>
<span class="sd">			(or the value specified in overrides, if any), </span>
<span class="sd">			i.e. ``[DY]LD_LIBRARY_PATH`` on Unix or ``PATH`` on Windows. This is usually </span>
<span class="sd">			more convenient than adding it directly to `overrides`. </span>

<span class="sd">		:param addToExePath: A path or list of paths to be prepended to the </span>
<span class="sd">			default value for the environment variable used to locate executables </span>
<span class="sd">			(or the value specified in overrides, if any), </span>
<span class="sd">			i.e. ``PATH`` on both Unix and Windows. This is usually </span>
<span class="sd">			more convenient than adding it directly to ``overrides``. </span>
<span class="sd">		</span>
<span class="sd">		:param command: If known, the full path of the executable for which </span>
<span class="sd">			a default environment is being created (passed to L{getDefaultEnvirons}). </span>
<span class="sd">		</span>
<span class="sd">		:param kwargs: Overrides of this method should pass any additional </span>
<span class="sd">			kwargs down to the super implementation, to allow for future extensions. </span>
<span class="sd">		</span>
<span class="sd">		:return: A new dictionary containing the environment variables. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;Unknown keyword arguments: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultEnvirons</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">overrides</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overrides</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">overrides</span> <span class="o">=</span> <span class="p">[</span><span class="n">overrides</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">d</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c1"># normalize common ones to avoid chance of duplicates</span>
						<span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">e</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># remove</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		
		<span class="k">def</span> <span class="nf">preparepath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">isstring</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> 
				<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">path</span>
			
		<span class="k">if</span> <span class="n">addToLibPath</span><span class="p">:</span>
			<span class="n">e</span><span class="p">[</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">preparepath</span><span class="p">(</span><span class="n">addToLibPath</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">+</span><span class="n">e</span><span class="p">[</span><span class="n">LIBRARY_PATH_ENV_VAR</span><span class="p">]</span>

		<span class="k">if</span> <span class="n">addToExePath</span><span class="p">:</span>
			<span class="n">e</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preparepath</span><span class="p">(</span><span class="n">addToExePath</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">+</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
		
		<span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="ProcessUser.stopProcess"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.stopProcess">[docs]</a>	<span class="k">def</span> <span class="nf">stopProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Stops the specified process, if it is currently running.</span>

<span class="sd">		Does nothing if the process is not running. </span>
<span class="sd">		</span>
<span class="sd">		This is equivalent to calling `pysys.process.Process.stop()`, except it also </span>
<span class="sd">		logs an info message when the process is stopped.</span>

<span class="sd">		:param process: The process handle returned from the L{startProcess} method</span>
<span class="sd">		:param abortOnError: If True abort the test on any error outcome (defaults to the defaultAbortOnError</span>
<span class="sd">			project setting), if False a failure to stop the process will just be logged as a warning. </span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		<span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">process</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped process </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">abortOnError</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring failure to stop process </span><span class="si">%r</span><span class="s2"> due to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Unable to stop process </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span></div>


<div class="viewcode-block" id="ProcessUser.signalProcess"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.signalProcess">[docs]</a>	<span class="k">def</span> <span class="nf">signalProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Send a signal to a running process.</span>

<span class="sd">		This method uses the `pysys.process.Process.signal` method to send a signal to a </span>
<span class="sd">		running process. </span>
<span class="sd">		</span>
<span class="sd">		Should the request to send the signal to the running process fail, a C{BLOCKED} outcome will be added to the</span>
<span class="sd">		outcome list.</span>

<span class="sd">		:param process: The process handle returned from the L{startProcess} method</span>
<span class="sd">		:param signal: The integer value of the signal to send</span>
<span class="sd">		:param abortOnError: If True aborts the test with an exception on any error, if False just log it as a warning. </span>
<span class="sd">			(defaults to the defaultAbortOnError project setting)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		<span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">process</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sent </span><span class="si">%d</span><span class="s2"> signal to process </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">abortOnError</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring failure to signal process </span><span class="si">%r</span><span class="s2"> due to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Unable to signal process </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span></div>


<div class="viewcode-block" id="ProcessUser.waitProcess"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitProcess">[docs]</a>	<span class="k">def</span> <span class="nf">waitProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForProcess&#39;</span><span class="p">],</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkExitStatus</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Wait for a background process to terminate.</span>

<span class="sd">		For a convenient way to wait for all remaining background processes to complete, see `waitForBackgroundProcesses`. </span>

<span class="sd">		Timeouts will result in an exception and TIMEDOUT outcome unless the project property ``defaultAbortOnError==False`` </span>
<span class="sd">		is set.</span>
<span class="sd">		</span>
<span class="sd">		:param pysys.process.Process process: The process handle returned from the L{startProcess} method</span>
<span class="sd">		:param int timeout: The timeout value in seconds to wait before returning, for example ``timeout=TIMEOUTS[&#39;WaitForProcess&#39;]``.</span>
<span class="sd">		:param bool abortOnError: If True aborts the test with an exception on any error, if False just log it as a warning. </span>
<span class="sd">			(defaults to the defaultAbortOnError project setting)</span>
<span class="sd">		:param bool checkExitStatus: By default this method does not check the exit status, but set this argument to True </span>
<span class="sd">			to check that the exit status matches the ``expectedExitStatus`` specified in the call to `startProcess` </span>
<span class="sd">			(typically ``==0``). </span>
<span class="sd">			Note that this argument is not affected by the ``defaultIgnoreExitStatus`` project property. </span>
<span class="sd">			The last few lines of the stderr (or stdout) will be logged if the exit status is wrong. </span>
<span class="sd">		:return: The process&#39;s ``exitStatus``. This will be None if the process timed out and abortOnError is disabled. </span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting up to </span><span class="si">%d</span><span class="s2"> secs for process </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
			<span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">%s</span><span class="s2"> terminated after </span><span class="si">%d</span><span class="s2"> secs with exit status </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">)</span>
				
		<span class="k">except</span> <span class="n">ProcessTimeout</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">abortOnError</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring timeout waiting for process </span><span class="si">%r</span><span class="s2"> after </span><span class="si">%d</span><span class="s2"> secs (as abortOnError=False)&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TIMEOUTS</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="s1">&#39;Timed out waiting for process </span><span class="si">%s</span><span class="s1"> after </span><span class="si">%d</span><span class="s1"> secs&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">timeout</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">checkExitStatus</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">expectedExitStatus</span><span class="p">),</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

					<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> 
						<span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> returned exit status </span><span class="si">%d</span><span class="s1"> (expected </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">expectedExitStatus</span><span class="p">)),</span> 
						<span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span></div>

<div class="viewcode-block" id="ProcessUser.pollWait"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.pollWait">[docs]</a>	<span class="k">def</span> <span class="nf">pollWait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sleeps the current thread for the specified number of seconds, between polling/checking for some condition </span>
<span class="sd">		to be met. </span>
<span class="sd">		</span>
<span class="sd">		Unlike `pysys.basetest.BaseTest.wait` (which should be used for larger waits inside tests), pollWait does not </span>
<span class="sd">		log anything. </span>
<span class="sd">		</span>
<span class="sd">		Use this method instead of ``time.sleep`` as it provides PySys the chance to abort test execution early when </span>
<span class="sd">		requested. </span>
<span class="sd">		</span>
<span class="sd">		:param float secs: The time to sleep for, typically a few hundred milliseconds. Do not use this method for </span>
<span class="sd">			really long waits. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">secs</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;pollWait </span><span class="si">%s</span><span class="s1"> secs&#39;</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="c1"># no-op if secs == 0</span></div>

<div class="viewcode-block" id="ProcessUser.waitForBackgroundProcesses"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitForBackgroundProcesses">[docs]</a>	<span class="k">def</span> <span class="nf">waitForBackgroundProcesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="p">[],</span> <span class="n">excludes</span><span class="o">=</span><span class="p">[],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForProcess&#39;</span><span class="p">],</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkExitStatus</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Wait for any running background processes to terminate, then check that all background processes </span>
<span class="sd">		completed with the expected exit status.</span>
<span class="sd">		</span>
<span class="sd">		This can be useful for speeding up a test that needs to run many processes, by executing all its subprocesses </span>
<span class="sd">		in parallel in the background (and then waiting for completion) rather than one-by-one in the foreground. </span>

<span class="sd">		Timeouts will result in a TIMEDOUT outcome and an exception unless the project property ``defaultAbortOnError==False`` </span>
<span class="sd">		is set. </span>

<span class="sd">		:param list[pysys.process.Process] includes: A list of processes to wait for, each returned by `startProcess()`. </span>
<span class="sd">			If none are specified, this method will wait for (and check the exit status of) all background processes. </span>
<span class="sd">		:param list[pysys.process.Process] excludes: A list of processes which are not expected to have terminated yet </span>
<span class="sd">			(this is only useful when not setting includes=[]). </span>
<span class="sd">		</span>
<span class="sd">		:param int timeout: The total time in seconds to wait for all processes to have completed, for example ``timeout=TIMEOUTS[&#39;WaitForProcess&#39;]``.</span>
<span class="sd">		</span>
<span class="sd">		:param bool abortOnError: If True aborts the test with an exception on any error, if False appends an outcome but does not </span>
<span class="sd">			raise an exception. </span>
<span class="sd">		:param bool checkExitStatus: By default this method not only waits for completion but also checks the exit status of </span>
<span class="sd">			all (included) background processes (regardless of when they completed), but set this argument to False </span>
<span class="sd">			to disable checking that the exit status of the processes matches the ``expectedExitStatus`` specified in </span>
<span class="sd">			the call to `startProcess` (typically ``==0``). </span>
<span class="sd">			The last few lines of the stderr (or stdout) will be logged if the exit status is wrong. </span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">assert</span> <span class="n">timeout</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;timeout must be specified&#39;</span>
		<span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="n">includes</span> <span class="o">=</span> <span class="n">includes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">processList</span>
		
		<span class="n">running</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">includes</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="n">BACKGROUND</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">running</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting up to </span><span class="si">%d</span><span class="s1"> secs for </span><span class="si">%d</span><span class="s1"> background process(es) to complete&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">running</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">running</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">thistimeout</span> <span class="o">=</span> <span class="n">starttime</span><span class="o">+</span><span class="n">timeout</span><span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">thistimeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># we&#39;ve run out of time</span>
					<span class="k">raise</span> <span class="n">ProcessTimeout</span><span class="p">(</span><span class="s1">&#39;waitForBackgroundProcesses timed out&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">running</span><span class="p">():</span> 
					<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">thistimeout</span><span class="p">)</span> <span class="c1"># may raise ProcessTimeout</span>
			<span class="k">except</span> <span class="n">ProcessTimeout</span><span class="p">:</span>
				<span class="n">stillrunning</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">running</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="n">BACKGROUND</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">running</span><span class="p">()]</span>
				<span class="k">if</span> <span class="n">stillrunning</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="s1">&#39;Timed out waiting for </span><span class="si">%d</span><span class="s1"> processes after </span><span class="si">%d</span><span class="s1"> secs: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stillrunning</span><span class="p">),</span> <span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">stillrunning</span><span class="p">))),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>
					<span class="k">return</span> <span class="kc">False</span>

		<span class="c1"># now check exit statuses - for all background processes, not only those that happen to have completed recently; </span>
		<span class="c1"># but only after we&#39;ve confirmed (above) there were no timeouts</span>
		<span class="k">if</span> <span class="n">checkExitStatus</span><span class="p">:</span>
			<span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">includes</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">state</span><span class="o">!=</span><span class="n">BACKGROUND</span> <span class="ow">or</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">:</span> <span class="k">continue</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">expectedExitStatus</span><span class="p">),</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFileContents</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

					<span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> returned exit status </span><span class="si">%s</span><span class="s1"> (expected </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">expectedExitStatus</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> processes failed: &#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Process &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failures</span><span class="p">),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">)</span>
		<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">)(</span><span class="s1">&#39;All processes completed, after waiting </span><span class="si">%d</span><span class="s1"> secs&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProcessUser.writeProcess"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.writeProcess">[docs]</a>	<span class="k">def</span> <span class="nf">writeProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addNewLine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Write binary data to the stdin of a process.</span>

<span class="sd">		This method uses `pysys.process.Process.write` to write binary data to the stdin of a process. This</span>
<span class="sd">		wrapper around the write method of the process helper only adds checking of the process running status prior</span>
<span class="sd">		to the write being performed, and logging to the testcase run log to detail the write.</span>

<span class="sd">		:param pysys.process.Process process: The process handle returned from the L{startProcess()} method</span>
<span class="sd">		:param bytes data: The data to write to the process stdin. </span>
<span class="sd">			As only binary data can be written to a process stdin, </span>
<span class="sd">			if a character string rather than a byte object is passed as the data,</span>
<span class="sd">			it will be automatically converted to a bytes object using the encoding </span>
<span class="sd">			given by PREFERRED_ENCODING. </span>
<span class="sd">		:param bool addNewLine: True if a new line character is to be added to the end of the data string</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
			<span class="n">process</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addNewLine</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Written to stdin of process </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Write to process </span><span class="si">%r</span><span class="s2"> stdin not performed as process is not running&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessUser.waitForSocket"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitForSocket">[docs]</a>	<span class="k">def</span> <span class="nf">waitForSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForSocket&#39;</span><span class="p">],</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">socketAddressFamily</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Wait until it is possible to establish a socket connection to a </span>
<span class="sd">		server running on the specified local or remote port. </span>
<span class="sd">		</span>
<span class="sd">		This method blocks until connection to a particular host:port pair can be established. This is useful for</span>
<span class="sd">		test timing where a component under test creates a socket for client server interaction - calling of this</span>
<span class="sd">		method ensures that on return of the method call the server process is running and a client is able to</span>
<span class="sd">		create connections to it. If a connection cannot be made within the specified timeout interval, the method</span>
<span class="sd">		returns to the caller, or aborts the test if abortOnError=True. </span>
<span class="sd">		</span>
<span class="sd">		.. versionchanged:: 1.5.1</span>
<span class="sd">			Added host and socketAddressFamily parameters.</span>
<span class="sd">		</span>
<span class="sd">		:param port: The port value in the socket host:port pair</span>
<span class="sd">		:param host: The host value in the socket host:port pair</span>
<span class="sd">		:param timeout: The timeout in seconds to wait for connection to the socket</span>
<span class="sd">		:param abortOnError: If true abort the test on any failure (defaults to the defaultAbortOnError</span>
<span class="sd">			project setting)</span>
<span class="sd">		:param process: If a handle to a process is specified, the wait will abort if </span>
<span class="sd">			the process dies before the socket becomes available. It is recommended to set this wherever possible. </span>
<span class="sd">		:param socketAddressFamily: The socket address family e.g. IPv4 vs IPv6. See Python&#39;s ``socket`` module for </span>
<span class="sd">			details. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>

		<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing wait for socket creation </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

		<span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
			<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">with</span> <span class="n">process_lock</span><span class="p">:</span>
						<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socketAddressFamily</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
						<span class="c1"># the following lines are to prevent handles being inherited by </span>
						<span class="c1"># other processes started while this test is runing</span>
						<span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
							<span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_LINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">win32api</span><span class="o">.</span><span class="n">SetHandleInformation</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">win32con</span><span class="o">.</span><span class="n">HANDLE_FLAG_INHERIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			
				<span class="k">try</span><span class="p">:</span>
					<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
					<span class="n">s</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
					
					<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wait for socket creation completed successfully&quot;</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wait for socket creation completed after </span><span class="si">%d</span><span class="s2"> secs&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">)</span>
					<span class="k">return</span> <span class="kc">True</span>
				<span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
						<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Waiting for socket connection aborted due to unexpected process </span><span class="si">%s</span><span class="s2"> termination&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
						<span class="k">return</span> <span class="kc">False</span>

					<span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
						<span class="n">currentTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
						<span class="k">if</span> <span class="n">currentTime</span> <span class="o">&gt;</span> <span class="n">startTime</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
							<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Timed out waiting for creation of socket after </span><span class="si">%d</span><span class="s2"> secs: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
							<span class="k">return</span> <span class="kc">False</span>
				<span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
					<span class="c1"># MacOS gives an error if we try to connect to the same socket again after connection refused</span>
					<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
					<span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pollWait</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProcessUser.waitForFile"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitForFile">[docs]</a>	<span class="k">def</span> <span class="nf">waitForFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForFile&#39;</span><span class="p">],</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Wait for a file to exist on disk.</span>
<span class="sd">		</span>
<span class="sd">		This method blocks until a file is created on disk. This is useful for test timing where </span>
<span class="sd">		a component under test creates a file (e.g. for logging) indicating it has performed all </span>
<span class="sd">		initialisation actions and is ready for the test execution steps. If a file is not created </span>
<span class="sd">		on disk within the specified timeout interval, the method returns to the caller.</span>

<span class="sd">		:param file: The basename of the file used to wait to be created</span>
<span class="sd">		:param filedir: The dirname of the file (defaults to the testcase output subdirectory)</span>
<span class="sd">		:param timeout: The timeout in seconds to wait for the file to be created</span>
<span class="sd">		:param abortOnError: If true abort the test on any failure (defaults to the defaultAbortOnError</span>
<span class="sd">			project setting)</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		<span class="k">if</span> <span class="n">filedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">filedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
		
		<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing wait for file creation: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
		
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
				<span class="n">currentTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">currentTime</span> <span class="o">&gt;</span> <span class="n">startTime</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>

					<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Timed out waiting for creation of file </span><span class="si">%s</span><span class="s2"> after </span><span class="si">%d</span><span class="s2"> secs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
					<span class="k">break</span>
					
			<span class="bp">self</span><span class="o">.</span><span class="n">pollWait</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">pathexists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
				<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wait for &#39;</span><span class="si">%s</span><span class="s2">&#39; file creation completed successfully&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
				<span class="k">return</span></div>

<div class="viewcode-block" id="ProcessUser.waitForSignal"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitForSignal">[docs]</a>	<span class="k">def</span> <span class="nf">waitForSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">waitForGrepArgs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Old alias for `waitForGrep`; please use `waitForGrep` in new tests.</span>
<span class="sd">		</span>
<span class="sd">		All parameters are the same, except that in waitForSignal the (rarely used) ``filedir`` argument can be </span>
<span class="sd">		specified as the 2nd positional argument (after ``file`` and before ``expr``) whereas in waitForGrep it can </span>
<span class="sd">		only be specified as a ``filedir=`` keyword argument. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">waitForGrep</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">filedir</span><span class="o">=</span><span class="n">filedir</span><span class="p">,</span> <span class="o">**</span><span class="n">waitForGrepArgs</span><span class="p">)</span></div>
			
<div class="viewcode-block" id="ProcessUser.waitForGrep"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.waitForGrep">[docs]</a>	<span class="k">def</span> <span class="nf">waitForGrep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;&gt;=1&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForSignal&#39;</span><span class="p">],</span> <span class="n">poll</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> 
			<span class="n">ignores</span><span class="o">=</span><span class="p">[],</span> <span class="n">process</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errorExpr</span><span class="o">=</span><span class="p">[],</span> <span class="n">errorIf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detailMessage</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[],</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Wait for a regular expression line to be seen (one or more times) in a text file in the output </span>
<span class="sd">		directory (waitForGrep was formerly known as `waitForSignal`).</span>
<span class="sd">		</span>
<span class="sd">		This method provides some parameters that give helpful fail-fast behaviour with a descriptive outcome reason; </span>
<span class="sd">		use these whenever possible:</span>
<span class="sd">		</span>
<span class="sd">		  - ``process=`` to abort if success becomes impossible due to premature termination of the process that&#39;s </span>
<span class="sd">		    generating the output</span>
<span class="sd">		  - ``errorExpr=`` to abort if an error message/expression is written to the file being grepped</span>
<span class="sd">		  - ``errorIf=`` to abort if the specified lambda function returns an error string (which can be used if the </span>
<span class="sd">		    error messages go to a different file than that being grepped</span>
<span class="sd">		</span>
<span class="sd">		This will generate much clearer outcome reasons, which makes test failures easy to triage, </span>
<span class="sd">		and also avoids wasting time waiting for something that will never happen.</span>
<span class="sd">		</span>
<span class="sd">		Example::</span>
<span class="sd">		</span>
<span class="sd">			self.waitForGrep(&#39;myprocess.log&#39;, expr=&#39;INFO .*Started successfully&#39;, encoding=&#39;utf-8&#39;,</span>
<span class="sd">				process=myprocess, errorExpr=[&#39; (ERROR|FATAL) &#39;, &#39;Failed to start&#39;])</span>
<span class="sd">			</span>
<span class="sd">			self.waitForGrep(&#39;myoutput.log&#39;, expr=&#39;My message&#39;, encoding=&#39;utf-8&#39;,</span>
<span class="sd">				process=myprocess, errorIf=lambda: self.grepOrNone(&#39;myprocess.err&#39;, &#39; ERROR .*&#39;))</span>
<span class="sd">			</span>
<span class="sd">		Note that waitForGrep fails the test if the expression is not found (unless abortOnError was set to False, </span>
<span class="sd">		which isn&#39;t recommended), so there is no need to add duplication with an </span>
<span class="sd">		`assertGrep &lt;pysys.basetest.BaseTest.assertGrep&gt;` to check for the same expression in your validation logic. </span>

<span class="sd">		You can extract information from the matched expression, optionally perform assertions on it, by </span>
<span class="sd">		using one or more ``(?P&lt;groupName&gt;...)`` named groups in the expression. A common </span>
<span class="sd">		pattern is to unpack the resulting dict using ``**kwargs`` syntax and pass to `BaseTest.assertThat`. For </span>
<span class="sd">		example::</span>

<span class="sd">			self.assertThat(&#39;username == expected&#39;, expected=&#39;myuser&#39;,</span>
<span class="sd">				**self.waitForGrep(&#39;myserver.log&#39;, expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot;&#39;))</span>

<span class="sd">		.. versionadded:: 1.5.1</span>

<span class="sd">		:param str file: The path of the file to be searched. Usually this is a name/path relative to the </span>
<span class="sd">			``self.output`` directory, but alternatively an absolute path can be specified. </span>
<span class="sd">		</span>
<span class="sd">		:param str expr: The regular expression to search for in the text file.</span>
<span class="sd">		</span>
<span class="sd">		:param str condition: The condition to be met for the number of lines matching the regular expression; by default </span>
<span class="sd">			we wait until there is at least one occurrence. </span>
<span class="sd">		</span>
<span class="sd">		:param int timeout: The number of seconds to wait for the regular expression before giving up and aborting </span>
<span class="sd">			the test with `pysys.constants.TIMEDOUT` (unless abortOnError=False in which case execution will continue).</span>
<span class="sd">		</span>
<span class="sd">		:param pysys.process.Process process: The process that is generating the specified </span>
<span class="sd">			file, to allow the wait to fail fast (instead of timing out) if the process dies before the expected signal </span>
<span class="sd">			appears. Can be None if the process is not known or is expected to terminate itself during this period. </span>
<span class="sd">		</span>
<span class="sd">		:param list[str] errorExpr: Optional list of regular expressions, which if found in the file will cause waiting </span>
<span class="sd">			for the main expression to be aborted with a `pysys.constants.BLOCKED` outcome. This is useful to avoid waiting </span>
<span class="sd">			a long time for the expected expression when an ERROR is logged that means it will never happen, and </span>
<span class="sd">			also provides much clearer test failure messages in this case. </span>

<span class="sd">		:param callable-&gt;str errorIf: A zero-arg function that returns False/None when there is no error, or a non-empty </span>
<span class="sd">			string if an error is detected which should cause us to abort looking for the grep expression. </span>
<span class="sd">			This function will be executed frequently (every ``poll`` seconds) so avoid </span>
<span class="sd">			doing anything time-consuming here unless you set a large polling interval. </span>
<span class="sd">			See above for an example. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0. </span>

<span class="sd">		:param list[str] ignores: A list of regular expressions used to identify lines in the files which should be ignored </span>
<span class="sd">			when matching both `expr` and `errorExpr`. </span>

<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file, and `pysys.mappers.JoinLines` can be used to put </span>
<span class="sd">			exception stack traces onto the same line as the error message. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0.</span>

<span class="sd">		:param float poll: The time in seconds between to poll the file looking for the regular expression and to check against the condition</span>
<span class="sd">				</span>
<span class="sd">		:param bool abortOnError: If True abort the test on any error outcome (defaults to the defaultAbortOnError</span>
<span class="sd">			project setting, which for a modern project will be True).</span>
<span class="sd">		</span>
<span class="sd">		:param str encoding: The encoding to use to open the file and convert from bytes to characters. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>

<span class="sd">		:param str detailMessage: An extra string to add to the message logged when waiting to provide extra </span>
<span class="sd">			information about the wait condition. e.g. ``detailMessage=&#39;(downstream message received)&#39;``. </span>
<span class="sd">			Added in v1.5.1. </span>

<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>
<span class="sd">			</span>
<span class="sd">		:param str filedir: Can be used to provide a directory name to add to the beginning of the ``file`` parameter; </span>
<span class="sd">			however usually it is clearer just to specify that directory in the ``file``.</span>
<span class="sd">		</span>
<span class="sd">		:param bool quiet: Set this to true to suppress INFO-level logging, which can be useful when you wish to </span>
<span class="sd">			print your own progress message in a more high-level fashion. </span>

<span class="sd">		:return list[re.Match]: Usually this returns a list of ``re.Match`` objects found for the ``expr``, or an </span>
<span class="sd">			empty list if there was no match.</span>
<span class="sd">		</span>
<span class="sd">			If the expr contains any ``(?P&lt;groupName&gt;...)`` named groups, and assuming the condition is still the </span>
<span class="sd">			default of &quot;&gt;=1&quot; (i.e. not trying to find multiple matches), then instead of a list, a dict is returned </span>
<span class="sd">			containing ``dict(groupName: str, matchValue: str or None)`` (or an empty ``{}`` dict if there is no match) </span>
<span class="sd">			which allows the result to be passed to `assertThat` for further checking of the matched groups (typically </span>
<span class="sd">			unpacked using the ``**`` operator; see example above). </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;expr= argument must be specified&#39;</span>
		<span class="k">assert</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;expr= cannot contain multiple lines&#39;</span>
		
		<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
		<span class="k">if</span> <span class="n">filedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">filedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">errorExpr</span><span class="p">:</span> <span class="k">assert</span> <span class="ow">not</span> <span class="n">isstring</span><span class="p">(</span><span class="n">errorExpr</span><span class="p">),</span> <span class="s1">&#39;errorExpr must be a list of strings not a string&#39;</span>
		
		<span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Waiting for </span><span class="si">{expr}</span><span class="s2"> </span><span class="si">{condition}</span><span class="s2">in </span><span class="si">{file}{detail}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
			<span class="n">expr</span><span class="o">=</span><span class="n">quotestring</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="c1"># repr performs escaping of embedded quotes, newlines, etc</span>
			<span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; &#39;</span> <span class="k">if</span> <span class="n">condition</span><span class="o">!=</span><span class="s1">&#39;&gt;=1&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># only include if non-default</span>
			<span class="n">file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">),</span>
			<span class="n">detail</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">detailMessage</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">detailMessage</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
			<span class="p">)</span>

		<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing wait for grep signal </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> in file </span><span class="si">%s</span><span class="s2"> with ignores </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignores</span><span class="p">)</span>
		
		<span class="n">loginfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span> <span class="k">if</span> <span class="n">quiet</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
		
		<span class="n">verboseWaitForSignal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoolProperty</span><span class="p">(</span><span class="s1">&#39;verboseWaitForSignal&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoolProperty</span><span class="p">(</span><span class="s1">&#39;verboseWaitForGrep&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">verboseWaitForSignal</span><span class="p">:</span> 
			<span class="c1"># if verbose, log when starting (which is very helpful for debugging hangs); non-verbose users get the message only when it&#39;s done</span>
			<span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;; timeout=</span><span class="si">%s</span><span class="s1">s&#39;</span><span class="o">%</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span><span class="o">!=</span><span class="n">TIMEOUTS</span><span class="p">[</span><span class="s1">&#39;WaitForSignal&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
		
		<span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
		
		<span class="c1"># If condition was customized (typically to be more than 1) named groups mode isn&#39;t so useful since there would </span>
		<span class="c1"># be multiple matches, so restrict it to 1 which is the common case anyway. </span>
		<span class="n">compiled</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">)</span>
		<span class="n">namedGroupsMode</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">groupindex</span> <span class="ow">and</span> <span class="n">condition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;&gt;=1&#39;</span>

		<span class="n">timetaken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">pathexists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
				<span class="n">matches</span> <span class="o">=</span> <span class="n">getmatches</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">ignores</span><span class="o">=</span><span class="n">ignores</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">condition</span><span class="p">),</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}):</span>
					<span class="n">timetaken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">timetaken</span>
					<span class="c1"># Old-style/non-verbose behaviour is to log only after complete, </span>
					<span class="c1"># new/verbose style does the main logging at INFO when starting, and only logs on completion if it took a long time</span>
					<span class="c1"># (this helps people debug tests that sometimes timeout and sometimes &quot;nearly&quot; timeout)</span>
					<span class="k">if</span> <span class="n">verboseWaitForSignal</span><span class="p">:</span>
						<span class="p">(</span><span class="n">loginfo</span> <span class="k">if</span> <span class="n">timetaken</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">)(</span><span class="s2">&quot;   ... found </span><span class="si">%d</span><span class="s2"> matches in </span><span class="si">%s</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">timetaken</span><span class="p">))</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="c1"># We use the phrase &quot;grep signal&quot; to avoid misleading anyone, whether people used waitForGrep or the older waitForSignal</span>
						<span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Wait for grep signal in </span><span class="si">%s</span><span class="s2"> completed successfully&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
					<span class="k">break</span>
				
				<span class="k">if</span> <span class="n">errorExpr</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errorExpr</span><span class="p">:</span>
						<span class="n">errmatches</span> <span class="o">=</span> <span class="n">getmatches</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">err</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">ignores</span><span class="o">=</span><span class="n">ignores</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">)</span> <span class="c1"># add .* to capture entire err msg for a better outcome reason</span>
						<span class="k">if</span> <span class="n">errmatches</span><span class="p">:</span>
							<span class="n">err</span> <span class="o">=</span> <span class="n">errmatches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
							<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found while </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">quotestring</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
							<span class="c1"># always report outcome for this case; additionally abort if requested to</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="n">abortOnError</span><span class="p">,</span> <span class="n">callRecord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
							<span class="k">return</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">namedGroupsMode</span> <span class="k">else</span> <span class="n">matches</span>
				
			<span class="n">currentTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">currentTime</span> <span class="o">&gt;</span> <span class="n">startTime</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> timed out after </span><span class="si">%d</span><span class="s2"> secs, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> 
					<span class="p">(</span><span class="s2">&quot;with </span><span class="si">%d</span><span class="s2"> matches&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span> <span class="k">if</span> <span class="n">pathexists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;file does not exist&#39;</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">TIMEDOUT</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TIMEOUTS</span><span class="p">))</span>
				<span class="k">break</span>
			
			<span class="k">if</span> <span class="n">errorIf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">errmsg</span> <span class="o">=</span> <span class="n">errorIf</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">errmsg</span><span class="p">:</span>
					<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> aborted due to errorIf returning </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
					<span class="k">break</span>
				
			<span class="k">if</span> <span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> aborted due to process </span><span class="si">%s</span><span class="s2"> termination&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">abortOnError</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">())</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
				<span class="k">break</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">pollWait</span><span class="p">(</span><span class="n">poll</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">namedGroupsMode</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="k">else</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">matches</span></div>


<div class="viewcode-block" id="ProcessUser.addCleanupFunction"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.addCleanupFunction">[docs]</a>	<span class="k">def</span> <span class="nf">addCleanupFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ignoreErrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Registers a function that will be called as part of the `cleanup` of this object.</span>
<span class="sd">		</span>
<span class="sd">		Cleanup functions should have no arguments, and are invoked in reverse order with the most recently added first (LIFO), and</span>
<span class="sd">		before the automatic termination of any remaining processes associated with this object.</span>
<span class="sd">		</span>
<span class="sd">		Typical cleanup tasks are to cleanly shutdown processes (which is sometimes necessary to obtain code coverage </span>
<span class="sd">		information), and to (attempt to) delete large files/directories created by the test::</span>
<span class="sd">		</span>
<span class="sd">			self.addCleanupFunction(lambda: self.cleanlyShutdownMyProcess(params))</span>
<span class="sd">			self.addCleanupFunction(lambda: self.deleteDir(&#39;my-large-dir&#39;), ignoreErrors=True)</span>
<span class="sd">			self.addCleanupFunction(lambda: self.deleteFile(&#39;my-large-file.log&#39;), ignoreErrors=True)</span>
<span class="sd">		</span>
<span class="sd">		:param Callable[] fn: The cleanup function. </span>
<span class="sd">		:param bool ignoreErrors: By default, errors from cleanup functions will result in a test failure; set this to </span>
<span class="sd">			True to log them but not produce a test failure. This parameter was added in 1.6.0. </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ignoreErrors</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cleanupFunctions</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">__cleanupFunctions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">ignoreErrors</span><span class="p">)</span> <span class="p">)</span></div>


<div class="viewcode-block" id="ProcessUser.cleanup"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.cleanup">[docs]</a>	<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Tear down function that frees resources managed by this object, for example terminating processes it has </span>
<span class="sd">		started. </span>

<span class="sd">		Should be called exactly once by the owner of this object when is no longer needed. </span>
<span class="sd">		</span>
<span class="sd">		Do not override this method, instead use `addCleanupFunction`.</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1"># although we don&#39;t yet state this method is thread-safe, make it </span>
			<span class="c1"># as thread-safe as possible by using swap operations</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
				<span class="n">cleanupfunctions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cleanupFunctions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cleanupFunctions</span><span class="p">,</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="n">cleanupfunctions</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cleanup:&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ignoreErrors</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cleanupfunctions</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running registered cleanup function: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fn</span><span class="p">)</span>
					<span class="n">fn</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
					<span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span> <span class="k">if</span> <span class="n">ignoreErrors</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">)(</span><span class="s1">&#39;Error while running cleanup function</span><span class="si">%s</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="s1">&#39; (ignoreErrors=True)&#39;</span> <span class="k">if</span> <span class="n">ignoreErrors</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreErrors</span><span class="p">:</span>
						<span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Cleanup function failed: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
				<span class="n">processes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processList</span><span class="p">,</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">running</span><span class="p">():</span> <span class="n">process</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># this is pretty unlikely to fail, but we&#39;d like to know if it does</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;caught </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to stop process </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">processCount</span> <span class="o">=</span> <span class="p">{}</span>
			
			<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ProcessUser cleanup function done.&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Cleanup failed</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39; with </span><span class="si">%d</span><span class="s1"> errors&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">exceptions</span><span class="p">),</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exceptions</span><span class="p">)))</span></div>
		

<div class="viewcode-block" id="ProcessUser.addOutcome"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.addOutcome">[docs]</a>	<span class="k">def</span> <span class="nf">addOutcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">printReason</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callRecord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Add a validation outcome (and optionally a reason string) to the validation list.</span>
<span class="sd">		</span>
<span class="sd">		The method provides the ability to add a validation outcome to the internal data structure </span>
<span class="sd">		storing the list of validation outcomes. Multiple validations may be performed, the current</span>
<span class="sd">		supported validation outcomes of which are described in :ref:`assertions-and-outcomes`.</span>
<span class="sd">		</span>
<span class="sd">		The outcomes are considered to have a precedence order, as defined by the order of the outcomes listed</span>
<span class="sd">		above. Thus a C{pysys.constants.BLOCKED} outcome has a higher precedence than a C{pysys.constants.PASSED} </span>
<span class="sd">		outcome. The outcomes are defined in L{pysys.constants}. </span>
<span class="sd">		</span>
<span class="sd">		This method is thread-safe. </span>
<span class="sd">		</span>
<span class="sd">		Although this method exists on all subclasses of `pysys.process.user.ProcessUser`, in practice only </span>
<span class="sd">		`pysys.basetest.BaseTest` subclasses actually do anything with the resulting outcome. </span>
<span class="sd">		</span>
<span class="sd">		:param pysys.constants.Outcome outcome: The outcome to add, e.g. `pysys.constants.FAILED`.</span>
<span class="sd">		</span>
<span class="sd">		:param str outcomeReason: A string summarizing the reason for the outcome, </span>
<span class="sd">			for example &quot;Grep on x.log contains &#39;ERROR: server failed&#39;&quot;. </span>
<span class="sd">		</span>
<span class="sd">		:param bool printReason: If True the specified outcomeReason will be printed</span>
<span class="sd">		</span>
<span class="sd">		:param bool abortOnError: If true abort the test on any error outcome. This should usually be set to </span>
<span class="sd">			False for assertions, or the configured `self.defaultAbortOnError` setting (typically True) for </span>
<span class="sd">			operations that involve waiting. </span>
<span class="sd">		</span>
<span class="sd">		:param list[str] callRecord: An array of strings of the form path:lineno indicating the call stack that lead </span>
<span class="sd">			to this outcome. This will be appended to the log output for better test triage.</span>
<span class="sd">		</span>
<span class="sd">		:param bool override: Remove any existing test outcomes when adding this one, ensuring </span>
<span class="sd">			that this outcome is the one and only one reported even if an existing outcome </span>
<span class="sd">			has higher precedence. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">OUTCOMES</span><span class="p">,</span> <span class="n">outcome</span> <span class="c1"># ensure outcome type is known, and that numeric not string constant was specified! </span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">abortOnError</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">abortOnError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultAbortOnError</span>
			<span class="k">if</span> <span class="n">outcomeReason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">outcomeReason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
			<span class="k">else</span><span class="p">:</span> 
				<span class="k">if</span> <span class="n">PY2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outcomeReason</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
					<span class="c1"># The python2 logger is very unhappy about byte str objects containing </span>
					<span class="c1"># non-ascii characters (specifically it will fail to log them and dump a </span>
					<span class="c1"># traceback on stderr). Since it&#39;s pretty important that assertion </span>
					<span class="c1"># messages and test outcome reasons don&#39;t get swallowed, add a </span>
					<span class="c1"># workaround for this here. Not a problem in python 3. </span>
					<span class="n">outcomeReason</span> <span class="o">=</span> <span class="n">outcomeReason</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
				<span class="n">outcomeReason</span> <span class="o">=</span> <span class="n">stripANSIEscapeCodes</span><span class="p">(</span><span class="n">outcomeReason</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; ; &#39;</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="n">override</span><span class="p">:</span> 
				<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;addOutcome is removing existing outcome(s): </span><span class="si">%s</span><span class="s1"> with reason &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span><span class="p">)</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="p">[:]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">NOTVERIFIED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span><span class="p">):</span> <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>

			<span class="c1"># only bother populating the callrecord (which is a bit costly) when there&#39;s a failure</span>
			<span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">isFailure</span><span class="p">()</span> <span class="ow">and</span> <span class="n">callRecord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">callRecord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">()</span>
			
			<span class="k">def</span> <span class="nf">parseLocation</span><span class="p">(</span><span class="n">cr</span><span class="p">):</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span> <span class="ow">or</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cr</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
				<span class="k">return</span> <span class="n">cr</span><span class="p">[:</span><span class="n">cr</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)],</span> <span class="n">cr</span><span class="p">[</span><span class="n">cr</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

			<span class="c1">#store the reason of the highest precedent outcome</span>
			
			<span class="c1"># although we should print whatever is passed in, store a version with control characters stripped </span>
			<span class="c1"># out so that it&#39;s easier to read (e.g. coloring codes from third party tools)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;[</span><span class="se">\x00</span><span class="s1">-</span><span class="se">\x08\x0b\x0c\x0e</span><span class="s1">-</span><span class="se">\x1F</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">)</span>
				
				<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeLocation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
				<span class="k">if</span> <span class="n">callRecord</span><span class="p">:</span>
					
					<span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">parseLocation</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">callRecord</span><span class="p">]</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># if possible, try to prioritize locations under the testDir above shared framework classes</span>
						<span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span> <span class="k">if</span> <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">testDir</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="p">]</span>
						<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">parseLocation</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">callRecord</span><span class="p">]</span>
					<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">__outcomeLocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">fromLongPathSafe</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">isFailure</span><span class="p">()</span> <span class="ow">and</span> <span class="n">abortOnError</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">callRecord</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">callRecord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callRecord</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="n">callRecord</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">outcomeReason</span> <span class="ow">and</span> <span class="n">printReason</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">isFailure</span><span class="p">():</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> ... </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="sa">u</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="o">%</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
						<span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">parseLocation</span><span class="p">,</span><span class="n">callRecord</span><span class="p">))</span> <span class="k">if</span> <span class="n">callRecord</span><span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
							 <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> ... </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProcessUser.abort"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.abort">[docs]</a>	<span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="n">callRecord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Raise an AbortException with the specified outcome and reason.</span>
<span class="sd">		</span>
<span class="sd">		See also L{skipTest}. </span>

<span class="sd">		:param outcome: The outcome, which will override any existing outcomes previously recorded.</span>
<span class="sd">		:param outcomeReason: A string summarizing the reason for the outcome.</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">raise</span> <span class="n">AbortExecution</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="n">callRecord</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessUser.skipTest"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.skipTest">[docs]</a>	<span class="k">def</span> <span class="nf">skipTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="n">callRecord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Raise an AbortException that will set the test outcome to SKIPPED and </span>
<span class="sd">		ensure that the rest of the execute() and validate() methods do not execute. </span>
<span class="sd">		</span>
<span class="sd">		This is useful when a test should not be executed in the current mode or platform. </span>

<span class="sd">		:param outcomeReason: A string summarizing the reason the test is being skipped, for example</span>
<span class="sd">			&quot;Feature X is not supported on Windows&quot;. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">raise</span> <span class="n">AbortExecution</span><span class="p">(</span><span class="n">SKIPPED</span><span class="p">,</span> <span class="n">outcomeReason</span><span class="p">,</span> <span class="n">callRecord</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.getOutcome"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getOutcome">[docs]</a>	<span class="k">def</span> <span class="nf">getOutcome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Get the final outcome for this test, based on the precedence order defined in `pysys.constants.OUTCOMES`.</span>
<span class="sd">		</span>
<span class="sd">		To find out whether this test has failed::</span>
<span class="sd">		</span>
<span class="sd">			if self.getOutcome().isFailure():</span>
<span class="sd">				...</span>
<span class="sd">		</span>
<span class="sd">		:return pysys.constants.Outcome: The overall outcome. Use ``%s`` or ``str()`` to convert to a display name. </span>

<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">NOTVERIFIED</span>
			<span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">OUTCOMES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ProcessUser.getOutcomeReason"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getOutcomeReason">[docs]</a>	<span class="k">def</span> <span class="nf">getOutcomeReason</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Get the reason string for the current overall outcome (if specified).</span>
<span class="sd">				</span>
<span class="sd">		:return: The overall test outcome reason or &#39;&#39; if not specified</span>
<span class="sd">		:rtype:  string</span>

<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="n">fails</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">isFailure</span><span class="p">()])</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fails</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span> <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (+</span><span class="si">%d</span><span class="s1"> other failures)&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span><span class="p">,</span> <span class="n">fails</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__outcomeReason</span></div>

<div class="viewcode-block" id="ProcessUser.getOutcomeLocation"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getOutcomeLocation">[docs]</a>	<span class="k">def</span> <span class="nf">getOutcomeLocation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Get the location in the Python source file where this location was added. </span>
<span class="sd">		</span>
<span class="sd">		.. versionadded:: 1.6.0</span>
<span class="sd">		</span>
<span class="sd">		:return (str,str): The absolute filename, and the line number. Returns (None,None) if not known. </span>

<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__outcomeLocation</span></div>

<div class="viewcode-block" id="ProcessUser.getNextAvailableTCPPort"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getNextAvailableTCPPort">[docs]</a>	<span class="k">def</span> <span class="nf">getNextAvailableTCPPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hosts</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">],</span> <span class="n">socketAddressFamily</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Allocate a free TCP port which can be used for starting a server on this machine.</span>
<span class="sd">		</span>
<span class="sd">		The port is taken from the pool of available server (non-ephemeral) ports on this machine, and will not </span>
<span class="sd">		be available for use by any other code in the current PySys process until this object&#39;s `cleanup` method is </span>
<span class="sd">		called to return it to the pool of available ports. For advanced options such as port exclusions see </span>
<span class="sd">		`pysys.utils.allocport`. </span>

<span class="sd">		To allocate an IPv4 port for use only on this host::</span>
<span class="sd">		</span>
<span class="sd">			port = self.getNextAvailableTCPPort(hosts=[&#39;localhost&#39;])</span>

<span class="sd">		.. versionchanged:: 1.5.1</span>
<span class="sd">			Added hosts and socketAddressFamily parameters.</span>

<span class="sd">		:param list(Str) hosts: A list of the host names or IP addresses to check when establishing that a potential </span>
<span class="sd">			allocated port isn&#39;t already in use by a process outside the PySys framework. </span>
<span class="sd">			By default we check ``&quot;&quot;`` (which corresponds to ``INADDR_ANY`` and depending on the OS means </span>
<span class="sd">			either one or all non-localhost IPv4 addresses) and also ``localhost``. </span>
<span class="sd">			</span>
<span class="sd">			Many machines have multiple network cards each with its own host IP address, and typically you&#39;ll only be using </span>
<span class="sd">			one of them in your test, most commonly ``localhost``. If you do know which host/IP you&#39;ll actually be using, </span>
<span class="sd">			just specify that directly to save time, and avoid needlessly opening remote ports on hosts you&#39;re not using. </span>
<span class="sd">			A list of available host addresses can be found from </span>
<span class="sd">			``socket.getaddrinfo(&#39;&#39;, None)``.</span>

<span class="sd">		:param socketAddressFamily: The socket address family e.g. IPv4 vs IPv6. See Python&#39;s ``socket`` module for </span>
<span class="sd">			details. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">o</span> <span class="o">=</span> <span class="n">TCPPortOwner</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addCleanupFunction</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">cleanup</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">port</span></div>


	<span class="k">def</span> <span class="nf">__callRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieve a call record outside of this module, up to the execute or validate method of the test case.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">stack</span><span class="o">=</span><span class="p">[]</span>
		<span class="kn">from</span> <span class="nn">pysys.basetest</span> <span class="kn">import</span> <span class="n">BaseTest</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BaseTest</span><span class="p">):</span>
			<span class="n">testmodule</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">testDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span> <span class="o">!=</span> <span class="s1">&#39;PYTHONPATH&#39;</span> <span class="k">else</span> <span class="kc">None</span>
			<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">():</span>
				<span class="n">info</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__skipFrame</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ProcessUser</span><span class="p">)</span> <span class="p">):</span> <span class="k">continue</span>
				<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__skipFrame</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">BaseTest</span><span class="p">)</span> <span class="p">):</span> <span class="k">continue</span>
				<span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">info</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span> <span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">testmodule</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">testmodule</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">function</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">]):</span> <span class="k">return</span> <span class="n">stack</span>
		<span class="k">return</span> <span class="kc">None</span>


	<span class="k">def</span> <span class="nf">__skipFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">clazz</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Private method to check if a file is that for a particular class.</span>

<span class="sd">		:param file: The filepatch to check</span>
<span class="sd">		:param clazz: The class to check against</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">clazz</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="ProcessUser.grep"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.grep">[docs]</a>	<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the first occurrence of a regular expression in the specified file, or raises an exception if not found. </span>

<span class="sd">		See also `grepOrNone` and `grepAll` or no-error-on-missing and return-all behaviour. </span>

<span class="sd">		If you want to use a grep to set the outcome of the test, use `pysys.basetest.BaseTest.assertThatGrep` or </span>
<span class="sd">		`pysys.basetest.BaseTest.assertGrep` instead. The documentation for assertGrep also </span>
<span class="sd">		provides some helpful examples of regular expressions that could also be used with this method, and tips for </span>
<span class="sd">		escaping in regular expressions. </span>

<span class="sd">		If you have a complex expression with multiple values to extract, you can use ``(?P&lt;groupName&gt;...)`` named groups </span>
<span class="sd">		in which case a dictionary is returned providing access to the individual elements::</span>
<span class="sd">		</span>
<span class="sd">			authInfoDict = self.grep(&#39;myserver.log&#39;, expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot; in (?P&lt;authSecs&gt;[^ ]+) seconds\.&#39;))</span>

<span class="sd">		For extracting a single value you can use an unnamed group using ``(expr)`` syntax, in which case that group is returned::</span>

<span class="sd">			myKey = self.grep(&#39;test.txt&#39;, r&#39;myKey=&quot;(.*)&quot;&#39;) # on a file containing &#39;myKey=&quot;foobar&quot;&#39; would return &quot;foobar&quot;</span>

<span class="sd">		.. versionadded: 2.0</span>

<span class="sd">		:param str path: file to search (located in the output dir unless an absolute path is specified)</span>

<span class="sd">		:param str expr: the regular expression, optionally containing named groups. </span>
<span class="sd">		</span>
<span class="sd">			Remember to escape regular expression special characters such as ``.``, ``(``, ``[``, ``{`` and ``\`` if you want them to </span>
<span class="sd">			be treated as literal values. If you have a string with regex backslashes, it&#39;s best to use a &#39;raw&#39; </span>
<span class="sd">			Python string so that you don&#39;t need to double-escape them, e.g. ``expr=r&#39;function[(]&quot;str&quot;, 123[.]4, (\d+), .*[)]&#39;``.</span>

<span class="sd">		:param str encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>

<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0.</span>

<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>

<span class="sd">		:return: A str containing the matching expression, or if the expr contains any ``(?P&lt;groupName&gt;...)`` named groups </span>
<span class="sd">			a dict[str,str] is returned where the keys are the groupNames. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExprFromFile</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">returnAll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnNoneIfMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
			<span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.grepOrNone"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.grepOrNone">[docs]</a>	<span class="k">def</span> <span class="nf">grepOrNone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the first occurrence of a regular expression in the specified file, or None if not found. </span>

<span class="sd">		See also `grep` and `grepAll` for error-on-missing and return-all behaviour. </span>

<span class="sd">		If you want to use a grep to set the outcome of the test, use `pysys.basetest.BaseTest.assertThatGrep` or </span>
<span class="sd">		`pysys.basetest.BaseTest.assertGrep` instead. The documentation for assertGrep also </span>
<span class="sd">		provides some helpful examples of regular expressions that could also be used with this method, and tips for </span>
<span class="sd">		escaping in regular expressions. </span>

<span class="sd">		If you have a complex expression with multiple values to extract, you can use ``(?P&lt;groupName&gt;...)`` named groups </span>
<span class="sd">		in which case a dictionary is returned providing access to the individual elements::</span>
<span class="sd">		</span>
<span class="sd">			authInfoDict = self.grepOrNone(&#39;myserver.log&#39;, </span>
<span class="sd">					expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot; in (?P&lt;authSecs&gt;[^ ]+) seconds\.&#39;)</span>
<span class="sd">				) or {&#39;username&#39;:&#39;myuser&#39;, &#39;authSecs&#39;: &#39;0.0&#39;}</span>

<span class="sd">		For extracting a single value you can use an unnamed group using ``(expr)`` syntax, in which case that group is returned::</span>

<span class="sd">			myKey = self.grepOrNone(&#39;test.txt&#39;, r&#39;myKey=&quot;(.*)&quot;&#39;) or &#39;mydefault&#39; # on a file containing &#39;myKey=&quot;foobar&quot;&#39; would return &quot;foobar&quot;</span>

<span class="sd">		.. versionadded: 2.0</span>

<span class="sd">		:param str path: file to search (located in the output dir unless an absolute path is specified)</span>

<span class="sd">		:param str expr: the regular expression, optionally containing named groups. </span>
<span class="sd">		</span>
<span class="sd">			Remember to escape regular expression special characters such as ``.``, ``(``, ``[``, ``{`` and ``\`` if you want them to </span>
<span class="sd">			be treated as literal values. If you have a string with regex backslashes, it&#39;s best to use a &#39;raw&#39; </span>
<span class="sd">			Python string so that you don&#39;t need to double-escape them, e.g. ``expr=r&#39;function[(]&quot;str&quot;, 123[.]4, (\d+), .*[)]&#39;``.</span>

<span class="sd">		:param str encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>

<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0.</span>

<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>

<span class="sd">		:return: A str containing the matching expression, None if there are no matches, </span>
<span class="sd">			or if the expr contains any ``(?P&lt;groupName&gt;...)`` named groups </span>
<span class="sd">			a dict[str,str] is returned where the keys are the groupNames. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExprFromFile</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">returnAll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnNoneIfMissing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
			<span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.grepAll"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.grepAll">[docs]</a>	<span class="k">def</span> <span class="nf">grepAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a list of all the occurrences of a regular expression in the specified file. </span>

<span class="sd">		See also `grep` and `grepOrNone` for return-first-only behaviour. </span>

<span class="sd">		If you have a complex expression with multiple values to extract, you can use ``(?P&lt;groupName&gt;...)`` named groups </span>
<span class="sd">		in which case each item in the returned list is a dictionary is returned providing access to the individual elements::</span>
<span class="sd">		</span>
<span class="sd">			authInfoDictList = self.grepAll(&#39;myserver.log&#39;, expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot; in (?P&lt;authSecs&gt;[^ ]+) seconds\.&#39;))</span>

<span class="sd">		For extracting a single value you can use an unnamed group using ``(expr)`` syntax, in which case that group is returned::</span>

<span class="sd">			myKey = self.grepAll(&#39;test.txt&#39;, r&#39;myKey=&quot;(.*)&quot;&#39;) # on a file containing &#39;myKey=&quot;foobar&quot;&#39; would return [&quot;foobar&quot;]</span>

<span class="sd">		.. versionadded: 2.0</span>

<span class="sd">		:param str path: file to search (located in the output dir unless an absolute path is specified)</span>

<span class="sd">		:param str expr: the regular expression, optionally containing named groups. </span>
<span class="sd">		</span>
<span class="sd">			Remember to escape regular expression special characters such as ``.``, ``(``, ``[``, ``{`` and ``\`` if you want them to </span>
<span class="sd">			be treated as literal values. If you have a string with regex backslashes, it&#39;s best to use a &#39;raw&#39; </span>
<span class="sd">			Python string so that you don&#39;t need to double-escape them, e.g. ``expr=r&#39;function[(]&quot;str&quot;, 123[.]4, (\d+), .*[)]&#39;``.</span>

<span class="sd">		:param str encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>

<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0.</span>

<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>

<span class="sd">		:return: A list where each item is a str containing the matching expression, or if the expr contains any </span>
<span class="sd">			``(?P&lt;groupName&gt;...)`` named groups each item is a dict[str,str] where the keys are the groupNames. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExprFromFile</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">returnAll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnNoneIfMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
			<span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.getExprFromFile"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getExprFromFile">[docs]</a>	<span class="k">def</span> <span class="nf">getExprFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">returnAll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnNoneIfMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[]):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot; Searches for a regular expression in the specified file, and returns it. </span>
<span class="sd">		</span>
<span class="sd">		Use of this function is discouraged - consider using `grep` / `grepOrNone` / `grepAll` instead. </span>

<span class="sd">		If the regex contains unnamed groups using ``(expr)`` syntax, the specified group is returned. </span>
<span class="sd">		If the expression is not found, an exception is raised,</span>
<span class="sd">		unless returnAll=True or returnNoneIfMissing=True. For example::</span>

<span class="sd">			myKey = self.getExprFromFile(&#39;test.txt&#39;, r&#39;myKey=&quot;(.*)&quot;&#39;) # on a file containing &#39;myKey=&quot;foobar&quot;&#39; would return &quot;foobar&quot;</span>
<span class="sd">			err = self.getExprFromFile(&#39;test.txt&#39;, r&#39;ERROR .*&#39;) # on a file containing &#39;ERROR It went wrong&#39; would return &quot;that entire string&quot;</span>
<span class="sd">		</span>
<span class="sd">		If you have a complex expression with multiple values to extract, it is usually clearer to </span>
<span class="sd">		use ``(?P&lt;groupName&gt;...)`` named groups rather than unnamed groups referenced by index. This produces a </span>
<span class="sd">		dictionary::</span>
<span class="sd">		</span>
<span class="sd">			authInfo = self.getExprFromFile(&#39;myserver.log&#39;, expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot; in (?P&lt;authSecs&gt;[^ ]+) seconds\.&#39;))</span>

<span class="sd">			allAuthList = self.getExprFromFile(&#39;myserver.log&#39;, expr=r&#39;Successfully authenticated user &quot;(?P&lt;username&gt;[^&quot;]*)&quot; in (?P&lt;authSecs&gt;[^ ]+) seconds\.&#39;, returnAll=True))</span>

<span class="sd">		See also `pysys.basetest.BaseTest.assertThatGrep` which should be used when instead of just finding out what&#39;s </span>
<span class="sd">		in the file you want to assert that a specific expression is matched. The documentation for assertGrep also </span>
<span class="sd">		provides some helpful examples of regular expressions that could also be applied to this method, and tips for </span>
<span class="sd">		dealing with escaping in regular expressions. </span>

<span class="sd">		.. versionchanged:: 1.6.0</span>
<span class="sd">			Support for named groups was added in 1.6.0.</span>

<span class="sd">		:param str path: file to search (located in the output dir unless an absolute path is specified)</span>

<span class="sd">		:param str expr: the regular expression, optionally containing the regex group operator ``(...)``</span>
<span class="sd">		</span>
<span class="sd">			Remember to escape regular expression special characters such as ``.``, ``(``, ``[``, ``{`` and ``\`` if you want them to </span>
<span class="sd">			be treated as literal values. If you have a string with regex backslashes, it&#39;s best to use a &#39;raw&#39; </span>
<span class="sd">			Python string so that you don&#39;t need to double-escape them, e.g. ``expr=r&#39;function[(]&quot;str&quot;, 123[.]4, (\d+), .*[)]&#39;``.</span>

<span class="sd">		:param List[int] groups: which numeric regex group numbers (as indicated by brackets in the regex) should be returned; </span>
<span class="sd">			default is ``[1]`` meaning the first group. </span>
<span class="sd">			If more than one group is specified, the result will be a tuple of group values, otherwise the</span>
<span class="sd">			result will be the value of the group at the specified index as a str.</span>
<span class="sd">			This parameter is ignored if the regular expression contains any ``(?P&lt;groupName&gt;...)`` named groups. </span>

<span class="sd">		:param bool returnAll: returns a list containing all matching lines if True, the first matching line otherwise.</span>
<span class="sd">		:param bool returnNoneIfMissing: True to return None instead of raising an exception</span>
<span class="sd">			if the regex is not found in the file (not needed when returnAll is used). </span>
<span class="sd">			</span>
<span class="sd">		:param str encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>

<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0.</span>

<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>

<span class="sd">		:return: For a regular expression with one unnamed group, the match value is a str; </span>
<span class="sd">			if there are multiple unnamed numeric groups it is List[str] (with values corresponding to the groups= argument); </span>
<span class="sd">			if it contains any ``(?P&lt;groupName&gt;...)`` named groups a dict[str,str] is returned where the keys are the groupNames. </span>
<span class="sd">			</span>
<span class="sd">			If returnAll=True, the return value is a list of all the match values, with types as above. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">namedGroupsMode</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="n">compiled</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">)</span>
		<span class="n">namedGroupsMode</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">groupindex</span>
		
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;Cannot grep directory: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">path</span>

		<span class="k">with</span> <span class="n">openfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">applyMappers</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
			
				<span class="n">match</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span> <span class="k">continue</span>
				<span class="k">if</span> <span class="n">namedGroupsMode</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
				<span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">():</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
					
				<span class="k">if</span> <span class="n">returnAll</span><span class="p">:</span> 
					<span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span> 
					<span class="k">return</span> <span class="n">val</span>

		<span class="k">if</span> <span class="n">returnAll</span><span class="p">:</span> <span class="k">return</span> <span class="n">matches</span>
		<span class="k">if</span> <span class="n">returnNoneIfMissing</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># can happen due to race conditions in file system writing; maybe they need a waitForGrep</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find expression </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> because file is empty&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">quotestring</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
		<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find expression </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">quotestring</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span></div>


<div class="viewcode-block" id="ProcessUser.logFileContents"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.logFileContents">[docs]</a>	<span class="k">def</span> <span class="nf">logFileContents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxLines</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			<span class="n">logFunction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reFlags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stripWhitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[]):</span>
		<span class="sd">&quot;&quot;&quot; Logs some or all of the lines from the specified file.</span>
<span class="sd">		</span>
<span class="sd">		If the file does not exist or cannot be opened, does nothing. The method is useful for providing key</span>
<span class="sd">		diagnostic information (e.g. error messages from tools executed by the test) directly in run.log, or</span>
<span class="sd">		to make test failures easier to triage quickly. </span>

<span class="sd">		:param str path: May be an absolute, or relative to the test output directory.</span>
<span class="sd">		:param list[str] includes: Optional list of regex strings. If specified, only matches of these regexes will be logged.</span>
<span class="sd">		:param list[str] excludes: Optional list of regex strings. If specified, no line containing these will be logged.</span>
<span class="sd">		</span>
<span class="sd">			The variable ``self.logFileContentsDefaultExcludes`` (= ``[]`` by default) is used when this method </span>
<span class="sd">			is called with the default argument of ``excludes=None``, and can be used to provide a global set of </span>
<span class="sd">			default exclusion lines shared by all your tests, which is particularly useful if some processes always </span>
<span class="sd">			log some unimportant text to stderr (or stdout) that would be distracting to log out. </span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.6.0. </span>
<span class="sd">			</span>
<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be used to pre-process each </span>
<span class="sd">			line from the file (returning None if the line is to be filtered out). This provides a very powerful </span>
<span class="sd">			capability for filtering the file, for example `pysys.mappers.IncludeLinesBetween` </span>
<span class="sd">			provides the ability to filter in/out sections of a file. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>

<span class="sd">			Added in PySys 2.0. </span>

<span class="sd">		:param int maxLines: Upper limit on the number of lines from the file that will be logged. Set to zero for unlimited</span>
<span class="sd">		:param bool tail: Prints the _last_ &#39;maxLines&#39; in the file rather than the first &#39;maxLines&#39;.</span>
<span class="sd">		</span>
<span class="sd">		:param str encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>
<span class="sd">			</span>
<span class="sd">		:param Callable[[line],None] logFunction: The function that will be used to log individual lines from the file. </span>
<span class="sd">			Usually this is ``self.log.info(u&#39;  %s&#39;, line, extra=BaseLogFormatter.tag(LOG_FILE_CONTENTS))``	</span>
<span class="sd">			but a custom implementation can be provided, for example to provide a different color using </span>
<span class="sd">			`pysys.utils.logutils.BaseLogFormatter.tag`.</span>
<span class="sd">			</span>
<span class="sd">			Added in PySys 1.5.1. </span>
<span class="sd">			</span>
<span class="sd">		:param int reFlags: Zero or more flags controlling how the behaviour of regular expression matching, </span>
<span class="sd">			combined together using the ``|`` operator, for example ``reFlags=re.VERBOSE | re.IGNORECASE``. </span>
<span class="sd">			</span>
<span class="sd">			For details see the ``re`` module in the Python standard library. Note that ``re.MULTILINE`` cannot </span>
<span class="sd">			be used because expressions are matched against one line at a time. Added in PySys 1.5.1. </span>

<span class="sd">		:param bool stripWhitespace: By default blank lines are removed; set this to False to disable that behaviour. </span>
<span class="sd">			Added in PySys 2.0. </span>

<span class="sd">		:return: True if anything was logged, False if not.</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">excludes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">excludes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFileContentsDefaultExcludes</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
		<span class="n">actualpath</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1"># always open with a specific encoding not in bytes mode, since otherwise we can&#39;t reliably pass the read lines to the logger</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">openfile</span><span class="p">(</span><span class="n">actualpath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">actualpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">PREFERRED_ENCODING</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;logFileContents cannot open file &quot;</span><span class="si">%s</span><span class="s1">&quot;: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">actualpath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">False</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">def</span> <span class="nf">matchesany</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">regexes</span><span class="p">):</span>
				<span class="k">assert</span> <span class="ow">not</span> <span class="n">isstring</span><span class="p">(</span><span class="n">regexes</span><span class="p">),</span> <span class="s1">&#39;must be a list of strings not a string&#39;</span>
				<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regexes</span><span class="p">:</span>
					<span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">reFlags</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">None</span>
			
			<span class="n">tolog</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">applyMappers</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
			
				<span class="k">if</span> <span class="n">stripWhitespace</span><span class="p">:</span>
					<span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
				
				<span class="k">if</span> <span class="n">includes</span><span class="p">:</span>
					<span class="n">l</span> <span class="o">=</span> <span class="n">matchesany</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">includes</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span> <span class="k">continue</span>
				<span class="k">if</span> <span class="n">excludes</span> <span class="ow">and</span> <span class="n">matchesany</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">excludes</span><span class="p">):</span> <span class="k">continue</span>
				<span class="n">lineno</span> <span class="o">+=</span><span class="mi">1</span>
				<span class="n">tolog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">maxLines</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">tail</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tolog</span><span class="p">)</span> <span class="o">==</span> <span class="n">maxLines</span><span class="p">:</span>
						<span class="n">tolog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
						<span class="k">break</span>
					<span class="k">if</span> <span class="n">tail</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tolog</span><span class="p">)</span><span class="o">==</span><span class="n">maxLines</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">tolog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			
		<span class="k">if</span> <span class="ow">not</span> <span class="n">tolog</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>
		
		<span class="n">logextra</span> <span class="o">=</span> <span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_FILE_CONTENTS</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">logFunction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
			<span class="k">def</span> <span class="nf">logFunction</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">logextra</span><span class="p">)</span>

		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">):</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Contents of </span><span class="si">%s%s</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">fromLongPathSafe</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39; (filtered)&#39;</span> <span class="k">if</span> <span class="n">includes</span> <span class="ow">or</span> <span class="n">excludes</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">logextra</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tolog</span><span class="p">:</span>
			<span class="n">logFunction</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  -----&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">logextra</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">logextra</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ProcessUser.mkdir"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.mkdir">[docs]</a>	<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create a directory, with recursive creation of any parent directories.</span>
<span class="sd">		</span>
<span class="sd">		This function does nothing (does not raise an except) if the directory already exists. </span>
<span class="sd">		</span>
<span class="sd">		:param path: The path to be created. This can be an absolute path or </span>
<span class="sd">			relative to the testcase output directory.</span>
<span class="sd">		</span>
<span class="sd">		:return: the absolute path of the new directory, to facilitate fluent-style method calling. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">path</span></div>

	<span class="k">def</span> <span class="nf">deletedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteDir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ProcessUser.deleteDir"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.deleteDir">[docs]</a>	<span class="k">def</span> <span class="nf">deleteDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Recursively delete the specified directory. </span>
<span class="sd">		</span>
<span class="sd">		Does nothing if it does not exist. Raises an exception if the deletion fails. </span>
<span class="sd">		</span>
<span class="sd">		:param path: The path to be deleted. This can be an absolute path or </span>
<span class="sd">			relative to the testcase output directory.</span>
<span class="sd">		</span>
<span class="sd">		:param kwargs: Any additional arguments such as ``retries`` and ``ignore_errors`` are passed to </span>
<span class="sd">			L{pysys.utils.fileutils.deletedir()}. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">deletedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.deleteFile"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.deleteFile">[docs]</a>	<span class="k">def</span> <span class="nf">deleteFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Delete the specified file, with optional retries and ignoring of errors. </span>
<span class="sd">		</span>
<span class="sd">		Does nothing if it does not exist. Raises an exception if the deletion fails. </span>
<span class="sd">		</span>
<span class="sd">		:param path: The path to be deleted. This can be an absolute path or </span>
<span class="sd">			relative to the testcase output directory.</span>
<span class="sd">		</span>
<span class="sd">		:param kwargs: Any additional arguments such as ``retries`` and ``ignore_errors`` are passed to </span>
<span class="sd">			L{pysys.utils.fileutils.deletefile()}. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">deletefile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
		
<div class="viewcode-block" id="ProcessUser.getDefaultFileEncoding"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.getDefaultFileEncoding">[docs]</a>	<span class="k">def</span> <span class="nf">getDefaultFileEncoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">xargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Specifies what encoding should be used to read or write the specified </span>
<span class="sd">		text file.</span>
<span class="sd">		</span>
<span class="sd">		This method is used to select the appropriate encoding whenever PySys </span>
<span class="sd">		needs to open a file, for example to wait for a signal, for a </span>
<span class="sd">		file-based assertion, or to write a file with replacements. </span>
<span class="sd">		Many methods allow the encoding to be overridden for just that call, </span>
<span class="sd">		but getDefaultFileEncoding exists to allow global defaults to be specified </span>
<span class="sd">		based on the filename. </span>
<span class="sd">		</span>
<span class="sd">		For example, this method could be overridden to specify that utf-8 encoding </span>
<span class="sd">		is to be used for opening filenames ending in .xml, .json and .yaml. </span>
<span class="sd">		</span>
<span class="sd">		The default implementation of this method uses pysysproject.xml </span>
<span class="sd">		configuration rules such as::</span>
<span class="sd">		</span>
<span class="sd">			&lt;default-file-encoding pattern=&quot;*.xml&quot; encoding=&quot;utf-8&quot;/&gt;</span>
<span class="sd">		</span>
<span class="sd">		A return value of None indicates default behaviour, which is to </span>
<span class="sd">		use the default OS encoding, as specified by `pysys.constants.PREFERRED_ENCODING`. </span>
<span class="sd">		</span>
<span class="sd">		:param file: The filename to be read or written. This may be an </span>
<span class="sd">			absolute path or a relative path.</span>
<span class="sd">		 </span>
<span class="sd">		:param xargs: Ensure that an ``**xargs`` argument is specified so that </span>
<span class="sd">			additional information can be passed to this method in future releases. </span>
<span class="sd">		</span>
<span class="sd">		:return: The encoding to use for this file, or None if default behaviour is </span>
<span class="sd">			to be used. For example, ``utf-8`` or (for UTF-8 with a Byte Order Mark), ``utf-8-sig``. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># normalize slashes and ignore case</span>
		<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">defaultFileEncodings</span><span class="p">:</span>
			<span class="c1"># first match wins</span>
			<span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
				<span class="k">return</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
		<span class="k">return</span> <span class="kc">None</span></div>
	
<div class="viewcode-block" id="ProcessUser.compareVersions"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.compareVersions">[docs]</a>	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">compareVersions</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Compares two alphanumeric dotted version strings to see which is more recent. </span>
<span class="sd">		</span>
<span class="sd">		Example usage::</span>
<span class="sd">		</span>
<span class="sd">			if self.compareVersions(thisversion, &#39;1.2.alpha-3&#39;) &gt; 0:</span>
<span class="sd">				... # thisversion is newer than 1.2.alpha-3 </span>

<span class="sd">		The comparison algorithm ignores case, and normalizes separators ./-/_ </span>
<span class="sd">		so that ``&#39;1.alpha2&#39;==&#39;1Alpha2&#39;``. Any string components are compared </span>
<span class="sd">		lexicographically with other strings, and compared to numbers </span>
<span class="sd">		strings are always considered greater. </span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;10-alpha5.dev10&#39;, &#39;10alpha-5-dEv_10&#39;) == 0 # normalization of case and separators</span>
<span class="sd">		True</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(b&#39;1....alpha.2&#39;, u&#39;1Alpha2&#39;) == 0 # ascii byte and unicode strings both supported</span>
<span class="sd">		True</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1.2.0&#39;, &#39;1.2&#39;)</span>
<span class="sd">		0</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1.02&#39;, &#39;1.2&#39;)</span>
<span class="sd">		0</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser().compareVersions(&#39;1.2.3&#39;, &#39;1.2&#39;) &gt; 0</span>
<span class="sd">		True</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1.2&#39;, &#39;1.2.3&#39;)</span>
<span class="sd">		-1</span>
<span class="sd">		</span>
<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;10.2&#39;, &#39;1.2&#39;)</span>
<span class="sd">		1</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1.2.text&#39;, &#39;1.2.0&#39;) # letters are &gt; numbers</span>
<span class="sd">		1</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1.2.text&#39;, &#39;1.2&#39;) # letters are &gt; numbers </span>
<span class="sd">		1</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;10.2alpha1&#39;, &#39;10.2alpha&#39;)</span>
<span class="sd">		1</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;10.2dev&#39;, &#39;10.2alpha&#39;) # letters are compared lexicographically</span>
<span class="sd">		1</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;&#39;, &#39;&#39;)</span>
<span class="sd">		0</span>

<span class="sd">		&gt;&gt;&gt; ProcessUser.compareVersions(&#39;1&#39;, &#39;&#39;)</span>
<span class="sd">		1</span>

<span class="sd">		:param v1: A string containing a version number, with any number of components. </span>
<span class="sd">		:param v2: A string containing a version number, with any number of components. </span>

<span class="sd">		:return: an integer &gt; 0 if v1&gt;v2, </span>
<span class="sd">			an integer &lt; 0 if v1&lt;v2, </span>
<span class="sd">			or 0 if they are semantically the same.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">compareVersions</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProcessUser.write_text"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.write_text">[docs]</a>	<span class="k">def</span> <span class="nf">write_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Writes the specified characters to a file in the output directory. </span>
<span class="sd">		</span>
<span class="sd">		:param file: The path of the file to write, either an absolute path or </span>
<span class="sd">			relative to the `self.output` directory. </span>
<span class="sd">		</span>
<span class="sd">		:param text: The string to write to the file, with ``\n`` </span>
<span class="sd">			for newlines (do not use `os.linesep` as the file will be opened in </span>
<span class="sd">			text mode so platform line separators will be added automatically).</span>
<span class="sd">			</span>
<span class="sd">			This must be a character string. </span>
<span class="sd">		</span>
<span class="sd">		:param encoding: The encoding to use to open the file. </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>
<span class="sd">			</span>
<span class="sd">		:return str: Return the absolute path of the generated file. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># This method provides similar functionality to the Python3 pathlib write_text method. </span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">with</span> <span class="n">openfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">out</span></div>
	
<div class="viewcode-block" id="ProcessUser.disableLogging"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.disableLogging">[docs]</a>	<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
	<span class="k">def</span> <span class="nf">disableLogging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Temporarily stops logging for the current thread. </span>
<span class="sd">		</span>
<span class="sd">		For example::</span>
<span class="sd">		</span>
<span class="sd">			with self.disableLogging():</span>
<span class="sd">				self.startProcess(...)</span>
<span class="sd">		</span>
<span class="sd">		Note that this method will do nothing if the log level if pysys is run with ``-vDEBUG`` or ``-vdisabledLogging=DEBUG``. </span>
<span class="sd">			</span>
<span class="sd">		.. versionadded:: 1.6.0</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pysys.disabledLogging&#39;</span><span class="p">)</span>

		<span class="n">saved</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">initlogging</span><span class="o">.</span><span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">getLogHandlersForCurrentThread</span><span class="p">()</span> 

		<span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
			<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring disableLogging() request as debug logging is enabled&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">initlogging</span><span class="o">.</span><span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">([])</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">yield</span> <span class="kc">None</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">initlogging</span><span class="o">.</span><span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">(</span><span class="n">saved</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="ProcessUser.unpackArchive"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.unpackArchive">[docs]</a>	<span class="k">def</span> <span class="nf">unpackArchive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoCleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Unpacks the specified file(s) from an archive to a directory. Supports archive format such as zip/tar.gz/gz/tar.xz/xz. </span>
<span class="sd">		</span>
<span class="sd">		It is a good idea to store large textual Input/ assets (such as log files, which usually compress very well) </span>
<span class="sd">		as compressed archives to reduce disk space in your version control system. </span>
<span class="sd">		</span>
<span class="sd">		By default this method will automatically delete the extracted file/dir during test cleanup so it doesn&#39;t sit </span>
<span class="sd">		around on disk (or in CI uploaded failure archives) consuming space; if the file/dir is mutated by the test you </span>
<span class="sd">		may wish to disable this so you can manually inspect them by setting ``autoCleanup=False``. </span>

<span class="sd">		For example::</span>
<span class="sd">			</span>
<span class="sd">			unpacked = self.unpackArchive(&#39;mybigfile.log.xz&#39;)</span>
<span class="sd">			# do something with &quot;unpacked&quot;...</span>
<span class="sd">			</span>
<span class="sd">		Note that ``.xz`` (for single files) and ``.tar.xz`` (for multiple files) are recommended for optimal compression, and </span>
<span class="sd">		these (and ``.gz``) are *significantly* better than zip, which performs poorly when compressing </span>
<span class="sd">		multiple similar text files into one archive. Don&#39;t use more than one single archive per testcase (if possible) </span>
<span class="sd">		to ensure you benefit from similarities between the various files. </span>
<span class="sd">		</span>
<span class="sd">		Files are decompressed in binary mode, so if you require platform-native line endings you should use `copy` to </span>
<span class="sd">		post-process them after decompressing. </span>
<span class="sd">		</span>
<span class="sd">		:param str archive: The path of the archive to unpack, by default from the test input directory. Alternatively </span>
<span class="sd">			you could provide an absolute path using ``self.project.testRootDir`` or similar if an archive is shared across </span>
<span class="sd">			multiple test cases. </span>
<span class="sd">		:param str dest: The directory in which the contents of the archive will be written; by default this is the test </span>
<span class="sd">			output directory for archive types that are always single-file, and a subdirectory named after the archive if not. </span>
<span class="sd">			This dir will be created if needed. </span>
<span class="sd">		:param bool autoCleanup: Automatically deletes the unpackaged file/directory during test cleanup to save </span>
<span class="sd">			disk space (even if the test fails). </span>
<span class="sd">		</span>
<span class="sd">		:return: The full path to the decompressed file or directory. </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unpacking archive from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">or</span> <span class="s1">&#39;&lt;test output dir&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39; (with auto-delete during test cleanup)&#39;</span> <span class="k">if</span> <span class="n">autoCleanup</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
		<span class="n">archive</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span>
		
		<span class="n">archivebasename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
		
		<span class="k">if</span> <span class="s1">&#39;.tar.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">archivebasename</span><span class="p">:</span>
			<span class="c1"># shutil can&#39;t do individual non-tar&#39;d files</span>

			<span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;.xz&#39;</span><span class="p">,</span> <span class="s1">&#39;lzma&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)]:</span>
				<span class="k">if</span> <span class="n">archivebasename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
					<span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)])</span>
					<span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="c1"># some compression modules are not available on all systems, so only do this on demand</span>
					<span class="k">with</span> <span class="n">module</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">decompressed</span><span class="p">:</span>
						<span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">decompressed</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">autoCleanup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCleanupFunction</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteFile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">dest</span>
		
		<span class="c1"># don&#39;t unpack multiple files to the output dir directly as then we can&#39;t delete them</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)):</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive</span><span class="p">)[:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)])</span>
		<span class="k">if</span> <span class="n">autoCleanup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCleanupFunction</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteDir</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
		<span class="c1"># this takes care of multi-file archives such as tar.XXX/zip etc</span>
		<span class="n">shutil</span><span class="o">.</span><span class="n">unpack_archive</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="ProcessUser.copy"><a class="viewcode-back" href="../../../autodocgen/pysys.process.user.html#pysys.baserunner.ProcessUser.copy">[docs]</a>	<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="p">[],</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignoreIf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skipMappersIf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Copy a directory or a single text or binary file, optionally tranforming the contents by filtering each line through a list of mapping functions. </span>
<span class="sd">		</span>
<span class="sd">		If any `pysys.mappers` are provided, the file is copied in text mode and </span>
<span class="sd">		each mapper is given the chance to modify or omit each line, or even reorder the lines of the file. </span>
<span class="sd">		If no mappers are provided, the file is copied in binary mode. </span>

<span class="sd">		For example::</span>
<span class="sd">		</span>
<span class="sd">			self.copy(&#39;output-raw.txt&#39;, &#39;output-processed.txt&#39;, encoding=&#39;utf-8&#39;, </span>
<span class="sd">				mappers=[</span>
<span class="sd">					lambda line: None if (&#39;Timestamp: &#39; in line) else line, </span>
<span class="sd">					lambda line: line.replace(&#39;foo&#39;, &#39;bar&#39;), </span>
<span class="sd">					pysys.mappers.IncludeLinesBetween(&#39;Error message .*:&#39;, stopBefore=&#39;^$&#39;),</span>
<span class="sd">					pysys.mappers.RegexReplace(pysys.mappers.RegexReplace.DATETIME_REGEX, &#39;&lt;timestamp&gt;&#39;),</span>
<span class="sd">				])</span>
<span class="sd">		</span>

<span class="sd">		In addition to the file contents the attributes such as modification time and </span>
<span class="sd">		executable permission will be copied where possible. </span>
<span class="sd">		</span>
<span class="sd">		This function is useful for creating a modified version of an </span>
<span class="sd">		output file that&#39;s more suitable for later validation steps such as </span>
<span class="sd">		diff-ing, and also for copying required files from the input to the </span>
<span class="sd">		output directory. </span>
<span class="sd">		</span>
<span class="sd">		It can also be used for copying a whole directory, </span>
<span class="sd">		similar to ``shutil.copytree`` but with the advantages of support </span>
<span class="sd">		for long paths on Windows, better error safety, and that relative paths </span>
<span class="sd">		are evaluated relative to the self.output directory (which is both convenient, and </span>
<span class="sd">		safer than shutil&#39;s evaluation relative to the current working </span>
<span class="sd">		directory). </span>

<span class="sd">		For example::</span>
<span class="sd">		</span>
<span class="sd">			self.copy(&#39;src.txt&#39;, &#39;dest.txt&#39;)  # copies to outputdir/dest.txt</span>
<span class="sd">			self.copy(&#39;src.txt&#39;, self.output) # copies to outputdir/src.txt, since self.output is an existing directory</span>
<span class="sd">			self.copy(&#39;src.txt&#39;, &#39;foo/&#39;)      # copies to outputdir/foo/src.txt since destination ends with a slash</span>
<span class="sd">			self.copy(&#39;srcdirname&#39;, &#39;foo/&#39;)   # copies to outputdir/foo/srcdirname since destination ends with a slash</span>

<span class="sd">		For more information about pre-defined mappers, see `pysys.mappers`. Custom mappers can be specified as simple </span>
<span class="sd">		functions or lambdas, however for advanced use cases you can </span>
<span class="sd">		additionally provide ``mapper.fileStarted([self,] srcPath, destPath, srcFile, destFile)`` and/or  </span>
<span class="sd">		``mapper.fileFinished(...)`` methods to allow stateful operations, or to perform extra read/write operations </span>
<span class="sd">		before lines are read/written. For example::</span>
<span class="sd">		</span>
<span class="sd">			class CustomLineMapper(object):</span>
<span class="sd">				def fileStarted(self, srcPath, destPath, srcFile, destFile):</span>
<span class="sd">					self.src = os.path.basename(srcPath)</span>
<span class="sd">				</span>
<span class="sd">				def __call__(self, line):</span>
<span class="sd">					return &#39;&quot;&#39;+self.src+&#39;&quot;: &#39;+line</span>
<span class="sd">				</span>
<span class="sd">				def fileFinished(self, srcPath, destPath, srcFile, destFile):</span>
<span class="sd">					destFile.write(&#39;\n&#39; + &#39;footer added by CustomLineMapper&#39;)</span>
<span class="sd">			self.copy(&#39;src.txt&#39;, &#39;dest.txt&#39;, mappers=[CustomLineMapper()])</span>

<span class="sd">		.. versionchanged:: 1.6.0</span>
<span class="sd">			Ability to copy directories was added, along with the ``overwrite=``, ``symlinks=``, </span>
<span class="sd">			``ignoreIf=`` and ``skipMappersIf=`` arguments. </span>

<span class="sd">		:param str src: The source filename or directory, which can be an absolute path, or </span>
<span class="sd">			a path relative to the ``self.output`` directory. </span>
<span class="sd">			Use ``src=self.input+&#39;/myfile&#39;`` if you wish to copy a file from the test </span>
<span class="sd">			input directory. </span>
<span class="sd">		</span>
<span class="sd">		:param str dest: The destination file or directory name, which can be an absolute path, or </span>
<span class="sd">			a path relative to the `self.output` directory. Destination file(s) are overwritten if the </span>
<span class="sd">			dest already exists. </span>
<span class="sd">			</span>
<span class="sd">			The dest and src can be the same for file copies (but not directory copies). </span>
<span class="sd">			</span>
<span class="sd">			As a convenience to avoid repeating the same text in the src and destination, </span>
<span class="sd">			if the dest ends with a slash, or the src is a file and the dest is an existing directory, </span>
<span class="sd">			the dest is taken as a parent directory into which the src will be copied in retaining its current name. </span>
<span class="sd">			</span>
<span class="sd">			It is best to avoid copies where the src dir already contains the dest (which would be recursive) such as </span>
<span class="sd">			copying the test dir (possibly configured as ``self.input``) to destination ``self.output``, however if this </span>
<span class="sd">			is attempted PySys will log a warning and copy everything else except the recursive part. </span>
<span class="sd">		</span>
<span class="sd">		:param bool overwrite: If True, source files will be allowed to </span>
<span class="sd">			overwrite destination files, if False an exception will be raised if a destination file already exists. </span>
<span class="sd">			By default overwrite=None which means it&#39;s enabled for single file copy() but disabled for directory copies.</span>
<span class="sd">		</span>
<span class="sd">		:param List[callable[str]-&gt;str] mappers: A list of filter functions that will be applied, </span>
<span class="sd">			in order, to map each line from source to destination. Each function accepts a string for </span>
<span class="sd">			the current line as input and returns either a string to write or </span>
<span class="sd">			None if the line is to be omitted. Any ``None`` items in the mappers list will be ignored. </span>
<span class="sd">			Mappers must always preserve the final ``\n`` of each line (if present). </span>
<span class="sd">			</span>
<span class="sd">			See `pysys.mappers` for some useful predefined mappers such as `pysys.mappers.IncludeLinesBetween`, </span>
<span class="sd">			`pysys.mappers.RegexReplace` and `pysys.mappers.SortLines`. </span>
<span class="sd">			</span>
<span class="sd">			If present the ``mapper.fileStarted(...)`` and/or ``mapper.fileFinished(...)`` methods will be called on each </span>
<span class="sd">			mapper in the list at the start and end of each file; see above for an example. </span>
<span class="sd">			</span>
<span class="sd">			Do not share mapper instances across multiple tests or threads as this can cause race conditions. </span>
<span class="sd">			</span>
<span class="sd">		:param str encoding: The encoding to use to open the file (only used if mappers are provided; if not, it is </span>
<span class="sd">			opened in binary mode). </span>
<span class="sd">			The default value is None which indicates that the decision will be delegated </span>
<span class="sd">			to the L{getDefaultFileEncoding()} method. </span>
<span class="sd">		</span>
<span class="sd">		:param bool symlinks: Set to True if symbolic links in the source tree should be represented as symbolic </span>
<span class="sd">			links in the destination (rather than just being copied). </span>
<span class="sd">		</span>
<span class="sd">		:param callable[str]-&gt;bool ignoreIf: A callable that accepts a source path and returns True if </span>
<span class="sd">			this file/directory should be omitted from a directory copy. </span>
<span class="sd">			For example: ``ignoreIf=lambda src: src.endswith((&#39;.tmp&#39;, &#39;.log&#39;)))``</span>

<span class="sd">		:param callable[str]-&gt;bool skipMappersIf: A callable that accepts a source path and returns True if </span>
<span class="sd">			this file should be copied in binary mode (as if no mappers had been specified). </span>
<span class="sd">			For example: ``skipMappersIf=lambda src: not src.endswith((&#39;.xml&#39;, &#39;.properties&#39;)))``</span>
<span class="sd">		</span>
<span class="sd">		:return str: the absolute path of the destination file. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">origdest</span> <span class="o">=</span> <span class="n">dest</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
		<span class="n">srcIsDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
	
		<span class="n">dest</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">origdest</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">srcIsDir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dest</span><span class="p">)):</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">dest</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copying </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">dest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">srcIsDir</span><span class="p">:</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;__pysys_copy.tmp&#39;</span>
			<span class="n">renameDestAtEnd</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">renameDestAtEnd</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">assert</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;Source and destination directory cannot be the same&#39;</span>

		<span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">srcIsDir</span>

		<span class="k">if</span> <span class="n">srcIsDir</span><span class="p">:</span>
			<span class="n">destexists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">destexists</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
			<span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">as</span> <span class="n">iterator</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
					<span class="n">path</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">path</span>
					
					<span class="k">if</span> <span class="n">ignoreIf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ignoreIf</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
					<span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copy will ignore </span><span class="si">{</span><span class="n">dest</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">):]</span><span class="si">}</span><span class="s1"> while copying from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> to avoid recursive copy; it is best to avoid having a source path that is a parent dir of the destination&#39;</span><span class="p">)</span>
						<span class="k">continue</span>

					<span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">and</span> <span class="n">symlinks</span><span class="p">:</span>
						<span class="n">linkdest</span> <span class="o">=</span> <span class="n">dest</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
						<span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">linkdest</span><span class="p">)</span>
						<span class="n">shutil</span><span class="o">.</span><span class="n">copystat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">linkdest</span><span class="p">,</span> <span class="o">**</span><span class="p">({}</span> <span class="k">if</span> <span class="n">PY2</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;follow_symlinks&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}))</span>
						<span class="k">continue</span>
					
					<span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> 
						<span class="c1"># must pass all other arguments through</span>
						<span class="n">mappers</span><span class="o">=</span><span class="n">mappers</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="n">symlinks</span><span class="p">,</span> <span class="n">ignoreIf</span><span class="o">=</span><span class="n">ignoreIf</span><span class="p">,</span> <span class="n">skipMappersIf</span><span class="o">=</span><span class="n">skipMappersIf</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
				
			<span class="k">return</span> <span class="n">dest</span>

		<span class="k">if</span> <span class="n">skipMappersIf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skipMappersIf</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="n">mappers</span> <span class="o">=</span> <span class="kc">None</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;copy() will not overwrite an existing file unless overwrite=True: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">dest</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">mappers</span><span class="p">:</span>
			<span class="c1"># simple binary copy</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">mappers</span><span class="p">:</span> <span class="n">mappers</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappers</span> <span class="k">if</span> <span class="n">m</span><span class="p">]</span>
			
			<span class="k">with</span> <span class="n">openfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">src</span><span class="p">))</span> <span class="k">as</span> <span class="n">srcf</span><span class="p">:</span>
				<span class="k">with</span> <span class="n">openfile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span> <span class="k">as</span> <span class="n">destf</span><span class="p">:</span>
					<span class="c1"># give mappers a change to setup initial state and/or read/write from the source and dest files</span>
					<span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="n">mappers</span><span class="p">:</span>
						<span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="s1">&#39;fileStarted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">fn</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">srcf</span><span class="p">,</span> <span class="n">destf</span><span class="p">)</span>

					<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">applyMappers</span><span class="p">(</span><span class="n">srcf</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
						<span class="n">destf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

					<span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="n">mappers</span><span class="p">:</span>
						<span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="s1">&#39;fileFinished&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">fn</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">srcf</span><span class="p">,</span> <span class="n">destf</span><span class="p">)</span>

		<span class="n">shutil</span><span class="o">.</span><span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">renameDestAtEnd</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># pragma: no cover - work around windows file locking issues</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pollWait</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
				<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">src</span>
			
		<span class="k">return</span> <span class="n">dest</span></div></div>
		
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2006-2021 M.B. Grieve; documentation last updated on 2021-08-22

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>