

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysys.baserunner &mdash; PySys v2.1.dev1  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> PySys v2.1.dev1
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysys/BaseTest.html">The BaseTest Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysys/UserGuide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysys/ProjectConfiguration.html">Project Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysys/TestDescriptors.html">Test Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodocgen/pysys.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ChangeLog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PySys v2.1.dev1</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pysys.baserunner</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysys.baserunner</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># PySys System Test Framework, Copyright (C) 2006-2022 M.B. Grieve</span>

<span class="c1"># This library is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU Lesser General Public</span>
<span class="c1"># License as published by the Free Software Foundation; either</span>
<span class="c1"># version 2.1 of the License, or (at your option) any later version.</span>

<span class="c1"># This library is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1"># Lesser General Public License for more details.</span>

<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with this library; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The runner is responsible for orchestrating concurrent execution of the tests, and for setup/cleanup of </span>
<span class="sd">any resources that are shared across multiple tests.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">textwrap</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">locale</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">pysys</span>
<span class="kn">from</span> <span class="nn">pysys.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.utils.threadpool</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.utils.fileutils</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">deletedir</span><span class="p">,</span> <span class="n">toLongPathSafe</span><span class="p">,</span> <span class="n">fromLongPathSafe</span><span class="p">,</span> <span class="n">pathexists</span>
<span class="kn">from</span> <span class="nn">pysys.basetest</span> <span class="kn">import</span> <span class="n">BaseTest</span>
<span class="kn">from</span> <span class="nn">pysys.process.user</span> <span class="kn">import</span> <span class="n">ProcessUser</span>
<span class="kn">from</span> <span class="nn">pysys.utils.logutils</span> <span class="kn">import</span> <span class="n">BaseLogFormatter</span>
<span class="kn">from</span> <span class="nn">pysys.utils.pycompat</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.internal.initlogging</span> <span class="kn">import</span> <span class="n">_UnicodeSafeStreamWrapper</span><span class="p">,</span> <span class="n">pysysLogHandler</span>
<span class="kn">from</span> <span class="nn">pysys.writer</span> <span class="kn">import</span> <span class="n">ConsoleSummaryResultsWriter</span><span class="p">,</span> <span class="n">ConsoleProgressResultsWriter</span><span class="p">,</span> <span class="n">BaseSummaryResultsWriter</span><span class="p">,</span> <span class="n">BaseProgressResultsWriter</span><span class="p">,</span> <span class="n">ArtifactPublisher</span>
<span class="kn">import</span> <span class="nn">pysys.utils.allocport</span>

<span class="n">global_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> <span class="c1"># internal, do not use</span>

<div class="viewcode-block" id="BaseRunner"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner">[docs]</a><span class="k">class</span> <span class="nc">BaseRunner</span><span class="p">(</span><span class="n">ProcessUser</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;A single instance of the runner class is responsible for orchestrating </span>
<span class="sd">	concurrent execution of tests, and managing setup and cleanup of </span>
<span class="sd">	any resources that are shared across multiple testcases.</span>

<span class="sd">	Selection of the tests (and modes) to be run is performed through the ``pysys.py run`` launch script, which locates </span>
<span class="sd">	and creates a set of `pysys.config.descriptor.TestDescriptor` objects based on the command line arguments supplied by </span>
<span class="sd">	the user, and passes it to the runner. </span>
<span class="sd">	After executing any custom `setup` logic the runner&#39;s `start` method is responsible for iterating through the </span>
<span class="sd">	descriptor list and for each entry importing and creating an instance of the `BaseTest &lt;pysys.basetest.BaseTest&gt;` subclass </span>
<span class="sd">	named in the descriptor. The runner deletes the contents of the test output directory </span>
<span class="sd">	(to remove any output from previous runs) then calls the test&#39;s ``setup``, ``execute``, ``validate`` and ``cleanup`` </span>
<span class="sd">	methods. After each test is complete it performs cleanup of the output directory (removing all files but ``run.log`` </span>
<span class="sd">	if ``purge`` is enabled, or else just files that are empty), detects any core files produced by the test, and </span>
<span class="sd">	invokes any applicable `writers &lt;pysys.writer&gt;` to record the results of each test.</span>

<span class="sd">	In most cases the best way to provide runner (i.e. cross-test) shared functionality by creating one or more runner </span>
<span class="sd">	plugins rather than subclassing BaseRunner. </span>
<span class="sd">	Runner plugins provide functionality such as starting of servers and virtual machines to be shared by </span>
<span class="sd">	all tests (not created per-test, for which you&#39;d use a test plugin instead), or to execute extra logic when the </span>
<span class="sd">	runner is setup, and when it is cleaned up after all tests have completed. </span>
<span class="sd">	</span>
<span class="sd">	At minimum, a runner plugin is just a class with a setup method::</span>
<span class="sd">	</span>
<span class="sd">		def setup(self, runner):</span>
<span class="sd">			...  </span>
<span class="sd">			self.addCleanupFunction(...) # do this if you need to execute code after tests have completed</span>
<span class="sd">	</span>
<span class="sd">	... and no constructor (or at least no constructor arguments). </span>
<span class="sd">	Optionally it can have public methods and fields for use by testcases using </span>
<span class="sd">	``self.runner.&lt;plugin alias&gt;.XXX``, and for configuration it may have static fields for any plugin configuration </span>
<span class="sd">	properties. Static fields provides the default value (and hence the type) for each property, and then plugin.XXX is </span>
<span class="sd">	assigned the actual value before the plugin&#39;s setup method is called. In addition to plugin properties, </span>
<span class="sd">	``pysys run -Xkey=value`` command line overrides can be accessed using the runner&#39;s `getXArg()` method. </span>
<span class="sd">	</span>
<span class="sd">	Each runner plugin listed in the project configuration </span>
<span class="sd">	with ``&lt;runner-plugin classname=&quot;...&quot; alias=&quot;...&quot;/&gt;`` is instantiated once by the runner, and can be accessed using </span>
<span class="sd">	``self.&lt;alias&gt;`` on the runner object (if an alias is provided). If you are using a third party PySys runner </span>
<span class="sd">	plugin, consult the documentation for the third party test plugin class to find out what methods and fields are </span>
<span class="sd">	available using ``runner.&lt;alias&gt;.*``. </span>

<span class="sd">	Although plugins are the recommended way to extend the runner, if needed BaseRunner itself can be subclassed, </span>
<span class="sd">	for example:</span>
<span class="sd">	</span>
<span class="sd">		- override `setup()` if you need to provision resources </span>
<span class="sd">		  (e.g. virtual machines, servers, user accounts, populating a database, etc) that must be shared by many </span>
<span class="sd">		  testcases. The corresponding teardown should be implemented by calling `addCleanupFunction()`. </span>
<span class="sd">		- also override `setup()` if you want to customize the order or contents of the ``self.descriptors`` list of tests to </span>
<span class="sd">		  be run.</span>
<span class="sd">		- override `testComplete()` to customize how test output directories are cleaned up at the end of a test&#39;s </span>
<span class="sd">		  execution.</span>
<span class="sd">	</span>
<span class="sd">	Do not override the ``__init__`` constructor when creating a runner subclass; instead, add any initialization logic </span>
<span class="sd">	to your `setup()` method. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.outsubdir: The ``--outdir`` for this test run, which gives the directory to be used for the output of </span>
<span class="sd">		each testcase. Typically a relative path, but can also be an absolute path. The basename of this (outDirName) </span>
<span class="sd">		is often used as an identifier for the current test run. </span>

<span class="sd">	:ivar str ~.output: The full path of the output directory that this runner can use for storing global logs, </span>
<span class="sd">		persistent state for servers started in the runner `setup` method, and other data. </span>
<span class="sd">		</span>
<span class="sd">		By default the runner output directory is named based on the ``outsubdir`` and located either as a subdirectory </span>
<span class="sd">		of the testRootDir, or if under outsubdir (if it&#39;s an absolute path); it can also be overridden using the </span>
<span class="sd">		``pysysRunnerDirName`` project property. </span>
<span class="sd">		</span>
<span class="sd">		Writers and runner plugins (e.g. for code coverage reports) can either put their output under this ``output`` </span>
<span class="sd">		directory, or for increased prominence, add ``/..`` which will put their output directly under the testDirRoot </span>
<span class="sd">		(unless an absolute ``--outdir`` path is specified in which case it will go there instead).</span>
<span class="sd">		</span>
<span class="sd">		Unlike test directories, the runner output directory is not automatically created or cleaned between runs, so </span>
<span class="sd">		if this is required the runner should do it be calling `deleteDir()` and `mkdir()`. </span>
<span class="sd">	</span>
<span class="sd">	:ivar logging.Logger ~.log: The Python ``Logger`` instance that should be used to record progress and status </span>
<span class="sd">		information. </span>
<span class="sd">	</span>
<span class="sd">	:ivar dict[str,str] ~.runDetails: A dictionary of metadata about this test run that is included in performance</span>
<span class="sd">		summary reports and by some writers. </span>
<span class="sd">		</span>
<span class="sd">		The default contains a few standard values (currently these include ``outDirName``, ``hostname`` </span>
<span class="sd">		and ``startTime``), and additional items can be added by runner plugins - for example the build number of the </span>
<span class="sd">		application under test. </span>
<span class="sd">		</span>
<span class="sd">		Note that it is not permitted to try to change this dictionary after setup has completed. </span>
<span class="sd">	</span>
<span class="sd">	:ivar pysys.config.project.Project ~.project: A reference to the singleton project instance containing the </span>
<span class="sd">		configuration of this PySys test project as defined by ``pysysproject.xml``. </span>
<span class="sd">		The project can be used to access information such as the project properties which are shared across all tests </span>
<span class="sd">		(e.g. for hosts and credentials). </span>

<span class="sd">	:ivar bool ~.record: Indicates if the test results should be recorded by the record writer(s), due to </span>
<span class="sd">		the ``--record`` command line argument being specified.</span>
<span class="sd">	</span>
<span class="sd">	:ivar bool ~.purge: Indicates that all files other than ``run.log`` should be deleted from the output directory </span>
<span class="sd">		unless the test fails; this corresponds to the ``--purge`` command line argument. </span>

<span class="sd">	:ivar int ~.cycles: The total number of times each test should be cycled; this corresponds to the ``--cycle`` command line argument. </span>
<span class="sd">		(added in PySys v2.1). </span>
<span class="sd">	:ivar int ~.cycle: Old name, identical to ``cycles``. </span>

<span class="sd">	:ivar str ~.mode: No longer used. </span>

<span class="sd">	:ivar int ~.threads: The number of worker threads to execute the requested testcases.</span>

<span class="sd">	:ivar list[pysys.config.descriptor.TestDescriptor] ~.descriptors: A list of all the `pysys.config.descriptor.TestDescriptor` test </span>
<span class="sd">		descriptors that are selected for execution by the runner. </span>

<span class="sd">	:ivar dict(str,str|bool) ~.xargs: A dictionary of additional ``-Xkey=value`` user-defined arguments. These are also </span>
<span class="sd">		set as data attributes on the class (but with automatic conversion to match the default value&#39;s bool/int/float/list[str]  </span>
<span class="sd">		type if a static variable of the same name exists on the class), and for the benefit of other classes </span>
<span class="sd">		such as runner plugins and writers that might want to define their own -X options, see the `getXArg()` method. </span>

<span class="sd">	:ivar bool ~.validateOnly: True if the user has requested that instead of cleaning output directories and running </span>
<span class="sd">		each test, the validation for each test should be re-run on the previous output. </span>

<span class="sd">	:ivar float ~.startTime: The time when the test run started (in seconds since the epoch).</span>
<span class="sd">	</span>
<span class="sd">	:ivar list[object] ~.runnerPlugins: A list of any plugin instances configured for this runner. This allows plugins </span>
<span class="sd">		to access the functionality of other plugins if needed (for example looking them up by type in this list). </span>

<span class="sd">	:ivar pysys.baserunner.BaseRunner self.runner: Identical to self. Included so that you can write ``self.runner``</span>
<span class="sd">		to get a reference to the runner whether self is a BaseTest object or already a BaseRunner object.</span>

<span class="sd">	Additional variables that affect only the behaviour of a single method are documented in the associated method. </span>

<span class="sd">	There is also a field for any runner plugins that were configured with an &quot;alias&quot; (see above). </span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">purge</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">outsubdir</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">,</span> <span class="n">xargs</span><span class="p">):</span>
		<span class="c1"># we call this here so it&#39;s before any user code that should need to allocate ports, but after the </span>
		<span class="c1"># user&#39;s custom runner has been imported, making it possible to monkey-patch getEphemeralTCPPortRange() </span>
		<span class="c1"># if needed, e.g. for a new platform. </span>
		<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">allocport</span><span class="o">.</span><span class="n">initializePortPool</span><span class="p">()</span>

		<span class="n">ProcessUser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span>

		<span class="c1"># Set a sensible default output dir for the runner. Many projects do not actually write </span>
		<span class="c1"># any per-runner files so we do not create (or clean) this path automatically, it&#39;s up to </span>
		<span class="c1"># runner subclasses to do so if required. </span>
		<span class="n">runnerBaseName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;pysysRunnerDirName&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="s1">&#39;__pysys_runner.$</span><span class="si">{outDirName}</span><span class="s1">&#39;</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">outsubdir</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outsubdir</span><span class="p">,</span> <span class="n">runnerBaseName</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">runnerBaseName</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">record</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">purge</span> <span class="o">=</span> <span class="n">purge</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">cycle</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">=</span> <span class="n">outsubdir</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xargs</span> <span class="o">=</span> <span class="n">xargs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">validateOnly</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">supportMultipleModesPerRun</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;supportMultipleModesPerRun&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> 
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;The deprecated project property supportMultipleModesPerRun=false is no longer supported, please update your tests&#39;</span><span class="p">)</span>

		<span class="k">assert</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;Passing mode= to the runner is no longer supported&#39;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">__resultWritingLock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">__previousPerfResultKeys</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runnerErrors</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of strings</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">startTimestamp</span>
		
		<span class="n">extraOptions</span> <span class="o">=</span> <span class="n">xargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__extraRunnerOptions&#39;</span><span class="p">,</span> <span class="p">{})</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">setKeywordArgs</span><span class="p">(</span><span class="n">xargs</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span><span class="o">*</span><span class="n">cycle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running </span><span class="si">{numDescriptors:,}</span><span class="s1"> tests with </span><span class="si">{threads}</span><span class="s1"> threads using PySys </span><span class="si">{pysysVersion}</span><span class="s1"> in Python </span><span class="si">{pythonVersion}</span><span class="s1"> and encoding </span><span class="si">{encoding}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
			<span class="n">numDescriptors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="p">),</span> <span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">pysysVersion</span><span class="o">=</span><span class="n">pysys</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">pythonVersion</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="n">PREFERRED_ENCODING</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writers</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">summarywriters</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">progresswriters</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span> <span class="o">=</span> <span class="n">extraOptions</span><span class="p">[</span><span class="s1">&#39;printLogs&#39;</span><span class="p">]</span> <span class="c1"># None if not explicitly set; may be changed by writer.setup()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__printLogsDefault</span> <span class="o">=</span> <span class="n">extraOptions</span><span class="p">[</span><span class="s1">&#39;printLogsDefault&#39;</span><span class="p">]</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__randomlyShuffleTests</span> <span class="o">=</span> <span class="n">extraOptions</span><span class="p">[</span><span class="s1">&#39;sort&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;random&#39;</span>
		
		<span class="k">def</span> <span class="nf">initWriter</span><span class="p">(</span><span class="n">writerclass</span><span class="p">,</span> <span class="n">writerprops</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">writerclass</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># invoke writer&#39;s constructor</span>
			<span class="n">writer</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span>
			<span class="n">pluginAlias</span> <span class="o">=</span> <span class="n">writerprops</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

			<span class="n">writer</span><span class="o">.</span><span class="n">pluginProperties</span> <span class="o">=</span> <span class="n">writerprops</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">writerprops</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;isEnabled&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">writer</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">pluginAlias</span><span class="p">:</span> <span class="c1"># only set alias if enabled (tests could use the existence of the alias to check if it&#39;s enabled e.g. for code cov)</span>
				<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">):</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Alias &quot;</span><span class="si">%s</span><span class="s1">&quot; for writer conflicts with a field that already exists on this runner; please select a different name&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pluginAlias</span><span class="p">))</span>
				<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">writer</span>
			

		<span class="k">for</span> <span class="n">writerclass</span><span class="p">,</span> <span class="n">writerprops</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">initWriter</span><span class="p">(</span><span class="n">writerclass</span><span class="p">,</span> <span class="n">writerprops</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;logfile&#39;</span><span class="p">:</span><span class="n">writerprops</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)})</span>
			<span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
			
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">BaseSummaryResultsWriter</span><span class="p">):</span>
				<span class="n">summarywriters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">BaseProgressResultsWriter</span><span class="p">):</span>
				<span class="n">progresswriters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># assume everything else is a record result writer (for compatibility reasons)</span>
				<span class="c1"># add extra check on self.record for compatibility with old writers that </span>
				<span class="c1"># do not subclass the base writer and therefore would have bypassed </span>
				<span class="c1"># the above isEnabled() check</span>
				<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;isEnabled&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">:</span> 
					<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
		
		<span class="c1"># special-case this as for maximum usability we want it to run whenever the env var is set regardless of </span>
		<span class="c1"># whether someone thought to add it to their project or not</span>
		<span class="n">annotationsWriter</span> <span class="o">=</span> <span class="n">initWriter</span><span class="p">(</span><span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">ConsoleFailureAnnotationsWriter</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">if</span> <span class="n">annotationsWriter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotationsWriter</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">extraOptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;progressWritersEnabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">progresswriters</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">progresswriters</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initWriter</span><span class="p">(</span><span class="n">ConsoleProgressResultsWriter</span><span class="p">,</span> <span class="p">{}))</span>

		<span class="c1"># summary writers are always enabled regardless of record mode. They are executed last. </span>
		<span class="c1"># allow user to provide their own summary writer in the config, or if not, supply our own</span>
		<span class="k">if</span> <span class="n">summarywriters</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">summarywriters</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConsoleSummaryResultsWriter</span><span class="p">())</span>
		
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">collectTestOutput</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;outputDir&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;pythonCoverageDir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="k">continue</span> <span class="c1"># avoid creating a duplicate collector for this given it&#39;ll now be collected by the PythonCoverageWriter</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">initWriter</span><span class="p">(</span><span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">CollectTestOutputWriter</span><span class="p">,</span> <span class="p">{</span>
				<span class="s1">&#39;destDir&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;outputDir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@OUTDIR@&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">outDirName</span><span class="p">),</span>
				<span class="s1">&#39;fileIncludesRegex&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;.*[/</span><span class="se">\\</span><span class="s1">]&#39;</span><span class="o">+</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]),</span> <span class="c1"># convert fnmatch into a regex that can be used with .search()</span>
				<span class="s1">&#39;outputPattern&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;outputPattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@FILENAME@&#39;</span><span class="p">,</span> <span class="s1">&#39;@FILENAME@.@FILENAME_EXT@&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@OUTDIR@&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">outDirName</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
			<span class="p">})</span>
			<span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>

		<span class="c1"># also special-case setting this up using just project properties, since prior to 1.6.0 there was no separate writer</span>
		<span class="c1"># but only if pythonCoverageDir was explicitly configured in the project</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">PythonCoverageWriter</span><span class="p">)</span> <span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;pythonCoverageDir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
				<span class="n">writer</span> <span class="o">=</span> <span class="n">initWriter</span><span class="p">(</span><span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">PythonCoverageWriter</span><span class="p">,</span> <span class="p">{</span>
					<span class="s1">&#39;destDir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">pythonCoverageDir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@OUTDIR@&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">outDirName</span><span class="p">),</span>
					<span class="s1">&#39;pythonCoverageArgs&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;pythonCoverageArgs&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
				<span class="p">})</span>
				<span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">__artifactWriters</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ArtifactPublisher</span><span class="p">)]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__testOutputVisitorWriters</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">pysys</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">TestOutputVisitor</span><span class="p">)]</span>

		<span class="c1"># duration and results used to be used for printing summary info, now (in 1.3.0) replaced by </span>
		<span class="c1"># more extensible ConsoleSummaryResultsWriter implementation. Keeping these around for </span>
		<span class="c1"># a bit to allow overlap before removal</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># no longer needed</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># gets assigned to real value by start(), once runner constructors have all completed</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__pythonWarnings</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_configurePythonWarningsHandler</span><span class="p">()</span>
		
		<span class="c1"># (initially) undocumented hook for customizing which jobs the threadpool takes </span>
		<span class="c1"># off the queue and when. Standard implementation is a simple blocking queue. </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_testScheduler</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

		<span class="c1"># Only do wrapping if we&#39;re outputting to console (to avoid making life difficult for tools parsing the output </span>
		<span class="c1"># and because it&#39;s not very useful); remove 16chars which is how wide a typical </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_testHeaderWrap</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span> <span class="k">else</span> <span class="p">(</span> 
			<span class="nb">max</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="p">((</span><span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shutil</span><span class="p">,</span> <span class="s1">&#39;get_terminal_size&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;22:34:09 WARN  &#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;outDirName&#39;</span><span class="p">,</span> <span class="s1">&#39;hostname&#39;</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;cpuCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">threads</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;testThreads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

		<span class="c1"># escape windows \ chars (which does limit the expressive power, but is likely to be more helpful than not)</span>
		<span class="n">commitCmd</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;versionControlGetCommitCommand&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">))</span>
		<span class="kn">import</span> <span class="nn">subprocess</span>
		<span class="k">if</span> <span class="n">commitCmd</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">vcsProcess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">commitCmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">testRootDir</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
				<span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="n">vcsProcess</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
				<span class="n">stdoutdata</span> <span class="o">=</span> <span class="n">stdoutdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">PREFERRED_ENCODING</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
				<span class="n">stderrdata</span> <span class="o">=</span> <span class="n">stderrdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">PREFERRED_ENCODING</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">vcsProcess</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Process failed with </span><span class="si">%d</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vcsProcess</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">stderrdata</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">stdoutdata</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;&lt;no output&gt;&#39;</span><span class="p">))</span>
				
				<span class="n">commit</span> <span class="o">=</span> <span class="n">stdoutdata</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">commit</span> <span class="ow">and</span> <span class="n">commit</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;vcsCommit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No stdout output&#39;</span><span class="p">)</span>

			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed to get VCS commit using </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">commitCmd</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;xargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">[</span><span class="s1">&#39;startTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">))</span>
		
	<span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
		<span class="sd">&quot;&quot;&quot; Returns a human-readable and unique string representation of this runner object containing the runner class, </span>
<span class="sd">		suitable for diagnostic purposes and display to the test author. </span>
<span class="sd">		The format of this string may change without notice. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="c1"># there&#39;s usually only one base runner so class name is sufficient</span>

<div class="viewcode-block" id="BaseRunner.getXArg"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.getXArg">[docs]</a>	<span class="k">def</span> <span class="nf">getXArg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the value of a ``pysys run -Xkey=value`` argument, with conversion of the value to the required</span>
<span class="sd">		int/float/bool/list[str] type as needed (to match the type of the specified default value). The default value </span>
<span class="sd">		returned if no -X argument was provided for this key. </span>
<span class="sd">		</span>
<span class="sd">		This method is useful for reading the -X arguments defined by runner plugins or writers. </span>
<span class="sd">		</span>
<span class="sd">		.. versionadded:: 1.6.0</span>
<span class="sd">		</span>
<span class="sd">		:param str key: The name of the -X argument.</span>
<span class="sd">		:param bool/int/float/list[str]/str default: The default value to return if the argument was not set on the </span>
<span class="sd">			command line. </span>
<span class="sd">			The type of the default parameter will be used to convert the property value from a string if it is </span>
<span class="sd">			provided (for list[str], comma-separated input is assumed). </span>
<span class="sd">			An exception will be raised if the value is non-empty but cannot be converted to the indicated type. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">getTypedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span></div>

	<span class="c1"># methods to allow customer actions to be performed before a test run, after a test, after </span>
	<span class="c1"># a cycle of all tests, and after all cycles</span>
<div class="viewcode-block" id="BaseRunner.setup"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.setup">[docs]</a>	<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Setup method which may optionally be overridden to perform custom setup operations prior to execution of a set of testcases.</span>
<span class="sd">		</span>
<span class="sd">		All runner plugins will be setup and instantiated before this method is executed. </span>
<span class="sd">		</span>
<span class="sd">		Always ensure you call the super implementation of setup() before adding any custom logic, using</span>
<span class="sd">		``super().setup()``. </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">pass</span></div>


<div class="viewcode-block" id="BaseRunner.testComplete"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.testComplete">[docs]</a>	<span class="k">def</span> <span class="nf">testComplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testObj</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called after a testcase&#39;s completion (including finalization of the output and </span>
<span class="sd">		`pysys.basetest.BaseTest.cleanup`) to allow for post-completion tasks such as purging </span>
<span class="sd">		unwanted files from the output directory.</span>
<span class="sd">		</span>
<span class="sd">		The default implementation removes all files with a zero file length in order to </span>
<span class="sd">		only include files with content of interest. Should ``self.purge`` be ``True``, the purging will remove</span>
<span class="sd">		all files (excluding the run.log) on a ``PASSED`` outcome of the testcase in order to reduce the </span>
<span class="sd">		on-disk memory footprint when running a large number of tests. </span>

<span class="sd">		See also `isPurgableFile` which can be used to customize how this method performs purging. </span>
<span class="sd">		</span>
<span class="sd">		If you override this method, be sure to call the BaseRunner&#39;s implementation afterwards inside a</span>
<span class="sd">		``try...finally`` block. Do not put logic which could change the test outcome into this method; instead, </span>
<span class="sd">		use `pysys.basetest.BaseTest.cleanup` for anything which might affect the outcome. </span>
<span class="sd">		</span>
<span class="sd">		This method is always invoked from a single thread, even in multi-threaded mode. </span>
<span class="sd">		</span>
<span class="sd">		:param testObj: Reference to the `pysys.basetest.BaseTest` instance of the test just completed.</span>
<span class="sd">		:param dir: The absolute path of the test output directory to perform the purge on (testObj.output).</span>
<span class="sd">				</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge</span><span class="p">:</span>
			<span class="n">removeNonZero</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">testObj</span><span class="o">.</span><span class="n">outcome</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">outcome</span> <span class="o">!=</span> <span class="n">PASSED</span><span class="p">:</span>
					<span class="n">removeNonZero</span> <span class="o">=</span> <span class="kc">False</span>
					<span class="k">break</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">removeNonZero</span> <span class="o">=</span> <span class="kc">False</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="nb">dir</span><span class="p">)),</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
				<span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
					<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

					<span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># for efficiency, ignore zero byte files</span>
							<span class="k">for</span> <span class="n">visitor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testOutputVisitorWriters</span><span class="p">:</span>
								<span class="k">if</span> <span class="n">visitor</span><span class="o">.</span><span class="n">visitTestOutputFile</span><span class="p">(</span><span class="n">testObj</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># don&#39;t invoke remaining visitors if this one dealt with it</span>
						
					<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
						<span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="c1"># shouldn&#39;t happen given the above exists check; the rest of this error handler assumes a problem wiuth the visitor/collection</span>
						
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to collect test output file </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_collectErrorAlreadyReported&#39;</span><span class="p">):</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">runnerErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to collect test output from test </span><span class="si">%s</span><span class="s1"> (and maybe others): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">testObj</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">_collectErrorAlreadyReported</span> <span class="o">=</span> <span class="kc">True</span>
					
					<span class="c1"># Now proceed with cleaning files</span>
			
					<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">removeNonZero</span> <span class="ow">and</span> <span class="s1">&#39;run.log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPurgableFile</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
						<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
							<span class="k">try</span><span class="p">:</span>
								<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
								<span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
								<span class="k">break</span>
							<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">break</span>
								<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
								<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
								
				<span class="c1"># always try to delete empty directories (just as we do for empty files); </span>
				<span class="c1"># until we have some kind of internal option for disabling this for debugging </span>
				<span class="c1"># purpose only delete dirs when we&#39;ve just deleted the contents ourselves </span>
				<span class="k">if</span> <span class="n">removeNonZero</span> <span class="ow">or</span> <span class="p">(</span><span class="n">deleted</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">deleted</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)):</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
					<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
						<span class="c1"># there might be non-empty subdirectories, so don&#39;t raise this as an error</span>
						<span class="k">pass</span>
						

		<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Caught OSError while cleaning output directory after test completed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Output directory may not be completely clean&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseRunner.isPurgableFile"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.isPurgableFile">[docs]</a>	<span class="k">def</span> <span class="nf">isPurgableFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Decides if the specified non-empty file should be purged (deleted) after a test passes when </span>
<span class="sd">		``--purge`` is enabled.</span>

<span class="sd">		By default this will return True, meaning that all files (other than the special case of run.log) </span>
<span class="sd">		will be purged.</span>

<span class="sd">		This method is called by `testComplete` to provide runners with the ability to veto</span>
<span class="sd">		deletion of non-empty files that should always be left in a test&#39;s output directory</span>
<span class="sd">		even when the test has passed, by returning False from this method. </span>
<span class="sd">		</span>
<span class="sd">		Usually it is best to avoid customizing this method and instead use the ``collect-test-output`` project option </span>
<span class="sd">		to collect any required files (e.g code coverage, performance graphs etc), as collection happens before purging. </span>
<span class="sd">		</span>
<span class="sd">		:param str path: The absolute path of the file to be purged. </span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseRunner.cycleComplete"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.cycleComplete">[docs]</a>	<span class="k">def</span> <span class="nf">cycleComplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Cycle complete method which can optionally be overridden to perform </span>
<span class="sd">		custom operations between the repeated execution of a set of testcases.</span>
<span class="sd">		</span>
<span class="sd">		The default implementation of this method does nothing. Note that providing </span>
<span class="sd">		an override for this method will result in disabling concurrent test </span>
<span class="sd">		execution across multiple cycles. </span>
<span class="sd">		</span>
<span class="sd">		.. warning:: This method is deprecated and overriding it is strongly discouraged as that disables </span>
<span class="sd">			concurrent test execution across cycles. Instead, cleanup should be </span>
<span class="sd">			performed using either `pysys.basetest.BaseTest.cleanup` or `testComplete`.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">pass</span></div>


	<span class="c1"># perform a test run</span>
<div class="viewcode-block" id="BaseRunner.start"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.start">[docs]</a>	<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">printSummary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Starts the execution of a set of testcases.</span>
<span class="sd">		</span>
<span class="sd">		Do not override this method - instead, override ``setup`` and/or call ``addCleanupFunction`` to customize the behaviour </span>
<span class="sd">		of this runner. </span>
<span class="sd">		</span>
<span class="sd">		The start method is the main method for executing the set of requested testcases. The set of testcases </span>
<span class="sd">		are executed a number of times determined by the C{self.cycle} attribute. When executing a testcase </span>
<span class="sd">		all output from the execution is saved in the testcase output subdirectory; should C{self.cycle} be </span>
<span class="sd">		set to more than 1, the output subdirectory is further split into cycle[n] directories to sandbox the </span>
<span class="sd">		output from each iteration.</span>
<span class="sd">		</span>
<span class="sd">		:param printSummary: Ignored, exists only for compatibility reasons. To provide a custom summary printing </span>
<span class="sd">			implementation, specify a BaseSummaryResultsWriter subclass in the &lt;writers&gt; section of your project XML file. </span>

<span class="sd">		:return: Use of this value is deprecated as of 1.3.0. This method returns a dictionary of testcase outcomes, and</span>
<span class="sd">			for compatibility reasons this will continue in the short term, but will be removed in a future release. Please</span>
<span class="sd">			ignore the return value of start() and use a custom BaseSummaryResultsWriter if you need to customize summarization of</span>
<span class="sd">			results.</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">perfReporterConfig</span> <span class="c1"># should be at least one</span>
		
		<span class="c1"># must construct perf reporters here in start(), since if we did it in baserunner constructor, runner </span>
		<span class="c1"># might not be fully constructed yet</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">perfcls</span><span class="p">,</span> <span class="n">perfOptionsDict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">perfReporterConfig</span><span class="p">:</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">perfcls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">perfOptionsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summaryfile&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
			<span class="n">p</span><span class="o">.</span><span class="n">pluginProperties</span> <span class="o">=</span> <span class="n">perfOptionsDict</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">perfOptionsDict</span><span class="p">)</span>
			
			<span class="c1"># for backwards compat permit &quot;summaryfile&quot; as well as summaryFile</span>
			<span class="n">p</span><span class="o">.</span><span class="n">summaryfile</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">summaryfile</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;summaryFile&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">.</span><span class="n">summaryFile</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">summaryfile</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
				
		<span class="k">class</span> <span class="nc">PySysPrintRedirector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
			<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pysys.stdout&#39;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logWarning</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__origStdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
			<span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
			<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span> 
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logWarning</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logWarning</span> <span class="o">=</span> <span class="kc">False</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This test is printing to stdout; it is recommended to use self.log.info(...) (or the Python &quot;logging&quot; module) instead of print() within PySys tests: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()))</span>
				<span class="c1"># heuristic for coping with \n happening in a separate write to the message - ignore first newline after a non-newline</span>
				<span class="k">if</span> <span class="n">s</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span> 
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">binary_type</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">PREFERRED_ENCODING</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">s</span>
			<span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__origStdout</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;redirectPrintToLogger&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">PySysPrintRedirector</span><span class="p">()</span>

		<span class="c1"># before we setup the runner plugins, this is a good time to sanity-check aliases for the test plugins, since we don&#39;t want to start testing if this is wrong</span>
		<span class="n">testPluginAliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">pluginClass</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">pluginProperties</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">testPlugins</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">pluginAlias</span><span class="p">:</span> <span class="k">continue</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">BaseTest</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pluginAlias</span> <span class="ow">in</span> <span class="n">testPluginAliases</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Alias &quot;</span><span class="si">%s</span><span class="s1">&quot; for test-plugin conflicts with a field that already exists on BaseTest; please select a different name&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pluginAlias</span><span class="p">))</span>
			<span class="n">testPluginAliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pluginAlias</span><span class="p">)</span>

		<span class="c1"># call the hook to setup prior to running tests... but setup plugins first. </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runnerPlugins</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">pluginClass</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">pluginProperties</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">runnerPlugins</span><span class="p">:</span>
			<span class="n">plugin</span> <span class="o">=</span> <span class="n">pluginClass</span><span class="p">()</span> <span class="c1"># if this throws, its a fatal error and we shouldn&#39;t run any tests</span>
			<span class="n">plugin</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span>
			<span class="n">plugin</span><span class="o">.</span><span class="n">pluginProperties</span> <span class="o">=</span> <span class="n">pluginProperties</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">pluginProperties</span><span class="p">,</span> <span class="n">errorOnMissingVariables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">plugin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">runnerPlugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">pluginAlias</span><span class="p">:</span> <span class="k">continue</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">):</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Alias &quot;</span><span class="si">%s</span><span class="s1">&quot; for runner-plugin conflicts with a field that already exists on this runner; please select a different name&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pluginAlias</span><span class="p">))</span>
			<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
		
		<span class="c1"># see also constructor where we do the same aliasing for writers</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

		<span class="c1"># Now that setup() is done, no-one should be messing with global immutable state (better to not do it at all, but </span>
		<span class="c1"># definitely not after this point)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span> <span class="o">=</span> <span class="n">makeReadOnlyDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runDetails</span><span class="p">)</span>
		<span class="n">pysys</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEOUTS</span> <span class="o">=</span> <span class="n">makeReadOnlyDict</span><span class="p">(</span><span class="n">pysys</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEOUTS</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_initialEnviron</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_initialCwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

		<span class="c1"># call the hook to setup the test output writers</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__remainingTests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">):</span>
			<span class="k">try</span><span class="p">:</span> <span class="n">writer</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">numTests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="p">),</span> <span class="n">cycles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="n">xargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xargs</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> 
				<span class="n">testoutdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> setting up </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">raise</span> <span class="c1"># better to fail obviously than to stagger on, but fail to record/update the expected output files, which user might not notice</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__printLogsDefault</span> <span class="c1"># default value, unless overridden by cmdline or writer.setup</span>

		<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">:</span>
				<span class="n">p</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

		<span class="c1"># create the thread pool if running with more than one thread</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
			<span class="n">threadPool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">requests_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testScheduler</span><span class="p">)</span>

		<span class="c1"># loop through each cycle</span>
		
		<span class="n">fatalerrors</span> <span class="o">=</span> <span class="p">[]</span>
		
		<span class="c1"># by default we allow running tests from different cycles in parallel, </span>
		<span class="c1"># but if the user provided a runner with a cycleComplete that actually </span>
		<span class="c1"># does something then revert to pre-PySys 1.3.0 compatible behaviour and </span>
		<span class="c1"># join each cycle before starting the next, so we can invoke </span>
		<span class="c1"># cycleComplete reliably</span>
		<span class="n">concurrentcycles</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">cycleComplete</span> <span class="o">==</span> <span class="n">BaseRunner</span><span class="o">.</span><span class="n">cycleComplete</span>
	
		<span class="k">try</span><span class="p">:</span>

			<span class="c1"># for suppressing print-as-we-execute in single-threaded mode (at least until outcome is known)</span>
			<span class="n">singleThreadStdoutDisable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span><span class="o">!=</span><span class="n">PrintLogs</span><span class="o">.</span><span class="n">ALL</span>
			<span class="c1"># the setLogHandlersForCurrentThread invocation below assumes this</span>
			<span class="k">assert</span> <span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">getLogHandlersForCurrentThread</span><span class="p">()</span><span class="o">==</span><span class="p">[</span><span class="n">stdoutHandler</span><span class="p">]</span> 
				
			<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="p">):</span>
				<span class="c1"># loop through tests for the cycle</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">OUTCOMES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
			
					<span class="n">descriptors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__randomlyShuffleTests</span><span class="p">:</span> <span class="c1"># must re-shuffle within each cycle to be useful for perf testing etc</span>
						<span class="n">descriptors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
						<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
						
					<span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">:</span>
						<span class="n">container</span> <span class="o">=</span> <span class="n">TestContainer</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="n">request</span> <span class="o">=</span> <span class="n">WorkRequest</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">containerCallback</span><span class="p">,</span> <span class="n">exc_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">containerExceptionCallback</span><span class="p">)</span>
							<span class="n">threadPool</span><span class="o">.</span><span class="n">putRequest</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">singleThreadStdoutDisable</span><span class="p">:</span> <span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">([])</span>
							<span class="k">try</span><span class="p">:</span>
								<span class="n">singleThreadedResult</span> <span class="o">=</span> <span class="n">container</span><span class="p">()</span> <span class="c1"># run test</span>
							<span class="k">finally</span><span class="p">:</span>
								<span class="k">if</span> <span class="n">singleThreadStdoutDisable</span><span class="p">:</span> <span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">([</span><span class="n">stdoutHandler</span><span class="p">])</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">containerCallback</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span> <span class="n">singleThreadedResult</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
					<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt detected... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">()</span>
				
				<span class="k">if</span> <span class="ow">not</span> <span class="n">concurrentcycles</span><span class="p">:</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
						<span class="k">try</span><span class="p">:</span>
							<span class="n">threadPool</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
						<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
							<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt detected during multi-threaded test execution; waiting for running threads to terminate before beginning cleanup... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
							<span class="n">threadPool</span><span class="o">.</span><span class="n">dismissWorkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		
					<span class="c1"># call the hook for end of cycle if one has been provided</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">cycleComplete</span><span class="p">()</span>
					<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
						<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt detected while running cycleComplete... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">()</span>
					<span class="k">except</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			
			
			<span class="c1"># wait for the threads to complete if more than one thread	</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
				<span class="k">try</span><span class="p">:</span>
					<span class="c1"># this is the method that invokes containerCallback and containerExceptionCallback</span>
					<span class="n">threadPool</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test interrupt from keyboard - joining threads ... &quot;</span><span class="p">)</span>
					<span class="n">threadPool</span><span class="o">.</span><span class="n">dismissWorkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">threadPool</span><span class="o">.</span><span class="n">dismissWorkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

			<span class="c1"># perform clean on the performance reporters - before the writers, in case the writers want to do something </span>
			<span class="c1"># with the perf output</span>
			<span class="k">for</span> <span class="n">perfreporter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span> <span class="n">perfreporter</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
					<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
						<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> performing performance reporter cleanup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
						<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Caught exception performing performance reporter cleanup: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span> <span class="c1"># useful to have it on stderr too, esp during development</span>
						<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to cleanup performance reporter </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">perfreporter</span><span class="p">),</span> <span class="n">ex</span><span class="p">))</span>
			
			<span class="c1"># perform cleanup on the test writers - this also takes care of logging summary results</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resultWritingLock</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span> 
						<span class="n">writer</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
					<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Writer </span><span class="si">%s</span><span class="s2"> failed during cleanup - </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
						<span class="c1"># might stop results being completely displayed to user</span>
						<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Writer </span><span class="si">%s</span><span class="s1"> failed during cleanup: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">writer</span><span class="p">),</span> <span class="n">ex</span><span class="p">))</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[:]</span>
		
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">processCoverageData</span><span class="p">()</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> processing coverage data </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to process coverage data: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ex</span><span class="p">)</span>

		<span class="k">finally</span><span class="p">:</span>
			<span class="c1"># call the hook to cleanup after running tests</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> performing runner cleanup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to cleanup runner: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

		<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">allocport</span><span class="o">.</span><span class="n">logPortAllocationStats</span><span class="p">()</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pythonWarnings</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Python reported </span><span class="si">%d</span><span class="s1"> warnings during execution of tests; is is recommended to do a test run with -Werror and fix them if possible, or filter them out if not (see Python</span><span class="se">\&#39;</span><span class="s1">s warnings module for details)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pythonWarnings</span><span class="p">)</span>

		<span class="n">fatalerrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnerErrors</span><span class="o">+</span><span class="n">fatalerrors</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialEnviron</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;os.environ has changed while tests were running: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span>
					<span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialEnviron</span><span class="o">.</span><span class="n">items</span><span class="p">())],</span> 
					<span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">())],</span> 
					<span class="s1">&#39;original os.environ&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;changed to&#39;</span>
				<span class="p">)))</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;_ignoreEnvironChangeDuringTestExecution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># keep this undocumented as don&#39;t really want people using it; correct solution is to initialize libraries which change env vars during runner setup</span>
				<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Some test has changed the global os.environ of this PySys process; this is extremely unsafe while tests are running - environment changes are only permitted during runner setup&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialCwd</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">():</span>
			<span class="n">fatalerrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Some test has changed the working directory of this PySys process (e.g. with os.chdir()) to &quot;</span><span class="si">%s</span><span class="s1">&quot;; this is extremely unsafe while tests are running&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

		<span class="k">if</span> <span class="n">fatalerrors</span><span class="p">:</span>
			<span class="c1"># these are so serious we need to make sure the user notices by returning a failure exit code</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Test runner encountered fatal problems: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fatalerrors</span><span class="p">))</span>

		<span class="c1"># return the results dictionary</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span></div>

<div class="viewcode-block" id="BaseRunner.processCoverageData"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.processCoverageData">[docs]</a>	<span class="k">def</span> <span class="nf">processCoverageData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Called during cleanup after execution of all tests has completed to allow </span>
<span class="sd">		processing of coverage data (if enabled), for example generating </span>
<span class="sd">		reports etc. </span>
<span class="sd">		</span>
<span class="sd">		:deprecated: Instead of overriding this method, create a `pysys.writer.testoutput.CollectTestOutputWriter` subclass, </span>
<span class="sd">			and generate a coverage report in its cleanup method. </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">pass</span></div>

	<span class="k">def</span> <span class="nf">containerCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Callback method on completion of running a test.</span>

<span class="sd">		:meta private: Internal method</span>

<span class="sd">		Called on completion of running a testcase, either directly by the BaseRunner class (or </span>
<span class="sd">		a sub-class thereof), or from the ThreadPool.wait() when running with more than one worker thread. </span>
<span class="sd">		This method is always invoked from a single thread, even in multi-threaded mode. </span>

<span class="sd">		The method is responsible for calling of the testComplete() method of the runner, recording </span>
<span class="sd">		of the test result to the result writers, and for deletion of the test container object. </span>

<span class="sd">		:param thread: A reference to the calling thread (ignored in 1.3.0 onwards)</span>
<span class="sd">		:param container: A reference to the container object that ran the test</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Most of the logic lives in writeTestOutcome, this method just contains the bits that only make </span>
		<span class="c1"># sense if this is a &quot;standard&quot; test executed by our scheduler. Custom runners can use writeTestOutcome </span>
		<span class="c1"># to add additional test results (e.g. to expand out individual unit test results)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__remainingTests</span> <span class="o">-=</span> <span class="mi">1</span>
		
		<span class="k">assert</span> <span class="n">container</span><span class="o">.</span><span class="n">testObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Fatal error creating test object for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">container</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span> <span class="c1"># shouldn&#39;t happen unless something went very badly wrong</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reportTestOutcome</span><span class="p">(</span>
			<span class="n">testObj</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">testObj</span><span class="p">,</span>
			<span class="n">cycle</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span>
			<span class="n">testStart</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">testStart</span><span class="p">,</span>
			<span class="n">testDurationSecs</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">testTime</span><span class="p">,</span>
			<span class="n">runLogOutput</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">testFileHandlerStdoutBuffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
		
		<span class="c1"># prompt for continuation on control-C</span>
		<span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">()</span>
		
		<span class="c1"># call the hook for end of test execution</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testComplete</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">testObj</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">reportPerformanceResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testObj</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resultKey</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Reports a new performance number to the configured performance reporters. See `pysys.basetest.reportPerformanceResult` </span>
<span class="sd">		for details of the arguments. </span>
<span class="sd">		</span>
<span class="sd">		:meta private: Currently internal; may make this public in a future release if we decide it&#39;s useful.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">resultKey</span> <span class="o">=</span> <span class="n">resultKey</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
		
		<span class="c1"># check for correct format for result key</span>
		<span class="k">if</span> <span class="s1">&#39;  &#39;</span> <span class="ow">in</span> <span class="n">resultKey</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Invalid resultKey - contains double space &quot;  &quot;: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resultKey</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*\d</span><span class="si">{4}</span><span class="s1">[-/]\d</span><span class="si">{2}</span><span class="s1">[-/]\d</span><span class="si">{2}</span><span class="s1">\ \d</span><span class="si">{2}</span><span class="s1">[:/]\d</span><span class="si">{2}</span><span class="s1">[:/]\d</span><span class="si">{2}</span><span class="s1">.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resultKey</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
			<span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Invalid resultKey - contains what appears to be a date time - which would imply alteration of the result key in each run: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resultKey</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">resultKey</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Invalid resultKey - contains a new line: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resultKey</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">resultKey</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">resultKey</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">resultKey</span><span class="p">:</span> <span class="c1"># people do this without noticing sometimes</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid resultKey - contains unsubstituted </span><span class="si">% f</span><span class="s1">ormat string: &#39;</span><span class="o">+</span><span class="n">resultKey</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">isstring</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="s1">&#39;invalid type for performance result: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

		<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">])</span>

		<span class="c1"># Make sure user notices if they&#39;ve reused resultKeys illegally</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resultWritingLock</span><span class="p">:</span> <span class="c1"># reuse this lock for simplicity; perf writing doesn&#39;t happen very often anyway</span>
			<span class="n">prevresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__previousPerfResultKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resultKey</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;resultDetails&#39;</span><span class="p">])</span>
			<span class="n">d</span><span class="p">[</span><span class="s1">&#39;testId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">testObj</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span>
			<span class="k">if</span> <span class="n">prevresult</span><span class="p">:</span>
				<span class="n">previd</span><span class="p">,</span> <span class="n">prevcycle</span><span class="p">,</span> <span class="n">prevdetails</span> <span class="o">=</span> <span class="n">prevresult</span>
				<span class="c1"># if only difference is cycle (i.e. different testobj but same test id) then allow, but</span>
				<span class="c1"># make sure we report error if this test tries to report same key more than once, or if it</span>
				<span class="c1"># overlaps with another test&#39;s result keys</span>
				<span class="k">if</span> <span class="n">previd</span> <span class="o">==</span> <span class="n">testObj</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">prevcycle</span><span class="o">==</span><span class="n">testObj</span><span class="o">.</span><span class="n">testCycle</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
					<span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Cannot report performance result as resultKey was already used by this test: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">resultKey</span><span class="p">))</span>
					<span class="k">return</span>
				<span class="k">elif</span> <span class="n">previd</span> <span class="o">!=</span> <span class="n">testObj</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
					<span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Cannot report performance result as resultKey was already used - resultKey must be unique across all tests: &quot;</span><span class="si">%s</span><span class="s1">&quot; (already used by </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">resultKey</span><span class="p">,</span> <span class="n">previd</span><span class="p">))</span>
					<span class="k">return</span>
				<span class="k">elif</span> <span class="n">prevdetails</span> <span class="o">!=</span> <span class="n">d</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
					<span class="c1"># prevent different cycles of same test with different resultdetails </span>
					<span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Cannot report performance result as resultKey was already used by a different cycle of this test with different resultDetails - resultKey must be unique across all tests and modes: &quot;</span><span class="si">%s</span><span class="s1">&quot; (this test resultDetails: </span><span class="si">%s</span><span class="s1">; previous resultDetails: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">resultKey</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">prevdetails</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">))</span>
					<span class="k">return</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__previousPerfResultKeys</span><span class="p">[</span><span class="n">resultKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">testObj</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">testObj</span><span class="o">.</span><span class="n">testCycle</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">:</span> <span class="k">return</span>

		<span class="c1"># Use the unit aliases of the first performance reporter (to avoid the need to worry about syncing between different reporters)</span>
		<span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unitAliases</span><span class="p">:</span> <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unitAliases</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">pysys</span><span class="o">.</span><span class="n">perf</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">PerformanceUnit</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span><span class="o">.</span><span class="n">isFailure</span><span class="p">()</span> <span class="ow">and</span> <span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span> <span class="o">!=</span> <span class="n">BADPERF</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
			<span class="n">testObj</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Performance result &quot;</span><span class="si">%s</span><span class="s1">&quot; will not be recorded as test has failed so results could be invalid&#39;</span><span class="p">,</span> <span class="n">resultKey</span><span class="p">)</span>
			<span class="k">return</span>
		
		<span class="k">try</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">:</span>
				<span class="n">p</span><span class="o">.</span><span class="n">reportResult</span><span class="p">(</span><span class="n">testObj</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resultKey</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="c1"># Better to log it after any initialization messages from the reporters</span>
			<span class="n">testObj</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performance result: </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> 
				<span class="c1"># Use the first reporter to convert the values to a string, providing a mechanism to override the format if needed</span>
				<span class="n">resultKey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">performanceReporters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">valueToDisplayString</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">unit</span><span class="p">,</span>
			 <span class="s1">&#39;bigger is better&#39;</span> <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">biggerIsBetter</span> <span class="k">else</span> <span class="s1">&#39;smaller is better&#39;</span><span class="p">,</span>
					<span class="n">extra</span> <span class="o">=</span> <span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_PERFORMANCE</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

	<span class="k">def</span> <span class="nf">reportTestOutcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testObj</span><span class="p">,</span> <span class="n">testStart</span><span class="p">,</span> <span class="n">testDurationSecs</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">runLogOutput</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Records the result of a completed test, including notifying any configured writers, and writing the </span>
<span class="sd">		specified output to the console (if permitted by the `constants.PrintLogs` setting). </span>
<span class="sd">		</span>
<span class="sd">		It is not supported to override this method. </span>
<span class="sd">		</span>
<span class="sd">		This method is called at the end of each test&#39;s execution, but you can also call it (from any thread) </span>
<span class="sd">		to add additional test results that are not in this runner&#39;s set of descriptors, for example to </span>
<span class="sd">		expand out individual unit test results as if each had their own PySys test. </span>
<span class="sd">		</span>
<span class="sd">		:meta private: Currently internal; will make this public in a future release.</span>

<span class="sd">		:param pysys.basetest.BaseTest testObj: Reference to an instance of a L{pysys.basetest.BaseTest} class. </span>
<span class="sd">			The writer can extract data from this object but should not store a reference to it. </span>
<span class="sd">			The ``testObj.descriptor.id`` indicates the test that ran. </span>
<span class="sd">		:param int cycle: The cycle number. These start from 0, so please add 1 to this value before using. </span>
<span class="sd">		:param float testDurationSecs: Duration of the test in seconds as a floating point number. </span>
<span class="sd">		:param float testStart: The time when the test started. </span>
<span class="sd">		:param str runLogOutput: The logging output written to run.log, as a unicode character string. </span>
<span class="sd">		:param kwargs: Additional keyword arguments may be added in future releases. </span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">descriptor</span> <span class="o">=</span> <span class="n">testObj</span><span class="o">.</span><span class="n">descriptor</span>
		
		<span class="n">bufferedoutput</span> <span class="o">=</span> <span class="n">runLogOutput</span>

		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resultWritingLock</span><span class="p">:</span>
			<span class="c1"># print if we need to AND haven&#39;t already done so using single-threaded ALL print-as-we-go</span>
			<span class="k">if</span> <span class="n">runLogOutput</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span><span class="o">==</span><span class="n">PrintLogs</span><span class="o">.</span><span class="n">ALL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span><span class="o">==</span><span class="n">PrintLogs</span><span class="o">.</span><span class="n">FAILURES</span> <span class="ow">and</span> <span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span><span class="o">.</span><span class="n">isFailure</span><span class="p">())):</span> 
				<span class="k">try</span><span class="p">:</span>
					<span class="c1"># write out cached messages from the worker thread to stdout</span>
					<span class="c1"># (use the stdoutHandler stream which includes coloring redirections if applicable, </span>
					<span class="c1"># but not print redirection which we don&#39;t want; also includes the </span>
					<span class="c1"># appropriate _UnicodeSafeStreamWrapper). </span>
					<span class="n">stdoutHandler</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bufferedoutput</span><span class="p">)</span>
					
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
					<span class="c1"># first write a simple message without any unusual characters, in case nothing else can be printed</span>
					<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR - failed to write buffered test output for </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
					<span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to write buffered test output&#39;</span><span class="p">)</span>
					<span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to write buffered test output for </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="o">%</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
					
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printLogs</span> <span class="o">!=</span> <span class="n">PrintLogs</span><span class="o">.</span><span class="n">NONE</span> <span class="ow">and</span> <span class="n">stdoutHandler</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">:</span>
				<span class="c1"># print at least some information even if logging is turned down; </span>
				<span class="c1"># but if in PrintLogs.NONE mode truly do nothing, as there may be a CI writer doing a customized variant of this</span>
				<span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">(),</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
			
			<span class="c1"># pass the test object to the test writers if recording</span>
			<span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span> 
					<span class="n">writer</span><span class="o">.</span><span class="n">processResult</span><span class="p">(</span><span class="n">testObj</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">cycle</span><span class="p">,</span>
										  <span class="n">testStart</span><span class="o">=</span><span class="n">testStart</span><span class="p">,</span> <span class="n">testTime</span><span class="o">=</span><span class="n">testDurationSecs</span><span class="p">,</span> <span class="n">runLogOutput</span><span class="o">=</span><span class="n">bufferedoutput</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
					<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> processing </span><span class="si">%s</span><span class="s2"> test result by </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to record test result using writer </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">writer</span><span class="p">),</span> <span class="n">ex</span><span class="p">))</span>
			
			<span class="c1"># store the result</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">+</span> <span class="n">testDurationSecs</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">runnerErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Failed to process results from </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)))</span>


<div class="viewcode-block" id="BaseRunner.publishArtifact"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.publishArtifact">[docs]</a>	<span class="k">def</span> <span class="nf">publishArtifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Notifies any interested `pysys.writer.api.ArtifactPublisher` writers about an artifact that they may wish to publish.  </span>

<span class="sd">		Called when a file or directory artifact is published (e.g. by another writer).</span>
<span class="sd">		</span>
<span class="sd">		.. versionadded:: 1.6.0</span>
<span class="sd">		</span>
<span class="sd">		:param str path: Absolute path of the file or directory. Where possible it is often useful to include </span>
<span class="sd">			the ``outDirName`` in the filename, so that artifacts from multiple test runs/platforms do not clash. </span>
<span class="sd">		:param str category: A string identifying what kind of artifact this is, e.g. </span>
<span class="sd">			&quot;TestOutputArchive&quot; and &quot;TestOutputArchiveDir&quot; (from `pysys.writer.TestOutputArchiveWriter`) or </span>
<span class="sd">			&quot;CSVPerformanceReport&quot; (from `pysys.perf.reporters.CSVPerformanceReporter`). </span>
<span class="sd">			If you create your own category, be sure to add an org/company name prefix to avoid clashes.</span>
<span class="sd">			Use alphanumeric characters and underscores only. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;publishArtifact was called with category=</span><span class="si">%s</span><span class="s1">, path=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		
		<span class="k">assert</span> <span class="n">category</span><span class="p">,</span> <span class="s1">&#39;A category must be specified when publishing artifacts (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">path</span>

		<span class="n">badchars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\\</span><span class="s1">w_]+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span> 
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">badchars</span><span class="p">,</span> <span class="s1">&#39;Unsupported characters &quot;</span><span class="si">%s</span><span class="s1">&quot; found in category &quot;</span><span class="si">%s</span><span class="s1">&quot;; please use alphanumeric characters and underscore only&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">badchars</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
	
		<span class="n">catfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishArtifactCategoryIncludeRegex&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">catfilter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">catfilter</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
			<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not publishing artifact as category </span><span class="si">%s</span><span class="s1"> is filtered out by publishArtifactCategoryIncludeRegex&#39;</span><span class="o">%</span><span class="n">category</span><span class="p">)</span>
			<span class="k">return</span>

		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">fromLongPathSafe</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__artifactWriters</span><span class="p">:</span>
			<span class="n">a</span><span class="o">.</span><span class="n">publishArtifact</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">containerExceptionCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Callback method for unhandled exceptions thrown when running a test.</span>
<span class="sd">		</span>
<span class="sd">		:meta private: This method would need a better signature before being made public. </span>
<span class="sd">		</span>
<span class="sd">		:param exc_info: The tuple of values as created from sys.exc_info()</span>
<span class="sd">		 </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> from executing test container: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runnerErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;caught </span><span class="si">%s</span><span class="s2"> from executing test container: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<div class="viewcode-block" id="BaseRunner.handleKbrdInt"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.handleKbrdInt">[docs]</a>	<span class="k">def</span> <span class="nf">handleKbrdInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># pragma: no cover (can&#39;t auto-test keyboard interrupt handling)</span>
		<span class="sd">&quot;&quot;&quot;Handle a ``Ctrl+C`` keyboard exception caught during running of a set of testcases.</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remainingTests</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PYSYS_DISABLE_KBRD_INTERRUPT_PROMPT&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
			<span class="n">prompt</span> <span class="o">=</span> <span class="kc">False</span>
		
		<span class="k">def</span> <span class="nf">finish</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Performing runner cleanup after keyboard interrupt&#39;</span><span class="p">)</span>
			
			<span class="k">try</span><span class="p">:</span>
				<span class="c1"># perform cleanup on the test writers - this also takes care of logging summary results</span>
				<span class="c1"># this is a stipped down</span>
				<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resultWritingLock</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
						<span class="k">try</span><span class="p">:</span> 
							<span class="n">writer</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
						<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
							<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Writer </span><span class="si">%s</span><span class="s2"> failed during cleanup - </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[:]</span>
				
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">cycleComplete</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
					<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> cleaning up runner after interrupt: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupted detected during cleanup; will exit immediately&quot;</span><span class="p">)</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># keyboard interrupt</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">prompt</span><span class="p">:</span>
				<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Keyboard interrupt detected, exiting ... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">finish</span><span class="p">()</span>

			<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Keyboard interrupt detected, continue running remaining tests? [yes|no] ... &quot;</span><span class="p">)</span>
				<span class="n">line</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt detected; will try to continue running remaining tests&#39;</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
					<span class="n">finish</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">handleKbrdInt</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># don&#39;t prompt the second time</span></div>

<div class="viewcode-block" id="BaseRunner.logTestHeader"><a class="viewcode-back" href="../../autodocgen/pysys.baserunner.html#pysys.baserunner.BaseRunner.logTestHeader">[docs]</a>	<span class="k">def</span> <span class="nf">logTestHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Logs the header for the specified descriptor before a test begin to execute, </span>
<span class="sd">		typically including the testId, title and (if applicable) cycle. </span>
<span class="sd">		</span>
<span class="sd">		This method can be overridden if you wish to customize the information that is </span>
<span class="sd">		written to the run.log and console or how it is formatted. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;reserved for future use&#39;</span>
		
		<span class="n">wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testHeaderWrap</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Title: &#39;</span><span class="p">)</span>
		
		<span class="c1"># No need to make these fill the entire available width</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">62</span><span class="p">)</span>
		
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Id:    </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_DETAILS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

		<span class="n">badchars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]+&#39;</span><span class="o">%</span><span class="n">pysys</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">TEST_ID_CHARS</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">idWithoutMode</span><span class="p">)</span>
		<span class="c1"># encourage only underscores, but actually permit . and - too, for compatibility, matching what the launcher does</span>
		<span class="k">if</span> <span class="n">badchars</span><span class="p">:</span> 
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unsupported characters &quot;</span><span class="si">%s</span><span class="s1">&quot; found in test id &quot;</span><span class="si">%s</span><span class="s1">&quot; - please use alphanumeric characters, dot and underscore for test ids&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">)),</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">idWithoutMode</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">badchars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]+&#39;</span><span class="o">%</span><span class="n">pysys</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">MODE_CHARS</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">badchars</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unsupported characters &quot;</span><span class="si">%s</span><span class="s1">&quot; found in test mode &quot;</span><span class="si">%s</span><span class="s1">&quot; - please use just alphanumeric characters, dot, underscore and equals for modes&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">)),</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

		<span class="n">testDir</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">testDir</span>
		<span class="k">if</span> <span class="n">testDir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
			<span class="n">testDir</span> <span class="o">=</span> <span class="n">testDir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
			<span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">testDir</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">testDir</span><span class="p">:</span> <span class="c1"># only print if we&#39;re running from a higher level directory</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dir:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">testDir</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_DETAILS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

		<span class="n">title</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">title</span><span class="p">:</span>
			<span class="n">title</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">wrap</span><span class="p">)</span> <span class="k">if</span> <span class="n">wrap</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="n">title</span><span class="p">]</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Title: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_DETAILS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">title</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;       </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_DETAILS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># only log if this runner is doing multiple cycles</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cycle: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_DETAILS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Execution order hint: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">executionOrderHint</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">62</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span></div>
	
	<span class="k">def</span> <span class="nf">_configurePythonWarningsHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># By default python prints warnings to stderr which is very unhelpful for us</span>
		<span class="n">warningLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pysys.pythonwarnings&#39;</span><span class="p">)</span>
		<span class="k">def</span> <span class="nf">handlePythonWarning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__pythonWarnings</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="c1"># add a stack trace as otherwise it&#39;s not easy to see where in run.py the problem originated, as the </span>
			<span class="c1"># warning is usually logged from as shared base class</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()))</span>
			<span class="n">warningLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Python reported a warning: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
			
		<span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="n">handlePythonWarning</span></div>
		

<span class="k">class</span> <span class="nc">TestContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Internal class added to the work queue and used for co-ordinating the execution of a single test case.</span>
<span class="sd">	</span>
<span class="sd">	:meta private:</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">__purgedOutputDirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># static field</span>
	
	<span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">runner</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Create an instance of the TestContainer class.</span>
<span class="sd">		</span>
<span class="sd">		:param descriptor: A reference to the testcase descriptor</span>
<span class="sd">		:param cycle: The cycle number of the test</span>
<span class="sd">		:param runner: A reference to the runner that created this class</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testStart</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testTime</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testBuffer</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdoutBuffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span> <span class="c1"># unicode characters written to the output for this testcase</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cycle</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;.cycle</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
	
	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">__onDeleteOutputDirError</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">function</span><span class="o">==</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">:</span>
			<span class="c1"># Useful to tolerate this since people foten keep a cmd window/shell/tool open on test output directories, </span>
			<span class="c1"># and while we wouldn&#39;t want to leave files around, empty directories don&#39;t usually cause problems. </span>
			<span class="c1"># In rare cases where someone cares they could explicitly verify the directory doesn&#39;t exist at the start of </span>
			<span class="c1"># their run() method. </span>
			<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring failure to delete test output directory before running test: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">excinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># re-raise the original error</span>
	
	<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Over-ridden call builtin to allow the class instance to be called directly.</span>
<span class="sd">		</span>
<span class="sd">		Invoked by thread pool when using multiple worker threads.</span>

<span class="sd">		&quot;&quot;&quot;</span>		
		<span class="n">exc_info</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		
		<span class="n">defaultLogHandlersForCurrentThread</span> <span class="o">=</span> <span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">getLogHandlersForCurrentThread</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="c1"># stdout - set this up right at the very beginning to ensure we can see the log output in case any later step fails</span>
				<span class="c1"># here we use UnicodeSafeStreamWrapper to ensure we get a buffer of unicode characters (mixing chars+bytes leads to exceptions), </span>
				<span class="c1"># from any supported character (utf-8 being pretty much a superset of all encodings)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">_UnicodeSafeStreamWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdoutBuffer</span><span class="p">,</span> <span class="n">writebytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">stdoutHandler</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
				<span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">(</span><span class="n">defaultLogHandlersForCurrentThread</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span><span class="p">])</span>

				<span class="c1"># set the output subdirectory and purge contents; must be unique per mode (but not per cycle)</span>

				<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
					<span class="c1"># don&#39;t need to add mode to this path as it&#39;s already in the id</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">testDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">)</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">+=</span> <span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">mode</span>

				<span class="k">try</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">validateOnly</span><span class="p">:</span> 
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cycle</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> 
							<span class="n">deletedir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">TestContainer</span><span class="o">.</span><span class="n">__onDeleteOutputDirError</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="c1"># must use lock to avoid deleting the parent dir after we&#39;ve started creating outdirs for some cycles</span>
							<span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
								<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TestContainer</span><span class="o">.</span><span class="n">__purgedOutputDirs</span><span class="p">:</span>
									<span class="n">deletedir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">TestContainer</span><span class="o">.</span><span class="n">__onDeleteOutputDirError</span><span class="p">)</span>
									<span class="n">TestContainer</span><span class="o">.</span><span class="n">__purgedOutputDirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to clean test output directory before starting test: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ex</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cycle</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
					<span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="s1">&#39;cycle</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">)</span>
				<span class="n">initialOutputFiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">))</span>

				<span class="c1"># run.log handler</span>
				<span class="n">runLogEncoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">getDefaultFileEncoding</span><span class="p">(</span><span class="s1">&#39;run.log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">PREFERRED_ENCODING</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">_UnicodeSafeStreamWrapper</span><span class="p">(</span>
					<span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="s1">&#39;run.log&#39;</span><span class="p">)),</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">runLogEncoding</span><span class="p">),</span> 
					<span class="n">writebytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">runLogEncoding</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">runlog</span><span class="p">)</span>
				<span class="c1"># unlike stdout, we force the run.log to be _at least_ INFO level</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">stdoutHandler</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
				<span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">(</span><span class="n">defaultLogHandlersForCurrentThread</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerStdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="p">])</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">logTestHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="p">)</span>
				
				<span class="c1"># this often doesn&#39;t matter, but it&#39;s worth alerting the user as in rare cases it could cause a test failure</span>
				<span class="k">if</span> <span class="n">initialOutputFiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">validateOnly</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Some directories from a previous run could not be deleted from the output directory before starting this test: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initialOutputFiles</span><span class="p">))</span>
			<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">=</span> <span class="kc">True</span>
			
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
				<span class="n">exc_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
				
			<span class="n">logHandlers</span> <span class="o">=</span> <span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">getLogHandlersForCurrentThread</span><span class="p">()</span>
				
			<span class="c1"># import the test class</span>
			
			<span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
				<span class="n">BaseTest</span><span class="o">.</span><span class="n">_currentTestCycle</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cycle</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># backwards compatible way of passing cycle to BaseTest constructor; safe because of global_lock</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">outsubdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">:</span> <span class="c1"># get a shared test class from the sys.path</span>
						<span class="n">classname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">classname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
						<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">classname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Please specify a fully qualified classname (e.g. mymodule.classname): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">classname</span>
						<span class="n">module_name</span><span class="p">,</span> <span class="n">classname</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">classname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">classname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
						<span class="n">clazz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">),</span> <span class="n">classname</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
						<span class="n">runpypath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">testDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
						<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">runpypath</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">runpyfile</span><span class="p">:</span>
							<span class="n">runpycode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">runpyfile</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">runpypath</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
						<span class="n">runpy_namespace</span> <span class="o">=</span> <span class="p">{}</span>
						<span class="n">exec</span><span class="p">(</span><span class="n">runpycode</span><span class="p">,</span> <span class="n">runpy_namespace</span><span class="p">)</span>
						<span class="n">clazz</span> <span class="o">=</span> <span class="n">runpy_namespace</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">classname</span><span class="p">]</span>
						<span class="k">del</span> <span class="n">runpy_namespace</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span> <span class="o">=</span> <span class="n">clazz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">outsubdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">)</span>
					
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">testPlugins</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="k">for</span> <span class="n">pluginClass</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">pluginProperties</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">testPlugins</span><span class="p">:</span>
						<span class="n">plugin</span> <span class="o">=</span> <span class="n">pluginClass</span><span class="p">()</span>
						<span class="n">plugin</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span>
						<span class="n">plugin</span><span class="o">.</span><span class="n">pluginProperties</span> <span class="o">=</span> <span class="n">pluginProperties</span>
						<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">pluginProperties</span><span class="p">,</span> <span class="n">errorOnMissingVariables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
						<span class="n">plugin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="p">)</span>

						<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">testPlugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

						<span class="k">if</span> <span class="ow">not</span> <span class="n">pluginAlias</span><span class="p">:</span> <span class="k">continue</span>
						<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">):</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Alias &quot;</span><span class="si">%s</span><span class="s1">&quot; for test-plugin conflicts with a field that already exists on this test object; please select a different name&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pluginAlias</span><span class="p">))</span>
						<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="p">,</span> <span class="n">pluginAlias</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>

		
				<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">=</span> <span class="kc">True</span>
				
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
					<span class="n">exc_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
				
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="c1"># We need a BaseTest object, so if the real one failed, we assume/hope there should be no exception </span>
					<span class="c1"># from the PySys BaseTest class and we can use it to hold the error for reporting purposes</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span> <span class="o">=</span> <span class="n">BaseTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">)</span>
					
				<span class="c1"># can&#39;t set this in constructor without breaking compatibility, but set it asap after construction</span>
				<span class="k">del</span> <span class="n">BaseTest</span><span class="o">.</span><span class="n">_currentTestCycle</span>

			<span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span> 
					<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;processTestStarting&#39;</span><span class="p">):</span>
						<span class="n">writer</span><span class="o">.</span><span class="n">processTestStarting</span><span class="p">(</span><span class="n">testObj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
					<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> calling processTestStarting on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

			<span class="c1"># execute the test if we can</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">skippedReason</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">SKIPPED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">skippedReason</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				
				<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;runnable&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">SKIPPED</span><span class="p">,</span> <span class="s1">&#39;Not runnable&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
							
				<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Failed to set up test: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">exc_info</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> while setting up test </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
						
				<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;test interrupt from keyboard&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Test interrupt from keyboard&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			
				<span class="k">else</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">259</span> <span class="o">-</span> <span class="mi">40</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Test output directory is </span><span class="si">%d</span><span class="s1"> characters long; be careful of possible issues caused by the Windows 260-character MAX_PATH limit: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> 
							<span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">output</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
					
						<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">validateOnly</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
							<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;--- test execute&#39;</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
						<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;--- test validate&#39;</span><span class="p">)</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
						
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;goes here TODO&#39;</span><span class="p">):</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Test title is still TODO&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

					<span class="k">except</span> <span class="n">AbortExecution</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
						<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">outcome</span><span class="p">[:]</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callRecord</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">callRecord</span><span class="p">)</span>
						<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Aborted test due to </span><span class="si">%s</span><span class="s1"> outcome&#39;</span><span class="o">%</span><span class="n">e</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span> <span class="c1"># nb: this could be due to SKIPPED</span>

					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectCore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">DUMPEDCORE</span><span class="p">,</span> <span class="s1">&#39;Core detected in output subdirectory&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			
			<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Test interrupt from keyboard&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> occurred while running test - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

			<span class="c1"># call the cleanup method to tear down the test</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;--- test cleanup&#39;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
			
			<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">kbrdInt</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Test interrupt from keyboard&#39;</span><span class="p">,</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">UserError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> <span class="c1"># will already have been logged with stack trace</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> occurred while cleaning up test - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;Test cleanup failed: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">abortOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

			<span class="c1"># in case the thread log handlers got overwritten by a naughty test, restore before printing the final summary</span>
			<span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">(</span><span class="n">logHandlers</span><span class="p">)</span>
			
			<span class="c1"># the following checks are to give a clear and early indication of a serious cock-up</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_initialEnviron</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
			
				<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;os.environ has changed while this test was running: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span>
						<span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_initialEnviron</span><span class="o">.</span><span class="n">items</span><span class="p">())],</span> 
						<span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">())],</span> 
						<span class="s1">&#39;original os.environ&#39;</span><span class="p">,</span> 
						<span class="s1">&#39;changed to&#39;</span>
					<span class="p">)))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;_ignoreEnvironChangeDuringTestExecution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># keep this undocumented as don&#39;t really want people using it; correct solution is to initialize libraries which change env vars during runner setup</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;The global os.environ of this PySys process has changed while this test was running; this is extremely unsafe - environment changes are only permitted during runner setup&#39;</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="c1"># Can&#39;t reset _initialEnviron here (to make other tests pass) as it&#39;s possible the bug was not in this test but in some other test that&#39;s still executing, in which case we&#39;d allow it to pass</span>
				
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_initialCwd</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">addOutcome</span><span class="p">(</span><span class="n">BLOCKED</span><span class="p">,</span> <span class="s1">&#39;The working directory of this PySys process was changed to &quot;</span><span class="si">%s</span><span class="s1">&quot; while this test was running (os.chdir()); this is extremely unsafe&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

			<span class="c1"># print summary and close file handles</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">testTime</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">testStart</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test duration: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> secs&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">testTime</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_DEBUG</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test final outcome:  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcomeReason</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcome</span><span class="p">()</span> <span class="o">!=</span> <span class="n">PASSED</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test outcome reason: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testObj</span><span class="o">.</span><span class="n">getOutcomeReason</span><span class="p">(),</span> <span class="n">extra</span><span class="o">=</span><span class="n">BaseLogFormatter</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">LOG_TEST_OUTCOMES</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
			
			<span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">testFileHandlerRunLog</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> <span class="c1"># should never happen; serious enough to merit recording in both stderr and log</span>
			<span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Internal error while executing </span><span class="si">%s</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Internal error while executing </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
			<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">runnerErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Error executing test </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>

		<span class="k">finally</span><span class="p">:</span>
			<span class="n">pysysLogHandler</span><span class="o">.</span><span class="n">setLogHandlersForCurrentThread</span><span class="p">(</span><span class="n">defaultLogHandlersForCurrentThread</span><span class="p">)</span>

		<span class="c1"># return a reference to self</span>
		<span class="k">return</span> <span class="bp">self</span>
	
	<span class="k">def</span> <span class="nf">detectCore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Detect any core files in a directory (unix systems only), returning C{True} if a core is present.</span>
<span class="sd">		</span>
<span class="sd">		:param dir: The directory to search for core files</span>
<span class="sd">		:return: C{True} if a core detected, None if no core detected</span>
<span class="sd">		:rtype: integer </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="nb">dir</span><span class="p">)):</span>
				<span class="n">path</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MODE</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^core&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>

		<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught OSError in detectCore: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
			
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2006-2022 M.B. Grieve; documentation last updated on 2022-03-17

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>