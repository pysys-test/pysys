

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysys.config.descriptor &mdash; PySys v2.0.dev1  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> PySys v2.0.dev1
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/BaseTest.html">The BaseTest Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/UserGuide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/ProjectConfiguration.html">Project Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pysys/TestDescriptors.html">Test Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodocgen/pysys.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ChangeLog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySys v2.0.dev1</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pysys.config.descriptor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysys.config.descriptor</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># PySys System Test Framework, Copyright (C) 2006-2021 M.B. Grieve</span>

<span class="c1"># This library is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU Lesser General Public</span>
<span class="c1"># License as published by the Free Software Foundation; either</span>
<span class="c1"># version 2.1 of the License, or (at your option) any later version.</span>

<span class="c1"># This library is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1"># Lesser General Public License for more details.</span>

<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with this library; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The `TestDescriptor &lt;pysys.config.descriptor.TestDescriptor&gt;` class holds metadata for each testcase </span>
<span class="sd">(``pysystest.*``) or directory (``pysysdirconfig.xml``), and the `DescriptorLoader &lt;pysys.config.descriptor.DescriptorLoader&gt;` </span>
<span class="sd">class allows customization of the test discovery process. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">xml.dom.minidom</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="kn">import</span> <span class="nn">pysys</span>
<span class="kn">from</span> <span class="nn">pysys.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pysys.exceptions</span> <span class="kn">import</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">pysys.utils.fileutils</span> <span class="kn">import</span> <span class="n">toLongPathSafe</span><span class="p">,</span> <span class="n">fromLongPathSafe</span><span class="p">,</span> <span class="n">pathexists</span>
<span class="kn">from</span> <span class="nn">pysys.utils.pycompat</span> <span class="kn">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">isstring</span><span class="p">,</span> <span class="n">openfile</span><span class="p">,</span> <span class="n">makeReadOnlyDict</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pysys.config.descriptor&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TestDescriptor"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestDescriptor">[docs]</a><span class="k">class</span> <span class="nc">TestDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Descriptor metadata for an individual testcase (``pysystest.*``) or defaults for tests under a directory </span>
<span class="sd">	subtree (``pysysdirconfig.xml``); see :doc:`/pysys/TestDescriptors`. </span>
<span class="sd">	</span>
<span class="sd">	The `DescriptorLoader` class is responsible for determining the available </span>
<span class="sd">	descriptor instances. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.file: The absolute path of the testcase descriptor file. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.testDir: The absolute path of the test, which is used to convert </span>
<span class="sd">		any relative paths into absolute paths. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.id: The testcase identifier, or the id prefix if this is a </span>
<span class="sd">		directory config descriptor rather than a testcase descriptor. </span>
<span class="sd">		Includes a mode suffix if this is a multi-mode test.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.idWithoutMode: The raw testcase identifier with no mode suffix. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.type: The kind of test this is (``auto`` or ``manual``)</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.skippedReason: If set to a non-empty string, indicates that this </span>
<span class="sd">		testcase is skipped and provides the reason. If this is set then the test </span>
<span class="sd">		is skipped regardless of the value of `state`. </span>

<span class="sd">	:ivar str ~.state: The state of the testcase (runnable, deprecated or skipped). This field is deprecated - we </span>
<span class="sd">		recommend using `skippedReason` instead, which provides a descriptive outcome to explain why. </span>
<span class="sd">		</span>
<span class="sd">	:ivar str ~.title: The one-line title summarizing this testcase.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.purpose: A detailed description of the purpose of the testcase.</span>
<span class="sd">	</span>
<span class="sd">	:ivar list[str] ~.groups: A list of the user defined groups the testcase belongs to.</span>
<span class="sd">	</span>
<span class="sd">	:ivar list[TestMode] ~.modes: A list of the user defined modes the testcase can be run in. </span>

<span class="sd">	:ivar TestMode ~.mode: Specifies which of the possible modes this descriptor represents or None if the </span>
<span class="sd">		the descriptor has no modes. This field is only present after the </span>
<span class="sd">		raw descriptors have been expanded into multiple mode-specific descriptors. </span>
<span class="sd">		Note that after a descriptor is created from the on-disk file, the `mode` attribute is not set until </span>
<span class="sd">		the later phase when multi-mode descriptors are cloned and expanded based on the selected modes. </span>
<span class="sd">	</span>
<span class="sd">		You can use ``descriptor.mode.params`` to get the parameter dictionary for this mode, </span>
<span class="sd">		and ``descriptor.mode.isPrimary`` to find out of this is a primary mode. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.classname: The Python classname to be executed for this testcase.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.module: The path to the python module containing the testcase class. Relative to testDir, or an absolute path.</span>
<span class="sd">		If not set, the class is looked up in the PYTHONPATH. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.input: The path to the input directory of the testcase. Relative to testDir, or an absolute path.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.output: The path to the output parent directory of the testcase. Relative to testDir, or an absolute path.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.reference: The path to the reference directory of the testcase. Relative to testDir, or an absolute path.</span>
<span class="sd">	</span>
<span class="sd">	:ivar list ~.traceability: A list of the requirements covered by the testcase, typically keywords or bug/story ids.</span>
<span class="sd">	</span>
<span class="sd">	:ivar list[str] ~.authors: A list of the names or user ids of people who contributed to the test. </span>

<span class="sd">	:ivar str ~.created: The date when the test was created in yyyy-mm-dd format. </span>
<span class="sd">	</span>
<span class="sd">	:ivar float ~.executionOrderHint: A float priority value used to determine the </span>
<span class="sd">		order in which testcases will be run; higher values are executed before </span>
<span class="sd">		low values. The default is 0.0. </span>
<span class="sd">	</span>
<span class="sd">	:ivar bool ~.isDirConfig: True if this is a directory configuration, or False if </span>
<span class="sd">		it&#39;s a normal testcase. </span>
<span class="sd">	</span>
<span class="sd">	:ivar dict[str,obj] ~.userData: A Python dictionary that can be used for storing user-defined data </span>
<span class="sd">		in the descriptor. In a pysystest.xml, this can be populated by one or more ``user-data`` elements, e.g. </span>
<span class="sd">		``&lt;data&gt;&lt;user-data name=&quot;key&quot; value=&quot;val ${projectProperty}&quot;&lt;/user-data&gt;&lt;/data&gt;``.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;isDirConfig&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;testDir&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="s1">&#39;modes&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> \
		<span class="s1">&#39;classname&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;traceability&#39;</span><span class="p">,</span> <span class="s1">&#39;executionOrderHint&#39;</span><span class="p">,</span> <span class="s1">&#39;executionOrderHintsByMode&#39;</span><span class="p">,</span> \
		<span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> \
		<span class="s1">&#39;skippedReason&#39;</span><span class="p">,</span> <span class="s1">&#39;idWithoutMode&#39;</span><span class="p">,</span> <span class="s1">&#39;_defaultSortKey&#39;</span><span class="p">,</span> <span class="s1">&#39;userData&#39;</span><span class="p">,</span> <span class="s1">&#39;_makeTestTemplates&#39;</span><span class="p">,</span> 

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> 
		<span class="nb">type</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;runnable&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[],</span> <span class="n">modes</span><span class="o">=</span><span class="p">[],</span> 
		<span class="n">classname</span><span class="o">=</span><span class="n">DEFAULT_TESTCLASS</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">DEFAULT_MODULE</span><span class="p">,</span> 
		<span class="nb">input</span><span class="o">=</span><span class="n">DEFAULT_INPUT</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">DEFAULT_OUTPUT</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">DEFAULT_REFERENCE</span><span class="p">,</span> 
		<span class="n">traceability</span><span class="o">=</span><span class="p">[],</span> <span class="n">executionOrderHint</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">skippedReason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
		<span class="n">authors</span><span class="o">=</span><span class="p">[],</span> <span class="n">created</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">testDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
		<span class="n">isDirConfig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">userData</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">skippedReason</span><span class="p">:</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;skipped&#39;</span>
		<span class="k">if</span> <span class="n">state</span><span class="o">==</span><span class="s1">&#39;skipped&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skippedReason</span><span class="p">:</span> <span class="n">skippedReason</span> <span class="o">=</span> <span class="s1">&#39;&lt;unknown skipped reason&gt;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isDirConfig</span> <span class="o">=</span> <span class="n">isDirConfig</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">isDirConfig</span><span class="p">:</span>
			<span class="k">assert</span> <span class="n">file</span><span class="p">,</span> <span class="p">[</span><span class="n">file</span><span class="p">,</span> <span class="nb">id</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">testDir</span> <span class="o">=</span> <span class="n">fromLongPathSafe</span><span class="p">(</span><span class="n">testDir</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">purpose</span> <span class="o">=</span> <span class="n">purpose</span>
		<span class="c1"># copy groups/modes so we can safely mutate them later if desired</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">TestMode</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">):</span>
			<span class="c1"># simple strings were passed in; convert them</span>
			<span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">m</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">TestMode</span><span class="p">)</span> <span class="k">else</span> <span class="n">TestMode</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">]</span>
		
		<span class="k">if</span> <span class="n">modes</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">isPrimary</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">)):</span>
			<span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">TestMode</span><span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">isPrimary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">)]</span><span class="o">+</span><span class="n">modes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="n">authors</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span>
		<span class="k">if</span> <span class="n">created</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]$&#39;</span><span class="p">,</span> <span class="n">created</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Invalid created date &quot;</span><span class="si">%s</span><span class="s1">&quot;, must be yyyy-mm-dd format, in file &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

		
		<span class="bp">self</span><span class="o">.</span><span class="n">classname</span> <span class="o">=</span> <span class="n">classname</span>
		<span class="k">assert</span> <span class="n">classname</span><span class="p">,</span> <span class="s1">&#39;Test descriptors cannot set the classname to nothing&#39;</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">elif</span> <span class="n">module</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
		<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">traceability</span> <span class="o">=</span> <span class="n">traceability</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">executionOrderHint</span> <span class="o">=</span> <span class="n">executionOrderHint</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">skippedReason</span> <span class="o">=</span> <span class="n">skippedReason</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">idWithoutMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
		
		<span class="c1"># for internal use only (we cache this to speed up sorting based on path), </span>
		<span class="c1"># and only for tests not dir configs; </span>
		<span class="c1"># convert to lowercase to ensure a canonical sort order on case insensitive OSes; </span>
		<span class="c1"># add id to be sure they&#39;re unique (e.g. including mode)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultSortKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
		
		<span class="c1"># NB: self.mode is set after construction and </span>
		<span class="c1"># cloning for each supported mode </span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">userData</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span> <span class="k">if</span> <span class="n">userData</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">userData</span>
	
	<span class="k">def</span> <span class="nf">_createDescriptorForMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Internal API for creating a test descriptor for a specific mode of this test.</span>
<span class="sd">		:meta private:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;Mode must be specified&#39;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">),</span> <span class="s1">&#39;Cannot create a mode descriptor from a descriptor that already has its mode set&#39;</span>
		<span class="n">newdescr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c1"># nb: the mode can&#39;t be deep copied accurately but of course it&#39;s not set yet so no problem!</span>
		<span class="n">newdescr</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="c1"># we assume the passed in mode is the TestMode object (not just a str) if TestMode is what&#39;s in the descriptor</span>
		<span class="n">newdescr</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="n">mode</span>
		<span class="n">newdescr</span><span class="o">.</span><span class="n">_defaultSortKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultSortKey</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="n">mode</span>
		<span class="k">return</span> <span class="n">newdescr</span>
	
<div class="viewcode-block" id="TestDescriptor.toDict"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestDescriptor.toDict">[docs]</a>	<span class="k">def</span> <span class="nf">toDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Converts this descriptor to an (ordered) dict suitable for serialization.&quot;&quot;&quot;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;testDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testDir</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;descriptorFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;skippedReason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skippedReason</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;purpose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">purpose</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">created</span>
		<span class="k">def</span> <span class="nf">modeParamsDict</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span>
			<span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isPrimary</span><span class="p">:</span>
				<span class="n">x</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
				<span class="n">x</span><span class="p">[</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">return</span> <span class="n">x</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;modes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">):</span><span class="n">modeParamsDict</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">}</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">):</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> 
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;requirements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceability</span>
		
		<span class="c1"># this is always a list with at least one item, or more if there are multiple modes</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;executionOrderHint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executionOrderHintsByMode</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;executionOrderHintsByMode&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">executionOrderHint</span><span class="p">])</span>

		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;classname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classname</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;userData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span>
		
		<span class="k">return</span> <span class="n">d</span></div>
		
	<span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return an informal string representation of the xml descriptor container object</span>
<span class="sd">		</span>
<span class="sd">		:return: The string represention</span>
<span class="sd">		:rtype: string</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Some of these are only worth printing when there&#39;s actually something to show, and for legacy things like </span>
		<span class="c1"># type/state, when a non-default value is selected</span>
		
		<span class="n">s</span><span class="o">=</span>    <span class="s2">&quot;Test id:           </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
		<span class="n">reltestdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testDir</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDirConfig</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="c1"># relative to current dir is most useful</span>
		<span class="k">if</span> <span class="n">reltestdir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">):</span> <span class="n">reltestdir</span> <span class="o">=</span> <span class="n">reltestdir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test directory:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">reltestdir</span> <span class="c1"># use OS slashes to facilitate copy+paste</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test type:         </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;runnable&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skippedReason</span><span class="p">:</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test state:        </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skippedReason</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test skip reason:  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">skippedReason</span>
		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test title:        </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purpose</span><span class="p">:</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test purpose:      &quot;</span>
			<span class="n">purpose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">purpose</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">purpose</span><span class="p">)):</span>
				<span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">purpose</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;                   </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">purpose</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> 

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test created:      </span><span class="si">%s</span><span class="s2">; authors: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">))</span>

		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test groups:       </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="sa">u</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">x</span> <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&lt;none&gt;&#39;</span><span class="p">)</span>
		
		<span class="k">def</span> <span class="nf">modeNameToString</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">m</span> <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="k">else</span> <span class="n">m</span>
			<span class="k">return</span> <span class="n">x</span>

		<span class="n">modeDelim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> --&gt; &#39;</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;, &#39;</span>

		<span class="n">longestmode</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modeNameToString</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="k">else</span> <span class="mi">0</span>
		<span class="k">def</span> <span class="nf">modeToString</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">modeNameToString</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">modeDelim</span> <span class="o">!=</span> <span class="s1">&#39;, &#39;</span><span class="p">:</span>
				<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;%-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">longestmode</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span><span class="o">%</span><span class="n">x</span>
			<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
				<span class="n">x</span> <span class="o">+=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span><span class="o">%</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
			<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;isPrimary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="s1">&#39; [PRIMARY]&#39;</span>
			<span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
		
		<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># multi mode per run</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test mode:         </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">modeToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># print available modes instead</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;Test modes:        </span><span class="si">%s%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">modeDelim</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">modeDelim</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">modeDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modeToString</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&lt;none&gt;&#39;</span><span class="p">)</span>

		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test order hint:   </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
			<span class="sa">u</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hint</span> <span class="k">for</span> <span class="n">hint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executionOrderHintsByMode</span><span class="p">)</span> <span class="c1"># for multi-mode tests</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;executionOrderHintsByMode&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">executionOrderHint</span><span class="p">)</span>	

		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test classname:    </span><span class="si">%s</span><span class="s2">; module: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DEFAULT_INPUT</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;!Input_dir_if_present_else_testDir!&#39;</span><span class="p">]:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test input:        </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">!=</span> <span class="n">DEFAULT_OUTPUT</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test output:       </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">!=</span> <span class="n">DEFAULT_REFERENCE</span><span class="p">:</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test reference:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceability</span><span class="p">:</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test traceability: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="sa">u</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">x</span> <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceability</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&lt;none&gt;&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">:</span>
			<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;Test user data:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__userDataValueToString</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
		<span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&quot;</span>
		<span class="k">return</span> <span class="n">s</span>
	
	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">__userDataValueToString</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">isstring</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
			<span class="c1"># tab and newline character are difficult to read and in most cases whitespace will be stripped out so remove </span>
			<span class="c1"># it from this view of the strings</span>
			<span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;&lt;nl&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<span class="n">XMLDescriptorContainer</span> <span class="o">=</span> <span class="n">TestDescriptor</span>
<span class="sd">&quot;&quot;&quot; XMLDescriptorContainer is an alias for the TestDescriptor class, which </span>
<span class="sd">exists for compatibility reasons only. </span>

<span class="sd">:meta private:</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestModesConfigHelper"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestModesConfigHelper">[docs]</a><span class="k">class</span> <span class="nc">TestModesConfigHelper</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A helper class that is passed to the lambda which defines test modes in a pysystest configuration. It provides access to </span>
<span class="sd">	the list of inherited modes, to project properties and also helper functions for combining multiple mode lists into </span>
<span class="sd">	one and for configuring a collection of modes as primary modes. </span>
<span class="sd">	</span>
<span class="sd">	:ivar list[dict[str,obj]] ~.inheritedModes: A list of the inherited modes, each defined by a dictionary containing a ``mode`` </span>
<span class="sd">		key and any number of additional parameters. </span>
<span class="sd">	:ivar ~.constants: A reference to `pysys.constants` which can be used to access constants such as ``IS_WINDOWS`` for </span>
<span class="sd">		platform-dependent mode configuration. </span>
<span class="sd">	:ivar ~.pysys: A reference to the `pysys` module. </span>
<span class="sd">	:ivar callable[str] import_module: A reference to the Python ``importlib.import_module`` function that can be used </span>
<span class="sd">		if you need to access functions from additional modules such as ``sys``, ``re``, etc. </span>
<span class="sd">	:ivar pysys.config.project.Project ~.project: The project configuration, from which you can read properties. </span>
<span class="sd">	:ivar str ~.testDir: The test directory, i.e. the directory containing the ``pysystest.*`` file where this modes </span>
<span class="sd">		configuration is defined. This is not available when defining modes in ``pysysdirconfig``, but only when the mode </span>
<span class="sd">		configuration is directly in the ``pysystest.*`` file. </span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inheritedModes</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">testDir</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">inheritedModes</span> <span class="o">=</span> <span class="n">inheritedModes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">constants</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">import_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pysys</span> <span class="o">=</span> <span class="n">pysys</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">os</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">testDir</span> <span class="o">=</span> <span class="n">testDir</span>

<div class="viewcode-block" id="TestModesConfigHelper.makeAllPrimary"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestModesConfigHelper.makeAllPrimary">[docs]</a>	<span class="k">def</span> <span class="nf">makeAllPrimary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Modifies the specified list (or dict) of modes so that all of them have isPrimary=True. </span>
<span class="sd">		</span>
<span class="sd">		By default only the first mode in the mode list is &quot;primary&quot;, so the test will only run in that one mode by </span>
<span class="sd">		default during local development (unless you supply a ``--modes`` or ``--ci`` argument). This is optimal when </span>
<span class="sd">		using modes to validate the same behaviour/conditions in different execution environments e.g. </span>
<span class="sd">		browsers/databases etc. However when using modes to validate different *behaviours/conditions* (e.g. testing </span>
<span class="sd">		out different command line options) using a single PySysTest class, then you should have all your modes as </span>
<span class="sd">		&quot;primary&quot; as you want all of them to execute by default in a quick local test run. </span>
<span class="sd">		</span>
<span class="sd">		You would typically combine test-specific behaviour modes with any inherited execution environment modes like </span>
<span class="sd">		this::</span>
<span class="sd">		</span>
<span class="sd">			lambda modes: modes.combineModeDimensions(</span>
<span class="sd">				helper.inheritedModes,</span>
<span class="sd">				helper.makeAllPrimary(</span>
<span class="sd">					{</span>
<span class="sd">						&#39;Usage&#39;:        {&#39;cmd&#39;: [&#39;--help&#39;], &#39;expectedExitStatus&#39;:&#39;==0&#39;}, </span>
<span class="sd">						&#39;BadPort&#39;:      {&#39;cmd&#39;: [&#39;--port&#39;, &#39;-1&#39;],  &#39;expectedExitStatus&#39;:&#39;!=0&#39;}, </span>
<span class="sd">						&#39;MissingPort&#39;:  {&#39;cmd&#39;: [],  &#39;expectedExitStatus&#39;:&#39;!=0&#39;}, </span>
<span class="sd">					}, </span>
<span class="sd">			)</span>
<span class="sd">		</span>
<span class="sd">		:param list[dict[str,obj]]|dict[str,dict[str,obj]] modes: A list or dict of modes to be made primary.</span>
<span class="sd">		:return: A list[dict[str,obj]] containing the modes, each with isPrimary set to true. </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">modes</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">},</span> <span class="o">**</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
		<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">return</span> <span class="n">modes</span></div>

<div class="viewcode-block" id="TestModesConfigHelper.combineModeDimensions"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestModesConfigHelper.combineModeDimensions">[docs]</a>	<span class="k">def</span> <span class="nf">combineModeDimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">dimensions</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates a single flat mode list containing all combinations that can be generated the specified mode lists. </span>
<span class="sd">		</span>
<span class="sd">		For example::</span>
<span class="sd">		</span>
<span class="sd">			lambda helper: helper.combineModeDimensions(</span>
<span class="sd">			helper.inheritedModes,</span>
<span class="sd">			{</span>
<span class="sd">				&#39;MySQL&#39;:  {&#39;db&#39;: &#39;MySQL&#39;,  &#39;dbTimeoutSecs&#39;:60}, </span>
<span class="sd">				&#39;SQLite&#39;: {&#39;db&#39;: &#39;SQLite&#39;, &#39;dbTimeoutSecs&#39;:120},</span>
<span class="sd">				&#39;Mock&#39;:   {&#39;db&#39;: &#39;Mock&#39;,   &#39;dbTimeoutSecs&#39;:30},</span>
<span class="sd">			},</span>
<span class="sd">			# can use dict or list format for each mode list, whichever is more convenient: </span>
<span class="sd">			[ </span>
<span class="sd">				{&#39;browser&#39;:&#39;Chrome&#39;}, # if mode is not explicitly specified it is auto-generated from the parameter(s)</span>
<span class="sd">				{&#39;browser&#39;:&#39;Firefox&#39;},</span>
<span class="sd">			])</span>
<span class="sd">		</span>
<span class="sd">		would generate modes named::</span>
<span class="sd">		</span>
<span class="sd">			MySQL_Chrome</span>
<span class="sd">			MySQL_Firefox</span>
<span class="sd">			SQLite_Chrome</span>
<span class="sd">			SQLite_Firefox</span>
<span class="sd">			Mock_Chrome</span>
<span class="sd">			Mock_Firefox</span>
<span class="sd">		</span>
<span class="sd">		NB: By default the first mode in each dimension is designated a *primary* mode (one that executes by default </span>
<span class="sd">		when no ``--modes`` or ``--ci`` argument is specified), but this can be overridden by setting ``&#39;isPrimary&#39;: True/False`` </span>
<span class="sd">		in the dict for any mode. When mode dimensions are combined, the primary modes are AND-ed together, </span>
<span class="sd">		i.e. any where *all* mode dimensions were designated primary. </span>
<span class="sd">		So in the above case, since MySQL and Chrome are automatically set as </span>
<span class="sd">		primary modes, the MySQL_Chrome mode would be the (only) primary mode returned from this function.</span>
<span class="sd">		When using modes for different execution environments/browsers etc you probably want only </span>
<span class="sd">		the first (typically fastest/simplest/most informative) mode to be primary; on the other hand if using modes to </span>
<span class="sd">		re-use the same PySysTest logic for against various behavioural tests (different input files/args etc) </span>
<span class="sd">		you should usually set all of the modes to be </span>
<span class="sd">		primary so that all of them are executed in your test runs during local development. </span>

<span class="sd">		A common use case is to combine inherited modes from the parent pysysdirconfigs with a list of modes specific to </span>
<span class="sd">		this test::</span>
<span class="sd">		</span>
<span class="sd">			lambda helper: helper.combineModeDimensions(</span>
<span class="sd">				helper.inheritedModes,</span>
<span class="sd">				</span>
<span class="sd">				helper.makeAllPrimary(</span>
<span class="sd">					{</span>
<span class="sd">						&#39;Usage&#39;:         {&#39;cmd&#39;: [&#39;--help&#39;], </span>
<span class="sd">							&#39;expectedExitStatus&#39;:&#39;==0&#39;, &#39;expectedMessage&#39;:None}, </span>
<span class="sd">						&#39;BadPort&#39;:       {&#39;cmd&#39;: [&#39;--port&#39;, &#39;-1&#39;],  </span>
<span class="sd">							&#39;expectedExitStatus&#39;:&#39;!=0&#39;, &#39;expectedMessage&#39;:&#39;Server failed: Invalid port number specified: -1&#39;}, </span>
<span class="sd">						&#39;SetPortTwice&#39;:  {&#39;cmd&#39;: [&#39;--port&#39;, &#39;123&#39;, &#39;--config&#39;, helper.testDir+&#39;/myserverconfig.json&#39;], </span>
<span class="sd">							&#39;expectedExitStatus&#39;:&#39;!=0&#39;, &#39;expectedMessage&#39;:&#39;Server failed: Cannot specify port twice&#39;}, </span>
<span class="sd">					}), </span>
<span class="sd">			)</span>

<span class="sd">		This is a good way to use modes for the concept of parameterized subtests, since even if you don&#39;t initially have </span>
<span class="sd">		any inherited modes, if in future you add some then everything will automatically work correctly. </span>

<span class="sd">		NB: For efficiency reasons, don&#39;t use the ``combineModeDimensions`` method in your configuration if you are </span>
<span class="sd">		*just* using the inherited modes unchanged. </span>
<span class="sd">		</span>
<span class="sd">		:param list[dict[str,obj]]|dict[str,dict[str,obj]] dimensions: Each argument passed to this function is a list of </span>
<span class="sd">			modes, each mode defined by a dict which may contain a ``mode`` key plus any number of parameters. </span>
<span class="sd">			Alternatively, each dimension can be a dict where the mode is the key and the value is a parameters dict. </span>
<span class="sd">		:return: A list[dict[str,obj]] containing the flattened list of modes consisting of all combinations of the </span>
<span class="sd">			passed in. This can be further manipulated using Python list comprehensions (e.g. to exclude certain </span>
<span class="sd">			combinations) if desired. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		
		<span class="n">current</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># key=mode name value=params</span>
		<span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
			<span class="n">prevModesForCombining</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span> <span class="k">else</span> <span class="n">current</span>

			<span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="n">dimension</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">},</span> <span class="o">**</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dimension</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

			<span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">dimension</span><span class="p">:</span>
				<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s1">&#39;Each mode must be a {...} dict but found unexpected object </span><span class="si">%r</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
				<span class="n">modeString</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">_XMLDescriptorParser</span><span class="o">.</span><span class="n">splitModeNameAndParams</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
				<span class="n">current</span><span class="p">[</span><span class="n">modeString</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
			<span class="c1"># end for mode</span>
			
			<span class="c1"># ensure at least one is primary in each dimension, else we&#39;d lose the primary-ness when AND-ing them together</span>
			<span class="k">if</span> <span class="n">current</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span> 
				<span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

			<span class="k">if</span> <span class="n">prevModesForCombining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">current</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prevModesForCombining</span><span class="p">:</span>
					<span class="n">current</span> <span class="o">=</span> <span class="n">prevModesForCombining</span> <span class="ow">or</span> <span class="n">current</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">newModes</span> <span class="o">=</span> <span class="n">current</span>
					<span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">for</span> <span class="n">modeA</span><span class="p">,</span> <span class="n">paramsA</span> <span class="ow">in</span> <span class="n">prevModesForCombining</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">for</span> <span class="n">modeB</span><span class="p">,</span> <span class="n">paramsB</span> <span class="ow">in</span> <span class="n">newModes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
							<span class="n">isPrimary</span> <span class="o">=</span> <span class="n">paramsA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">paramsB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
							<span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">paramsA</span><span class="p">)</span>
							<span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">paramsB</span><span class="p">)</span> <span class="c1"># newer &quot;B&quot; params take precedence if any keys as the same</span>
							<span class="c1"># for simplicity, just include it with params here</span>
							<span class="n">params</span><span class="p">[</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isPrimary</span>
							<span class="n">current</span><span class="p">[</span><span class="n">modeA</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">modeB</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">params</span>
		<span class="k">return</span> <span class="p">[{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">modeString</span><span class="p">},</span> <span class="o">**</span><span class="n">params</span><span class="p">}</span> <span class="k">for</span> <span class="n">modeString</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span></div></div>

	

<div class="viewcode-block" id="TestMode"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.TestMode">[docs]</a><span class="k">class</span> <span class="nc">TestMode</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span> <span class="c1"># subclasses string to retain compatibility for tests that don&#39;t use mode parameters</span>
	<span class="sd">&quot;&quot;&quot;Represents a mode that a test can run in in a `TestDescriptor`, and optionally a dict of parameters that define </span>
<span class="sd">	that mode. </span>
<span class="sd">	</span>
<span class="sd">	To create one::</span>
<span class="sd">	</span>
<span class="sd">		mode = TestMode(&#39;MyMode&#39;, {&#39;param1&#39;: &#39;value1&#39;})</span>
<span class="sd">	</span>
<span class="sd">	See the ``mode`` parameter/field in `TestDescriptor` where this class is used. </span>
<span class="sd">	</span>
<span class="sd">	This class is immutable, so create a new instance if you want to change something. </span>

<span class="sd">	For convenience and compatibility, this TestMode subclasses a string holding the mode. </span>
<span class="sd">	</span>
<span class="sd">	:ivar str ~.name: The name of the mode as a string. </span>

<span class="sd">	:ivar dict[str,obj] ~.params: A dictionary of parameters associated with this mode. The parameters are available to </span>
<span class="sd">		the test (as ``self.mode.params``) and also assigned as instance fields on the test class when it </span>
<span class="sd">		runs in this mode. </span>
<span class="sd">		</span>
<span class="sd">	:ivar bool ~.isPrimary: Indicates whether this is a primary mode, </span>
<span class="sd">		one that executes by default even when not explicity requested with a commnad line option such as ``--modes=ALL``)</span>

<span class="sd">	.. versionadded:: 2.0</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__params&#39;</span><span class="p">,</span> <span class="s1">&#39;__isPrimary&#39;</span><span class="p">,</span> <span class="s1">&#39;__name&#39;</span><span class="p">]</span>
	
	<span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isPrimary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">s</span>
		<span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__params</span> <span class="o">=</span> <span class="n">params</span>
		<span class="k">assert</span> <span class="s1">&#39;isPrimary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__isPrimary</span> <span class="o">=</span> <span class="n">isPrimary</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__params</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">isPrimary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isPrimary</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>
	
	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;[PRIMARY]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isPrimary</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>
			
	
<span class="k">class</span> <span class="nc">_XMLDescriptorParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;NOT PUBLIC API - use L{DescriptorLoader.parseTestDescriptor} instead. </span>
<span class="sd">	</span>
<span class="sd">	:meta private:</span>
<span class="sd">	</span>
<span class="sd">	Helper class to parse an XML test descriptor - either for a testcase, </span>
<span class="sd">	or for defaults for a (sub-)directory of testcases.</span>

<span class="sd">	If the file is/contains XML the class uses the minidom DOM (Document Object Model) non-validating</span>
<span class="sd">	parser to provide accessor methods to return element attributes	and character</span>
<span class="sd">	data from the test descriptor file. The class is instantiated with the filename</span>
<span class="sd">	of the test descriptor. It is the responsibility of the user of the class to</span>
<span class="sd">	call the unlink() method of the class on completion in order to free the memory</span>
<span class="sd">	used in the parsing.</span>
<span class="sd">	</span>
<span class="sd">	If not, it uses __pysys_XXX__ dunders (Python-style but also designed to work fine in other languages whether in </span>
<span class="sd">	comments e.g. /* ... */  or even as string literals, provided there are no backslash escapes to worry about)</span>
<span class="sd">	</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="n">KV_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;__pysys_</span><span class="si">%s</span><span class="s1">__&#39;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">,</span> <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmlRootElement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">assert</span> <span class="n">project</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">xmlfile</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">fromLongPathSafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span><span class="c1"># used for error messages etc</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">istest</span> <span class="o">=</span> <span class="n">istest</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">_defaultDirConfig</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_DESCRIPTOR</span><span class="p">)</span> <span class="k">if</span> <span class="n">parentDirDefaults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">parentDirDefaults</span>
		<span class="n">roottag</span> <span class="o">=</span> <span class="s1">&#39;pysystest&#39;</span> <span class="k">if</span> <span class="n">istest</span> <span class="k">else</span> <span class="s1">&#39;pysysdirconfig&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Unable to find supplied descriptor </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span> <span class="o">=</span> <span class="p">{}</span>
		
		<span class="k">if</span> <span class="n">xmlRootElement</span><span class="p">:</span> <span class="c1"># used when parsing from project XML rather than directly from a standalone file</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">xmlRootElement</span>
			<span class="k">assert</span> <span class="n">xmlRootElement</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="s1">&#39;pysysdirconfig&#39;</span><span class="p">,</span> <span class="n">xmlRootElement</span><span class="o">.</span><span class="n">tagName</span>
			<span class="k">return</span>
		
		<span class="k">if</span> <span class="n">istest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">xmlfile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">):</span>
			<span class="c1"># Find it within a file of another type e.g. pysystest.py</span>
			
			<span class="c1"># Open in binary mode since we don&#39;t know the encoding - we&#39;ll rely on the XML header to tell us if it&#39;s anything unusual</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xmlhandle</span><span class="p">:</span>
				<span class="n">filecontents</span> <span class="o">=</span> <span class="n">xmlhandle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="c1"># must be at the start of a line, i.e. not after a comment</span>
			<span class="c1"># we do allow raw strings</span>
			<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
					<span class="p">(</span><span class="sa">f</span><span class="s1">&#39;^[ </span><span class="se">\\</span><span class="s1">t]*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span><span class="o">%</span><span class="s2">&quot;(?P&lt;key&gt;[^ =]+)&quot;</span><span class="si">}</span><span class="s1"> *= *(?:(?P&lt;rawstring&gt;[r@])?(&#39;</span> <span class="c1"># r for python raw strings, @ for C#</span>
						<span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
							<span class="s1">&#39;(?P&lt;value1&gt;(-?[0-9+-][0-9.]+|[T]rue|[F]alse))&#39;</span><span class="p">,</span> <span class="c1"># number/boolean literal, would be a shame for it to have to be quoted</span>
							<span class="s1">&#39;&quot;&quot;&quot;(?P&lt;value2&gt;(?:[^&quot;]|&quot;{1,2}(?!&quot;))*)&quot;&quot;&quot;&#39;</span><span class="p">,</span>
							<span class="s1">&#39;&quot;(?P&lt;value3&gt;[^&quot;]*)&quot;&#39;</span><span class="p">,</span>
						<span class="p">])</span>
						<span class="o">+</span><span class="s1">&#39;) *($|[;#</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">r]))?&#39;</span> <span class="c1"># ensure there&#39;s no attempt to concatenate something else; we make the string matching part optional so we can give a nice error if it goes wrong</span>
						<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> 
					<span class="n">filecontents</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span> 
				<span class="n">k</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incorrect key format for &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">k</span><span class="si">}</span><span class="s1">&quot; in &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Duplicate key &quot;{self.KV_PATTERN % k}__&quot; in &quot;</span><span class="si">{self.file}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;value1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;value3&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot parse the value for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span> <span class="o">%</span> <span class="n">k</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">; after the &quot;=&quot; you should use r&quot;&quot;&quot;...&quot;&quot;&quot;, &quot;...&quot; or a numeric/boolean literal&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;rawstring&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot use backslash escape sequences for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span> <span class="o">%</span> <span class="n">k</span><span class="si">}</span><span class="s1"> value (unless using a raw r&quot;&quot;&quot;...&quot;&quot;&quot; string); cannot parse &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;xml_descriptor&#39;</span><span class="p">:</span> <span class="c1"># we keep xml descriptors as bytes so we can use the correct encoding</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

			<span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span> <span class="ow">and</span> <span class="s1">&#39;xml_descriptor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot find mandatory </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span> <span class="o">%</span> <span class="s2">&quot;title&quot;</span><span class="si">}</span><span class="s1"> specifier for this test in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">xmlcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xml_descriptor&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># not likely to be used for .py files, but might be nice for some others</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">xmlcontents</span> <span class="o">=</span> <span class="kc">None</span>
		
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">xmlcontents</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">xmlcontents</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">xmlcontents</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="k">return</span>
				
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Invalid XML in descriptor &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">roottag</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]:</span>
				<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;No &lt;</span><span class="si">%s</span><span class="s2">&gt; element supplied in XML descriptor &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">roottag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">roottag</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Parses the test/dir descriptor in the specified path and returns the </span>
<span class="sd">		TestDescriptor object. </span>
<span class="sd">		</span>
<span class="sd">		:param istest: True if this is a ``pysystest.*`` file, false if it is </span>
<span class="sd">			a descritor giving defaults for a directory of testcases.  </span>
<span class="sd">			:param parentDirDefaults: Optional TestDescriptor instance </span>
<span class="sd">			specifying default values to be filtered in from the parent </span>
<span class="sd">			directory.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">_XMLDescriptorParser</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">istest</span><span class="o">=</span><span class="n">istest</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentDirDefaults</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">getContainer</span><span class="p">()</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="n">p</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

	<span class="n">DEFAULT_DESCRIPTOR</span> <span class="o">=</span> <span class="n">TestDescriptor</span><span class="p">(</span>
		<span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;runnable&quot;</span><span class="p">,</span> 
		<span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[],</span> <span class="n">modes</span><span class="o">=</span><span class="p">[],</span> 
		<span class="n">classname</span><span class="o">=</span><span class="n">DEFAULT_TESTCLASS</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="nb">input</span><span class="o">=</span><span class="n">DEFAULT_INPUT</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">DEFAULT_OUTPUT</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">DEFAULT_REFERENCE</span><span class="p">,</span> 
		<span class="n">traceability</span><span class="o">=</span><span class="p">[],</span> <span class="n">executionOrderHint</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">skippedReason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isDirConfig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A directory config descriptor instance of TestDescriptor holding </span>
<span class="sd">	the default values to be used if there is no directory config descriptor. </span>
<span class="sd">	&quot;&quot;&quot;</span>


	<span class="k">def</span> <span class="nf">getContainer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Create and return an instance of TestDescriptor for the contents of the descriptor.&#39;&#39;&#39;</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">attrName</span><span class="p">,</span> <span class="n">attrValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">attrName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
					<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Unknown attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; in XML descriptor &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">attrName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
		<span class="bp">cls</span><span class="p">,</span> <span class="n">pymodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassDetails</span><span class="p">()</span>
		
		<span class="k">if</span> <span class="n">pymodule</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span><span class="p">:</span> <span class="c1"># default setting means auto-detect (nb: NOT the same as pymodule=&#39;&#39; which means to use the PYTHONPATH)</span>
			<span class="n">pymodule</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">DEFAULT_MODULE</span> <span class="c1"># else run.py</span>
		
		
		
		<span class="c1"># some elements that are mandatory for an individual test and not used for dir config</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">TestDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getFile</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getType</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getState</span><span class="p">(),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">getTitle</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPurpose</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getModes</span><span class="p">(),</span> 
										<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="bp">cls</span><span class="p">),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="n">pymodule</span><span class="p">),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTestInput</span><span class="p">()),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTestOutput</span><span class="p">()),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTestReference</span><span class="p">()),</span>
										<span class="bp">self</span><span class="o">.</span><span class="n">getRequirements</span><span class="p">(),</span> 
										<span class="bp">self</span><span class="o">.</span><span class="n">getExecutionOrderHint</span><span class="p">(),</span> 
										<span class="n">skippedReason</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSkippedReason</span><span class="p">(),</span> 
										<span class="n">testDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span>
										<span class="n">userData</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getUserData</span><span class="p">(),</span>
										<span class="n">authors</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> 
											<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
											<span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()],</span>
										<span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
										<span class="n">isDirConfig</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="p">:</span> <span class="c1"># should all have been popped during parsing</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">KV_PATTERN</span> <span class="o">%</span> <span class="s2">&quot;KEY&quot;</span><span class="si">}</span><span class="s1"> key(s) in test descriptor &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span><span class="p">:</span>
			<span class="c1"># _makeTestTemplates is not an official/public part of the descriptor spec, so don&#39;t have it in the constructor signature</span>
			<span class="n">t</span><span class="o">.</span><span class="n">_makeTestTemplates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseTestMakerTemplates</span><span class="p">()</span>
		
		<span class="k">return</span> <span class="n">t</span>

	<span class="k">def</span> <span class="nf">_parseTestMakerTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># not public API, do not use</span>
		<span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;maker-template&#39;</span><span class="p">):</span>
			<span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
				<span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">),</span>
				<span class="s1">&#39;copy&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()],</span>
				<span class="s1">&#39;mkdir&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;mkdir&#39;</span><span class="p">)</span> <span class="k">else</span>
					<span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;mkdir&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">expandProperties</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()],</span>
				<span class="s1">&#39;isTest&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;isTest&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
				<span class="s1">&#39;replace&#39;</span><span class="p">:</span> <span class="p">[],</span>
				<span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
			<span class="p">}</span>
			
			<span class="c1"># NB: further validation and expansion happens in console_make</span>
			
			<span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;A name=... attribute is required for each maker-template in </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;A description=... attribute is required for each maker-template, in </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
			
			<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;replace&#39;</span><span class="p">):</span>
				<span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;regex&#39;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;with&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">r1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Each maker-template &lt;replace&gt; element requires both a regex= and a with= attribute, in </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
				<span class="n">t</span><span class="p">[</span><span class="s1">&#39;replace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="c1"># NB: we don&#39;t combine with defaults here, that happens in the make launcher</span>

		<span class="k">return</span> <span class="n">templates</span>


	<span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Clean up the DOM on completion.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

	
	<span class="k">def</span> <span class="nf">getFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return the filename of the test descriptor.&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

	
	<span class="k">def</span> <span class="nf">getID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return the id of the test, or for a pysysdirconfig, the id prefix.&#39;&#39;&#39;</span>
		<span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id-prefix&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">getElementTextOrDefault</span><span class="p">(</span><span class="s1">&#39;id-prefix&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
		
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">/:~#&lt;&gt;&#39;</span><span class="p">:</span>
			<span class="c1"># reserve a few characters that we might need for other purposes; _ and . can be used however</span>
			<span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;The &lt;id-prefix&gt; is not permitted to contain &quot;</span><span class="si">%s</span><span class="s1">&quot;; error in &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span><span class="p">:</span> <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="nb">id</span>

	<span class="k">def</span> <span class="nf">getType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return the type attribute of the test element - mostly just legacy now.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">type</span>
		<span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">type</span>
		<span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;manual&quot;</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;The type attribute of the test element should be </span><span class="se">\&quot;</span><span class="s2">auto</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">manual</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">type</span>

	<span class="k">def</span> <span class="nf">getState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return the state attribute of the test element - mostly just legacy now.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">state</span>
		<span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>	 <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">state</span>
		<span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;runnable&quot;</span><span class="p">,</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">]:</span> 
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;The state attribute of the test element should be </span><span class="se">\&quot;</span><span class="s2">runnable</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">deprecated</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">skipped</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">state</span> 

	<span class="k">def</span> <span class="nf">getSkippedReason</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;skipped_reason&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Missing value for skipped reason in &quot;</span><span class="si">{self.file}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;skipped&#39;</span><span class="p">):</span>
				<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
				<span class="c1"># make this mandatory, to encourage good practice</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Missing reason= attribute in &lt;skipped&gt; element of &quot;</span><span class="si">{self.file}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">skippedReason</span>

	<span class="k">def</span> <span class="nf">getTitle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># PySys 1.6.1 gave an error if &lt;description&gt; was missing, but a default if &lt;title&gt; was missing, and permitted empty string. So don&#39;t be too picky. </span>

		<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementTextOrDefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="c1"># falling back to the ID is better than nothing</span>
		
		<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;  &#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;  +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span>
				
	<span class="k">def</span> <span class="nf">getPurpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementTextOrDefault</span><span class="p">(</span><span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">purpose</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
		<span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">cleandoc</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
				
	<span class="k">def</span> <span class="nf">getGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">groupList</span> <span class="o">=</span> <span class="p">[]</span>
		
		<span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inherit=true&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit=false&#39;</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Groups must be in the form &quot;my-group1, mygroup2, ...; inherit=true/false&quot; (the inherit= specifier is mandatory) in descriptor &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
			<span class="n">groupList</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;inherit=false&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">groupList</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">groups</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">tagName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pysystest&#39;</span><span class="p">,</span> <span class="s1">&#39;pysysdirconfig&#39;</span><span class="p">,</span> <span class="s1">&#39;classification&#39;</span><span class="p">]:</span> 
					<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;&lt;groups&gt; element found under &lt;</span><span class="si">%s</span><span class="s2">&gt; but must be under the root node (or the &lt;classification&gt; node), in XML descriptor </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>

				<span class="k">if</span> <span class="n">groups</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">):</span>
					<span class="n">groupList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

				<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
					<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">g</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
						<span class="n">groupList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;inherit&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">groupList</span> <span class="c1"># don&#39;t inherit</span>
		
		<span class="n">groupList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">groups</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupList</span><span class="p">]</span><span class="o">+</span><span class="n">groupList</span>
		<span class="k">return</span> <span class="n">groupList</span>
	
		
	<span class="nd">@staticmethod</span> 
	<span class="k">def</span> <span class="nf">splitModeNameAndParams</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns (modename, params). Auto-generates a mode name if one is not already provided. </span>
<span class="sd">		</span>
<span class="sd">		The mode dict is mutated by this method. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s1">&#39;Expecting mode dict but got </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mode</span>
		<span class="n">modeString</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">modeString</span><span class="p">:</span> <span class="k">return</span> <span class="n">modeString</span><span class="p">,</span> <span class="n">mode</span>

		<span class="c1"># Auto-generate mode string</span>
		
		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Must provide a name and/or params for every mode dictionary&#39;</span>
		<span class="n">modeString</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
			<span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^([-0-9.]+|true|false|)$&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span> <span class="k">else</span> <span class="n">v</span> <span class="c1"># include the key for numeric and boolean values</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;isPrimary&#39;</span><span class="p">)</span>
		
		<span class="n">modeString</span> <span class="o">=</span> <span class="n">modeString</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># avoid leading/trailing _&#39;s</span>

		<span class="c1"># Enforce consistent naming convention of initial caps</span>
		<span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;enforceModeCapitalization&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
			<span class="n">modeString</span> <span class="o">=</span> <span class="n">modeString</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">modeString</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

		<span class="k">assert</span> <span class="n">modeString</span><span class="p">,</span> <span class="s1">&#39;Mode name cannot be empty&#39;</span>
		<span class="k">return</span> <span class="n">modeString</span><span class="p">,</span> <span class="n">mode</span>
		
	<span class="k">def</span> <span class="nf">getModes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="n">modesNode</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span> 
			<span class="n">modesNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">modesNode</span><span class="p">:</span>
				<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">modesNode</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># if we have neither kvText text nor mode</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">modes</span> <span class="c1"># by default we inherit</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span> 
			<span class="c1"># pre-2.0 XML approach</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">modesNode</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">):</span>
				<span class="n">modeString</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">modeString</span><span class="p">:</span> 
					<span class="n">result</span><span class="p">[</span><span class="n">modeString</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">modesNode</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;inherit&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
				<span class="c1"># This logic is intended to preserve primary inherited modes; it&#39;s a bit weird, but keeping it the same for compatibility</span>
				<span class="n">inherited</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span> 
				<span class="n">inherited</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">inherited</span><span class="o">+</span><span class="p">[</span><span class="n">TestMode</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
			<span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">isPrimary</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span> 
				<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TestMode</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">isPrimary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

			<span class="k">return</span> <span class="n">result</span>
			
		<span class="c1"># The modern PySys 2.0+ approach with a Python eval string</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">modesLambda</span> <span class="o">=</span> <span class="n">text</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modesLambda</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># eventually kvDict may be able to contain non-string values direct from Python</span>
				<span class="c1"># use an empty namespace since if we were parsing this as real python, all import statements would be appearing later</span>
				<span class="n">modesLambda</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">extraNamespace</span><span class="o">=</span><span class="p">{},</span> <span class="n">emptyNamespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">modesLambda</span><span class="p">),</span> <span class="s1">&#39;Expecting callable (e.g. lambda helper: []) but got </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">modesLambda</span>
			<span class="n">helper</span> <span class="o">=</span> <span class="n">TestModesConfigHelper</span><span class="p">(</span>
				<span class="c1"># note that inheritedModes param dicts may be mutated (so good think we&#39;d creating a new dict here for the default modes)</span>
				<span class="n">inheritedModes</span><span class="o">=</span><span class="p">[{</span><span class="o">**</span><span class="n">mode</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;isPrimary&#39;</span><span class="p">:</span><span class="n">mode</span><span class="o">.</span><span class="n">isPrimary</span><span class="p">}}</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">modes</span><span class="p">],</span> 
				<span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> 
				<span class="n">testDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istest</span> <span class="k">else</span> <span class="kc">None</span>
				<span class="p">)</span>
			<span class="n">modes</span> <span class="o">=</span> <span class="n">modesLambda</span><span class="p">(</span><span class="n">helper</span><span class="p">)</span> <span class="c1"># assumes it&#39;s a callable accepting a single parameter</span>
			
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="n">modes</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">},</span> <span class="o">**</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
			<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;Expecting a list of modes, got a </span><span class="si">%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">modes</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">modes</span><span class="p">)</span>
			<span class="k">assert</span> <span class="ow">not</span> <span class="n">modesNode</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">modesNode</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;inherit&#39;</span><span class="p">),</span> <span class="s1">&#39;Cannot use the legacy inherit= attribute when using the modern Python eval string to define modes&#39;</span>
			
			<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">already</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
			<span class="n">expectedparams</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
				<span class="n">modeString</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitModeNameAndParams</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
				<span class="n">isPrimary</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;isPrimary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
				<span class="k">assert</span> <span class="n">isPrimary</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="s1">&#39;isPrimary must be set to True or False, not </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">isPrimary</span>

			
				<span class="c1"># Eliminate dodgy characters</span>
				<span class="n">badchars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]+&#39;</span><span class="o">%</span><span class="n">pysys</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">MODE_CHARS</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">modeString</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">badchars</span><span class="p">:</span> 
					<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Unsupported characters &quot;</span><span class="si">%s</span><span class="s1">&quot; found in test mode &quot;</span><span class="si">%s</span><span class="s1">&quot; of </span><span class="si">%s</span><span class="s1">; stripping them out&#39;</span><span class="p">,</span> 
						<span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">)),</span> <span class="n">modeString</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
					<span class="n">modeString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="o">%</span><span class="n">pysys</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">MODE_CHARS</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">modeString</span><span class="p">)</span>

				<span class="n">modeString</span> <span class="o">=</span> <span class="n">modeString</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># avoid leading/trailing _&#39;s and whitespace, since we&#39;ll add them when composing modes</span>
				
				<span class="k">assert</span> <span class="n">modeString</span><span class="p">,</span> <span class="s1">&#39;Invalid mode: cannot be empty&#39;</span>
				<span class="k">assert</span> <span class="s1">&#39;__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modeString</span><span class="p">,</span> <span class="s1">&#39;Invalid mode &quot;</span><span class="si">%s</span><span class="s1">&quot; cannot contain double underscore&#39;</span><span class="o">%</span><span class="n">modeString</span>

				<span class="c1"># Enforce consistent naming convention of initial caps</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;enforceModeCapitalization&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
					<span class="n">modeString</span> <span class="o">=</span> <span class="n">modeString</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">modeString</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
			
				<span class="k">assert</span> <span class="n">modeString</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already</span><span class="p">,</span> <span class="s1">&#39;Duplicate mode &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">modeString</span>
				<span class="n">already</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modeString</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
					<span class="k">assert</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="s1">&#39;Illegal mode parameter name - cannot start with underscore: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">p</span>


				<span class="c1"># check that params are the same in each one to avoid mistakes</span>
				<span class="k">if</span> <span class="n">expectedparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">expectedparams</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
				<span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="n">expectedparams</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The same mode parameter keys must be given for every mode in the list, but found </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1"> parameters for &quot;</span><span class="si">{</span><span class="n">modeString</span><span class="si">}</span><span class="s1">&quot; different to </span><span class="si">{</span><span class="n">expectedparams</span><span class="si">}</span><span class="s1">&#39;</span>

				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestMode</span><span class="p">(</span><span class="n">modeString</span><span class="p">,</span> <span class="n">isPrimary</span><span class="o">=</span><span class="n">isPrimary</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">))</span>

			<span class="c1"># ensure there&#39;s at least one primary mode</span>
			<span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">isPrimary</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span> 
				<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TestMode</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">isPrimary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				
			<span class="k">return</span> <span class="n">result</span>

		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
				<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Invalid modes configuration in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>

				
	<span class="k">def</span> <span class="nf">getClassDetails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return the Python test class attributes (name, module, searchpath), contained in the class element.&#39;&#39;&#39;</span>
		<span class="n">classname</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;python_class&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;python_module&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>		
		
		<span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">el</span><span class="p">:</span>
			<span class="n">classname</span> <span class="o">=</span> <span class="n">classname</span> <span class="ow">or</span> <span class="n">el</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
			<span class="n">module</span> <span class="o">=</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">el</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
		<span class="c1"># nb: empty means look it up in PYTHONPATH, None is a sentinel value meaning auto, based on descriptor extension</span>
		<span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;PYTHONPATH&#39;</span> <span class="c1"># probably this is what was intended</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">classname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="n">module</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">module</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">getExecutionOrderHint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;execution_order_hint&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;execution-order&#39;</span><span class="p">)</span>

			<span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;hint&#39;</span><span class="p">)</span>
				
		<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Invalid float value specified for execution order hint in &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">executionOrderHint</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">r</span>


	<span class="k">def</span> <span class="nf">getUserData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		
		<span class="n">newitems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;user_data&#39;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newitems</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
				<span class="n">newitems</span> <span class="o">=</span> <span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">safeeval</span><span class="o">.</span><span class="n">safeEval</span><span class="p">(</span><span class="n">newitems</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> 
						<span class="n">extraNamespace</span><span class="o">=</span><span class="p">{},</span> <span class="n">emptyNamespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">newitems</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;user-data&#39;</span><span class="p">):</span>
					<span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
					
					<span class="c1"># NB: we don&#39;t use inspect.cleandoc here since it&#39;d probably slow down descriptor loading and in 99% </span>
					<span class="c1"># of for multi-line strings we will be stripping whitespace anyway so not a good use of time</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">childNodes</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">childNodes</span> 
							<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">nodeType</span> <span class="ow">in</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">TEXT_NODE</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">CDATA_SECTION_NODE</span><span class="p">})</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

					<span class="n">newitems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">newitems</span><span class="p">:</span>
			<span class="k">assert</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;name must be specified for user data&#39;</span>
			<span class="k">assert</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">,</span> <span class="s1">&#39;runner&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">},</span> <span class="n">key</span> <span class="c1"># prevent names that we reserve for use by the basetest/processuser</span>

		<span class="c1"># start with parent defaults, add children</span>
		<span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">userData</span><span class="p">)</span>
		<span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">newitems</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="n">result</span>

			
	<span class="k">def</span> <span class="nf">getTestInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_dir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span> <span class="n">value</span>
		
		<span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;input-dir&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">node</span><span class="p">:</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">x</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">input</span>
		
	<span class="k">def</span> <span class="nf">getTestOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_dir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span> <span class="n">value</span>

		<span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;output-dir&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">node</span><span class="p">:</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">x</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">output</span>

	<span class="k">def</span> <span class="nf">getTestReference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reference_dir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span> <span class="n">value</span>

		<span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="s1">&#39;reference-dir&#39;</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">node</span><span class="p">:</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">x</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">reference</span>

	<span class="k">def</span> <span class="nf">getRequirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Return a list of the requirement ids, contained in the character data of the requirement elements.&#39;&#39;&#39;</span>
		<span class="n">reqList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;traceability_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;requirement&#39;</span><span class="p">):</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">reqList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

		<span class="c1"># these used to always be below &lt;traceability&gt;&lt;requirements&gt;..., but now we allow them directly under the root node </span>
		<span class="c1"># (or anywhere the user wants)</span>

		<span class="n">reqList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">traceability</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reqList</span><span class="p">]</span><span class="o">+</span><span class="n">reqList</span>
		<span class="k">return</span> <span class="n">reqList</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">getText</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Utility method that reads text from the specified element and </span>
<span class="sd">		strips leading/trailing whitespace from it. Returns an empty string if none. &quot;&quot;&quot;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="p">:</span> <span class="k">return</span> <span class="n">t</span>
		<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">childNodes</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">nodeType</span> <span class="ow">in</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">TEXT_NODE</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">CDATA_SECTION_NODE</span><span class="p">])</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
				<span class="n">t</span> <span class="o">+=</span> <span class="n">n</span><span class="o">.</span><span class="n">data</span>
		<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">getSingleElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[]):</span>
		<span class="sd">&quot;&quot;&quot;Utility method that finds a single child element of the specified name and </span>
<span class="sd">		strips leading/trailing whitespace from it. Returns None if not found. &quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
		<span class="n">t</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span> <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
		<span class="n">nodes</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">tagName</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
			<span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Expected one element &lt;</span><span class="si">%s</span><span class="s1">&gt; but found more than one in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">tagName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pysystest&#39;</span><span class="p">,</span> <span class="s1">&#39;pysysdirconfig&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">optionalParents</span><span class="p">:</span> 
				<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: XML descriptor element &lt;</span><span class="si">%s</span><span class="s2">&gt; is not permitted under &lt;</span><span class="si">%s</span><span class="s2">&gt; of </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
				<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">getElementTextOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="p">[]):</span>
		<span class="sd">&quot;&quot;&quot;Utility method that finds a single child element of the specified name and </span>
<span class="sd">		strips leading/trailing whitespace from it. Returns an empty string if none. &quot;&quot;&quot;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSingleElement</span><span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">optionalParents</span><span class="o">=</span><span class="n">optionalParents</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">default</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<div class="viewcode-block" id="DescriptorLoader"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.DescriptorLoader">[docs]</a><span class="k">class</span> <span class="nc">DescriptorLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This class is responsible for locating and loading all available testcase </span>
<span class="sd">	descriptors. </span>
<span class="sd">	</span>
<span class="sd">	A custom DescriptorLoader subclass can be provided to customize the test </span>
<span class="sd">	discovery process, typically by overriding L{loadDescriptors} and modifying the </span>
<span class="sd">	returned list of descriptors and configuring your ``pysysproject.xml`` with::</span>
<span class="sd">	</span>
<span class="sd">		&lt;descriptor-loader module=&quot;mypkg.custom&quot; classname=&quot;CustomDescriptorLoader&quot;/&gt;</span>
<span class="sd">	</span>
<span class="sd">	You could use this approach to add additional descriptor instances </span>
<span class="sd">	to represent non-PySys testcases found under the search directory, for example </span>
<span class="sd">	based on discovery of unit test classes. </span>
<span class="sd">	</span>
<span class="sd">	Another key use case would be dynamically adding or changing descriptor </span>
<span class="sd">	settings such as the list of modes for each testcase or the </span>
<span class="sd">	executionOrderHint, perhaps based on a per-group basis. For example, </span>
<span class="sd">	you could modify descriptors in the &quot;database-tests&quot; group to have a </span>
<span class="sd">	dynamically generated list of modes identifying the possible database </span>
<span class="sd">	servers supported without having to hardcode that list into any descriptor </span>
<span class="sd">	files on disk, and allowing for different database modes on different </span>
<span class="sd">	platforms. </span>

<span class="sd">	:ivar pysys.config.project.Project ~.project: The `pysys.config.project.Project` instance. </span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
		<span class="k">assert</span> <span class="n">project</span><span class="p">,</span> <span class="s1">&#39;project must be specified&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__descriptorLoaderPlugins</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pluginCls</span><span class="p">,</span> <span class="n">pluginProperties</span><span class="p">)</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">_descriptorLoaderPlugins</span><span class="p">:</span>
			<span class="n">plugin</span> <span class="o">=</span> <span class="n">pluginCls</span><span class="p">()</span>
			<span class="n">plugin</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
			<span class="n">pysys</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">setInstanceVariablesFromDict</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">pluginProperties</span><span class="p">,</span> <span class="n">errorOnMissingVariables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">plugin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__descriptorLoaderPlugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

<div class="viewcode-block" id="DescriptorLoader.loadDescriptors"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.DescriptorLoader.loadDescriptors">[docs]</a>	<span class="k">def</span> <span class="nf">loadDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Find all descriptors located under the specified directory, and </span>
<span class="sd">		return them as a list.</span>
<span class="sd">		</span>
<span class="sd">		Subclasses may change the returned descriptors and/or add additional </span>
<span class="sd">		instances of their own to the list after calling the super implementation::</span>
<span class="sd">		</span>
<span class="sd">		  descriptors = super(CustomDescriptorLoader, self).loadDescriptors(dir, **kwargs)</span>
<span class="sd">		  ...</span>
<span class="sd">		  return descriptors</span>
<span class="sd">		</span>
<span class="sd">		:param dir: The parent directory to search for runnable tests. </span>
<span class="sd">		</span>
<span class="sd">		:return: List of L{pysys.config.descriptor.TestDescriptor} objects </span>
<span class="sd">			which could be selected for execution. </span>
<span class="sd">			</span>
<span class="sd">			If a test can be run in multiple modes there must be a single descriptor </span>
<span class="sd">			for it in the list returned from this method. Each multi-mode </span>
<span class="sd">			descriptor is later expanded out into separate mode-specific </span>
<span class="sd">			descriptors (at the same time as descriptor filtering based on </span>
<span class="sd">			command line arguments, and addition of project-level </span>
<span class="sd">			execution-order), before the final list is sorted and passed to </span>
<span class="sd">			L{pysys.baserunner.BaseRunner}. </span>
<span class="sd">			</span>
<span class="sd">			The order of the returned list is random, so the caller is responsible </span>
<span class="sd">			for sorting this list to ensure deterministic behaviour. </span>
<span class="sd">		</span>
<span class="sd">		:rtype: list</span>
<span class="sd">		:raises UserError: Raised if no testcases can be found.</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;reserved for future use: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="s1">&#39;project must be specified&#39;</span>
		<span class="k">assert</span> <span class="nb">dir</span><span class="p">,</span> <span class="s1">&#39;dir must be specified&#39;</span>
		<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="nb">dir</span><span class="p">),</span> <span class="s1">&#39;dir must be an absolute path: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">dir</span>
		
		<span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
		
		<span class="n">descriptors</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ignoreSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">OSWALK_IGNORES</span><span class="o">+</span><span class="p">[</span><span class="n">DEFAULT_INPUT</span><span class="p">,</span> <span class="n">DEFAULT_OUTPUT</span><span class="p">,</span> <span class="n">DEFAULT_REFERENCE</span><span class="p">])</span>
		
		<span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pysysTestDescriptorFileNames&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_DESCRIPTOR</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;pysystest.xml&#39;</span><span class="p">]:</span>
			<span class="c1"># compatibility mode</span>
			<span class="n">descriptorSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s1">&#39;pysysTestDescriptorFileNames&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DEFAULT_DESCRIPTOR</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">descriptorSet</span> <span class="o">=</span> <span class="kc">None</span>
		
		<span class="k">assert</span> <span class="n">project</span><span class="o">.</span><span class="n">projectFile</span> <span class="o">!=</span> <span class="kc">None</span>
		<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pysys.launcher&#39;</span><span class="p">)</span>

		<span class="c1"># although it&#39;s highly unlikely, if any test paths did slip outside the Windows 256 char limit, </span>
		<span class="c1"># it would be very dangerous to skip them (which is what os.walk does unless passed a \\?\ path), </span>
		<span class="c1"># so must use long-path-safe</span>
		<span class="nb">dir</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="nb">dir</span><span class="p">))</span>
		<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">),</span> <span class="nb">dir</span> <span class="c1"># sanity check</span>
		<span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">projectFile</span><span class="p">:</span>
			<span class="n">projectroot</span> <span class="o">=</span> <span class="n">toLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">projectFile</span><span class="p">)))</span>

		<span class="n">DIR_CONFIG_DESCRIPTOR</span> <span class="o">=</span> <span class="s1">&#39;pysysdirconfig.xml&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="o">.</span><span class="n">projectFile</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">projectroot</span><span class="p">):</span>
			<span class="n">dirconfigs</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Project file does not exist under &quot;</span><span class="si">%s</span><span class="s1">&quot; so processing of </span><span class="si">%s</span><span class="s1"> files is disabled&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">DIR_CONFIG_DESCRIPTOR</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># find directory config descriptors between the project root and the testcase </span>
			<span class="c1"># dirs. We deliberately use project dir not current working dir since </span>
			<span class="c1"># we don&#39;t want descriptors to be loaded differently depending on where the </span>
			<span class="c1"># tests are run from (i.e. should be independent of cwd). </span>
			<span class="c1"># see also console_make.py which needs similar logic</span>
			<span class="n">dirconfigs</span> <span class="o">=</span> <span class="p">{}</span>

			<span class="c1"># load any descriptors between the project dir up to (but not including) the dir we&#39;ll be walking</span>
			<span class="n">searchdirsuffix</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">projectroot</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">projectroot</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
			<span class="n">currentconfig</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">searchdirsuffix</span><span class="p">)):</span> <span class="c1"># up to but not including dir</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">currentdir</span> <span class="o">=</span> <span class="n">projectroot</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">currentdir</span> <span class="o">=</span> <span class="n">projectroot</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">searchdirsuffix</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
				
				<span class="k">if</span> <span class="n">pathexists</span><span class="p">(</span><span class="n">currentdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">DIR_CONFIG_DESCRIPTOR</span><span class="p">):</span>
					<span class="n">currentconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseTestDescriptor</span><span class="p">(</span><span class="n">currentdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">DIR_CONFIG_DESCRIPTOR</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">currentconfig</span><span class="p">,</span> <span class="n">isDirConfig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loaded directory configuration descriptor from </span><span class="si">%s</span><span class="s1">: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">currentdir</span><span class="p">,</span> <span class="n">currentconfig</span><span class="p">)</span>
			<span class="c1"># this is the top-level directory that will be checked below</span>
			<span class="n">dirconfigs</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="nb">dir</span><span class="p">)]</span> <span class="o">=</span> <span class="n">currentconfig</span>

		<span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">toLongPathSafe</span><span class="p">(</span><span class="nb">dir</span><span class="p">)):</span>
			<span class="n">ignorematch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;.pysysignore&#39;</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;pysysignore&#39;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">ignorematch</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping directory </span><span class="si">%s</span><span class="s1"> due to ignore file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">ignorematch</span><span class="p">)</span>
				<span class="k">del</span> <span class="n">dirs</span><span class="p">[:]</span>
				<span class="k">continue</span>
				
			<span class="n">parentconfig</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">dirconfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">parentconfig</span> <span class="o">=</span> <span class="n">dirconfigs</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root</span><span class="p">)]</span>
				<span class="k">if</span> <span class="nb">next</span><span class="p">(</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">DIR_CONFIG_DESCRIPTOR</span><span class="p">)),</span> <span class="kc">None</span><span class="p">):</span>
					<span class="n">parentconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseTestDescriptor</span><span class="p">(</span><span class="n">root</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">DIR_CONFIG_DESCRIPTOR</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentconfig</span><span class="p">,</span> <span class="n">isDirConfig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loaded directory configuration descriptor from </span><span class="si">%s</span><span class="s1">: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">parentconfig</span><span class="p">)</span>

			<span class="c1"># allow subclasses to modify descriptors list and/or avoid processing </span>
			<span class="c1"># subdirectories</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleSubDirectory</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentconfig</span><span class="p">):</span>
				<span class="k">del</span> <span class="n">dirs</span><span class="p">[:]</span>
				<span class="k">continue</span>

			<span class="k">if</span> <span class="n">descriptorSet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
				<span class="n">intersection</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pysystest.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.bak&#39;</span><span class="p">))]</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># compatibility mode</span>
				<span class="n">intersection</span> <span class="o">=</span> <span class="n">descriptorSet</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">intersection</span><span class="p">:</span> 
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only one test should be present per directory but found </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">intersection</span><span class="p">,</span> <span class="n">root</span><span class="p">))</span>
				<span class="n">descriptorfile</span> <span class="o">=</span> <span class="n">fromLongPathSafe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">intersection</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>

				<span class="k">try</span><span class="p">:</span>
					<span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseTestDescriptor</span><span class="p">(</span><span class="n">descriptorfile</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentconfig</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">parsed</span><span class="p">:</span>
						<span class="n">descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
				<span class="k">except</span> <span class="n">UserError</span><span class="p">:</span>
					<span class="k">raise</span> <span class="c1"># no stack trace needed, will already include descriptorfile name</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed to read descriptor: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error reading descriptor from &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">descriptorfile</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

				<span class="c1"># if this is a test dir, it never makes sense to look at sub directories</span>
				<span class="k">del</span> <span class="n">dirs</span><span class="p">[:]</span>
				<span class="k">continue</span>
			
			<span class="k">for</span> <span class="n">ignore</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ignoreSet</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">)):</span> <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">dirconfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
				<span class="c1"># stash it for when we navigate down to subdirectories</span>
				<span class="c1"># only add to dict if we&#39;re continuing to process children</span>
				<span class="n">dirconfigs</span><span class="p">[</span><span class="n">root</span><span class="p">]</span> <span class="o">=</span> <span class="n">parentconfig</span> 

		<span class="k">return</span> <span class="n">descriptors</span></div>
		
<div class="viewcode-block" id="DescriptorLoader._handleSubDirectory"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.DescriptorLoader._handleSubDirectory">[docs]</a>	<span class="k">def</span> <span class="nf">_handleSubDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Overrides the handling of each sub-directory found while walking </span>
<span class="sd">		the directory tree during `loadDescriptors`. </span>
<span class="sd">		</span>
<span class="sd">		Can be used to add test descriptors, and/or add custom logic for </span>
<span class="sd">		preventing PySys searching a particular part of the directory tree </span>
<span class="sd">		perhaps based on the presence of specific files or subdirectories </span>
<span class="sd">		within it. </span>

<span class="sd">		This method is called before directories containing pysysignore </span>
<span class="sd">		files are stripped out. </span>
<span class="sd">		</span>
<span class="sd">		:param str dir: The full path of the directory to be processed.</span>
<span class="sd">			On Windows, this will be a long-path safe unicode string. </span>
<span class="sd">		:param list[str] subdirs: a list of the subdirectories under dir, which </span>
<span class="sd">			can be used to detect what kind of directory this is, and also can be modified by this method to prevent </span>
<span class="sd">			other loaders looking at subdirectories. </span>
<span class="sd">		:param list[str] files: a list of the files under dir, which </span>
<span class="sd">			can be used to detect what kind of directory this is, and also can be modified by this method to prevent </span>
<span class="sd">			other loaders looking at them. </span>
<span class="sd">		:param list[TestDescriptor] descriptors: A list of `TestDescriptor` items which this method </span>
<span class="sd">			can add to if desired. </span>
<span class="sd">		:param TestDescriptor parentDirDefaults: A `TestDescriptor` containing defaults </span>
<span class="sd">			from the parent directory, or None if there are none. Test loaders may </span>
<span class="sd">			optionally merge some of this information with test-specific </span>
<span class="sd">			information when creating test descriptors. </span>
<span class="sd">		:param dict kwargs: Reserved for future use. Pass this to the base class </span>
<span class="sd">			implementation when calling it. </span>
<span class="sd">		:return: If True, this part of the directory tree has been fully </span>
<span class="sd">			handled and PySys will not search under it any more. False to allow </span>
<span class="sd">			normal PySys handling of the directory to proceed. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;reserved for future use: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		
		<span class="c1"># default implementation just delegates to any plugins</span>
		<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptorLoaderPlugins</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">addDescriptorsFromDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">subdirs</span><span class="o">=</span><span class="n">subdirs</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentDirDefaults</span><span class="p">,</span> <span class="n">descriptors</span><span class="o">=</span><span class="n">descriptors</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
				<span class="k">return</span> <span class="kc">True</span>
		
		<span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DescriptorLoader._parseTestDescriptor"><a class="viewcode-back" href="../../../autodocgen/pysys.config.descriptor.html#pysys.config.descriptor.DescriptorLoader._parseTestDescriptor">[docs]</a>	<span class="k">def</span> <span class="nf">_parseTestDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptorfile</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isDirConfig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Parses a single descriptor file (typically an XML file, or a file of another type containing XML) for a </span>
<span class="sd">		testcase or directory configuration and returns the resulting descriptor. </span>
<span class="sd">		</span>
<span class="sd">		:param descriptorfile: The absolute path of the descriptor file. </span>
<span class="sd">		:param parentDirDefaults: A L{TestDescriptor} instance containing </span>
<span class="sd">			defaults to inherit from the parent directory, or None if none was found. </span>
<span class="sd">		:param isDirConfig: False for normal test descriptors, True for a directory configuration. </span>
<span class="sd">		:return: The L{TestDescriptor} instance, or None if none should be </span>
<span class="sd">			added for this descriptor file. Note that subclasses may modify the </span>
<span class="sd">			contents of the returned instance. </span>
<span class="sd">		:raises UserError: If the descriptor is invalid and an error should be </span>
<span class="sd">			displayed to the user without any Python stacktrace. </span>
<span class="sd">			The exception message must contain the path of the descriptorfile.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;reserved for future use: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">_XMLDescriptorParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">descriptorfile</span><span class="p">,</span> <span class="n">parentDirDefaults</span><span class="o">=</span><span class="n">parentDirDefaults</span><span class="p">,</span> <span class="n">istest</span><span class="o">=</span><span class="ow">not</span> <span class="n">isDirConfig</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2006-2021 M.B. Grieve; documentation last updated on 2021-08-22

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>